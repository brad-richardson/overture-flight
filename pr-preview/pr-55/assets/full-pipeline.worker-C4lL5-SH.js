(function(){"use strict";var M=Uint8Array,A=Uint16Array,ht=Int32Array,_e=new M([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),be=new M([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ct=new M([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ce=function(r,e){for(var t=new A(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var n=new ht(t[30]),i=1;i<30;++i)for(var s=t[i];s<t[i+1];++s)n[s]=s-t[i]<<5|i;return{b:t,r:n}},Ve=Ce(_e,2),Le=Ve.b,ut=Ve.r;Le[28]=258,ut[258]=28;for(var ft=Ce(be,0),dt=ft.b,le=new A(32768),w=0;w<32768;++w){var D=(w&43690)>>1|(w&21845)<<1;D=(D&52428)>>2|(D&13107)<<2,D=(D&61680)>>4|(D&3855)<<4,le[w]=((D&65280)>>8|(D&255)<<8)>>1}for(var Z=(function(r,e,t){for(var i=r.length,n=0,s=new A(e);n<i;++n)r[n]&&++s[r[n]-1];var o=new A(e);for(n=1;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new A(1<<e);var h=15-e;for(n=0;n<i;++n)if(r[n])for(var l=n<<4|r[n],f=e-r[n],c=o[r[n]-1]++<<f,u=c|(1<<f)-1;c<=u;++c)a[le[c]>>h]=l}else for(a=new A(i),n=0;n<i;++n)r[n]&&(a[n]=le[o[r[n]-1]++]>>15-r[n]);return a}),K=new M(288),w=0;w<144;++w)K[w]=8;for(var w=144;w<256;++w)K[w]=9;for(var w=256;w<280;++w)K[w]=7;for(var w=280;w<288;++w)K[w]=8;for(var ke=new M(32),w=0;w<32;++w)ke[w]=5;var pt=Z(K,9,1),yt=Z(ke,5,1),he=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},_=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},ce=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},gt=function(r){return(r+7)/8|0},wt=function(r,e,t){return(t==null||t>r.length)&&(t=r.length),new M(r.subarray(e,t))},xt=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(r,e,t){var i=new Error(e||xt[r]);if(i.code=r,Error.captureStackTrace&&Error.captureStackTrace(i,T),!t)throw i;return i},ue=function(r,e,t,i){var n=r.length,s=0;if(!n||e.f&&!e.l)return t||new M(0);var o=!t,a=o||e.i!=2,h=e.i;o&&(t=new M(n*3));var l=function(ot){var at=t.length;if(ot>at){var lt=new M(Math.max(at*2,ot));lt.set(t),t=lt}},f=e.f||0,c=e.p||0,u=e.b||0,g=e.l,P=e.d,x=e.m,k=e.n,d=n*8;do{if(!g){f=_(r,c,1);var y=_(r,c+1,3);if(c+=3,y)if(y==1)g=pt,P=yt,x=9,k=5;else if(y==2){var C=_(r,c,31)+257,J=_(r,c+10,15)+4,Xe=C+_(r,c+5,31)+1;c+=14;for(var Y=new M(Xe),Me=new M(19),E=0;E<J;++E)Me[ct[E]]=_(r,c+E*3,7);c+=J*3;for(var et=he(Me),Mr=(1<<et)-1,Tr=Z(Me,et,1),E=0;E<Xe;){var tt=Tr[_(r,c,Mr)];c+=tt&15;var v=tt>>4;if(v<16)Y[E++]=v;else{var $=0,ae=0;for(v==16?(ae=3+_(r,c,3),c+=2,$=Y[E-1]):v==17?(ae=3+_(r,c,7),c+=3):v==18&&(ae=11+_(r,c,127),c+=7);ae--;)Y[E++]=$}}var rt=Y.subarray(0,C),R=Y.subarray(C);x=he(rt),k=he(R),g=Z(rt,x,1),P=Z(R,k,1)}else T(1);else{var v=gt(c)+4,b=r[v-4]|r[v-3]<<8,I=v+b;if(I>n){h&&T(0);break}a&&l(u+b),t.set(r.subarray(v,I),u),e.b=u+=b,e.p=c=I*8,e.f=f;continue}if(c>d){h&&T(0);break}}a&&l(u+131072);for(var Sr=(1<<x)-1,Er=(1<<k)-1,Te=c;;Te=c){var $=g[ce(r,c)&Sr],W=$>>4;if(c+=$&15,c>d){h&&T(0);break}if($||T(2),W<256)t[u++]=W;else if(W==256){Te=c,g=null;break}else{var it=W-254;if(W>264){var E=W-257,Q=_e[E];it=_(r,c,(1<<Q)-1)+Le[E],c+=Q}var Se=P[ce(r,c)&Er],Ee=Se>>4;Se||T(3),c+=Se&15;var R=dt[Ee];if(Ee>3){var Q=be[Ee];R+=ce(r,c)&(1<<Q)-1,c+=Q}if(c>d){h&&T(0);break}a&&l(u+131072);var nt=u+it;if(u<R){var st=s-R,_r=Math.min(R,nt);for(st+u<0&&T(3);u<_r;++u)t[u]=i[st+u]}for(;u<nt;++u)t[u]=t[u-R]}}e.l=g,e.p=Te,e.b=u,e.f=f,g&&(f=1,e.m=x,e.d=P,e.n=k)}while(!f);return u!=t.length&&o?wt(t,0,u):t.subarray(0,u)},mt=new M(0),vt=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&T(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var i=(e>>3&1)+(e>>4&1);i>0;i-=!r[t++]);return t+(e&2)},Ft=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},Pt=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&T(6,"invalid zlib data"),(r[1]>>5&1)==1&&T(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function Mt(r,e){return ue(r,{i:2},e,e)}function Tt(r,e){var t=vt(r);return t+8>r.length&&T(6,"invalid gzip data"),ue(r.subarray(t,-8),{i:2},new M(Ft(r)),e)}function St(r,e){return ue(r.subarray(Pt(r),-4),{i:2},e,e)}function Et(r,e){return r[0]==31&&r[1]==139&&r[2]==8?Tt(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?Mt(r,e):St(r,e)}var _t=typeof TextDecoder<"u"&&new TextDecoder,bt=0;try{_t.decode(mt,{stream:!0}),bt=1}catch{}var Ct=Object.defineProperty,Vt=Math.pow,p=(r,e)=>Ct(r,"name",{value:e,configurable:!0}),F=(r,e,t)=>new Promise((i,n)=>{var s=h=>{try{a(t.next(h))}catch(l){n(l)}},o=h=>{try{a(t.throw(h))}catch(l){n(l)}},a=h=>h.done?i(h.value):Promise.resolve(h.value).then(s,o);a((t=t.apply(r,e)).next())});p((r,e)=>{let t=!1,i="",n=L.GridLayer.extend({createTile:p((s,o)=>{let a=document.createElement("img"),h=new AbortController,l=h.signal;return a.cancel=()=>{h.abort()},t||(r.getHeader().then(f=>{f.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):f.tileType===2?i="image/png":f.tileType===3?i="image/jpeg":f.tileType===4?i="image/webp":f.tileType===5&&(i="image/avif")}),t=!0),r.getZxy(s.z,s.x,s.y,l).then(f=>{if(f){let c=new Blob([f.data],{type:i}),u=window.URL.createObjectURL(c);a.src=u}else a.style.display="none";a.cancel=void 0,o(void 0,a)}).catch(f=>{if(f.name!=="AbortError")throw f}),a},"createTile"),_removeTile:p(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new n(e)},"leafletRasterLayer");var Lt=p(r=>(e,t)=>{if(t instanceof AbortController)return r(e,t);let i=new AbortController;return r(e,i).then(n=>t(void 0,n.data,n.cacheControl||"",n.expires||""),n=>t(n)).catch(n=>t(n)),{cancel:p(()=>i.abort(),"cancel")}},"v3compat"),kt=class{constructor(e){this.tilev4=p((t,i)=>F(this,null,function*(){if(t.type==="json"){let g=t.url.substr(10),P=this.tiles.get(g);if(P||(P=new ee(g),this.tiles.set(g,P)),this.metadata){let k=yield P.getTileJson(t.url);return i.signal.throwIfAborted(),{data:k}}let x=yield P.getHeader();return i.signal.throwIfAborted(),(x.minLon>=x.maxLon||x.minLat>=x.maxLat)&&console.error(`Bounds of PMTiles archive ${x.minLon},${x.minLat},${x.maxLon},${x.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:x.minZoom,maxzoom:x.maxZoom,bounds:[x.minLon,x.minLat,x.maxLon,x.maxLat]}}}let n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(n);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new ee(o),this.tiles.set(o,a));let h=s[2],l=s[3],f=s[4],c=yield a.getHeader(),u=yield a==null?void 0:a.getZxy(+h,+l,+f,i.signal);if(i.signal.throwIfAborted(),u)return{data:new Uint8Array(u.data),cacheControl:u.cacheControl,expires:u.expires};if(c.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=Lt(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};p(kt,"Protocol");function De(r,e){return(e>>>0)*4294967296+(r>>>0)}p(De,"toNum");function Ue(r,e){let t=e.buf,i=t[e.pos++],n=(i&112)>>4;if(i<128||(i=t[e.pos++],n|=(i&127)<<3,i<128)||(i=t[e.pos++],n|=(i&127)<<10,i<128)||(i=t[e.pos++],n|=(i&127)<<17,i<128)||(i=t[e.pos++],n|=(i&127)<<24,i<128)||(i=t[e.pos++],n|=(i&1)<<31,i<128))return De(r,n);throw new Error("Expected varint not more than 10 bytes")}p(Ue,"readVarintRemainder");function O(r){let e=r.buf,t=e[r.pos++],i=t&127;return t<128||(t=e[r.pos++],i|=(t&127)<<7,t<128)||(t=e[r.pos++],i|=(t&127)<<14,t<128)||(t=e[r.pos++],i|=(t&127)<<21,t<128)?i:(t=e[r.pos],i|=(t&15)<<28,Ue(i,r))}p(O,"readVarint");function fe(r,e,t,i,n){return n===0?i!==0?[r-1-t,r-1-e]:[t,e]:[e,t]}p(fe,"rotate");function Be(r,e,t){if(r>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>=1<<r||t>=1<<r)throw new Error("tile x/y outside zoom level bounds");let i=((1<<r)*(1<<r)-1)/3,n=r-1,[s,o]=[e,t];for(let a=1<<n;a>0;a>>=1){let h=s&a,l=o&a;i+=(3*h^l)*(1<<n),[s,o]=fe(a,s,o,h,l),n--}return i}p(Be,"zxyToTileId");function Ie(r){let e=3*r+1;return e<4294967296?31-Math.clz32(e):63-Math.clz32(e/4294967296)}p(Ie,"tileIdToZ");function Dt(r){let e=Ie(r)>>1;if(e>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");let t=((1<<e)*(1<<e)-1)/3,i=r-t,n=0,s=0,o=1<<e;for(let a=1;a<o;a<<=1){let h=a&i/2,l=a&(i^h);[n,s]=fe(a,n,s,h,l),i=i/2,n+=h,s+=l}return[e,n,s]}p(Dt,"tileIdToZxy");var Ut=(r=>(r[r.Unknown=0]="Unknown",r[r.None=1]="None",r[r.Gzip=2]="Gzip",r[r.Brotli=3]="Brotli",r[r.Zstd=4]="Zstd",r))(Ut||{});function X(r,e){return F(this,null,function*(){if(e===1||e===0)return r;if(e===2){if(typeof globalThis.DecompressionStream>"u")return Et(new Uint8Array(r));let t=new Response(r).body;if(!t)throw new Error("Failed to read response stream");let i=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(i).arrayBuffer()}throw new Error("Compression method not supported")})}p(X,"defaultDecompress");var Bt=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(Bt||{});function Re(r){return r===1?".mvt":r===2?".png":r===3?".jpg":r===4?".webp":r===5?".avif":""}p(Re,"tileTypeExt");var It=127;function Ae(r,e){let t=0,i=r.length-1;for(;t<=i;){let n=i+t>>1,s=e-r[n].tileId;if(s>0)t=n+1;else if(s<0)i=n-1;else return r[n]}return i>=0&&(r[i].runLength===0||e-r[i].tileId<r[i].runLength)?r[i]:null}p(Ae,"findTile");var Rt=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return F(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};p(Rt,"FileSource");var Oe=class{constructor(e,t=new Headers){var i,n;this.url=e,this.customHeaders=t,this.mustReload=!1;let s="";"navigator"in globalThis&&(s=(n=(i=globalThis.navigator)==null?void 0:i.userAgent)!=null?n:"");let o=s.indexOf("Windows")>-1,a=/Chrome|Chromium|Edg|OPR|Brave/.test(s);this.chromeWindowsNoCache=!1,o&&a&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,i,n){return F(this,null,function*(){let s,o;i?o=i:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let h;this.mustReload?h="reload":this.chromeWindowsNoCache&&(h="no-store");let l=yield fetch(this.url,{signal:o,cache:h,headers:a});if(e===0&&l.status===416){let u=l.headers.get("Content-Range");if(!u||!u.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let g=+u.substr(8);l=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${g-1}`}})}let f=l.headers.get("Etag");if(f!=null&&f.startsWith("W/")&&(f=null),l.status===416||n&&f&&f!==n)throw this.mustReload=!0,new pe(`Server returned non-matching ETag ${n} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(l.status>=300)throw new Error(`Bad response code: ${l.status}`);let c=l.headers.get("Content-Length");if(l.status===200&&(!c||+c>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield l.arrayBuffer(),etag:f||void 0,cacheControl:l.headers.get("Cache-Control")||void 0,expires:l.headers.get("Expires")||void 0}})}};p(Oe,"FetchSource");var At=Oe;function S(r,e){let t=r.getUint32(e+4,!0),i=r.getUint32(e+0,!0);return t*Vt(2,32)+i}p(S,"getUint64");function ze(r,e){let t=new DataView(r),i=t.getUint8(7);if(i>3)throw new Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:S(t,8),rootDirectoryLength:S(t,16),jsonMetadataOffset:S(t,24),jsonMetadataLength:S(t,32),leafDirectoryOffset:S(t,40),leafDirectoryLength:S(t,48),tileDataOffset:S(t,56),tileDataLength:S(t,64),numAddressedTiles:S(t,72),numTileEntries:S(t,80),numTileContents:S(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}p(ze,"bytesToHeader");function de(r){let e={buf:new Uint8Array(r),pos:0},t=O(e),i=[],n=0;for(let s=0;s<t;s++){let o=O(e);i.push({tileId:n+o,offset:0,length:0,runLength:1}),n+=o}for(let s=0;s<t;s++)i[s].runLength=O(e);for(let s=0;s<t;s++)i[s].length=O(e);for(let s=0;s<t;s++){let o=O(e);o===0&&s>0?i[s].offset=i[s-1].offset+i[s-1].length:i[s].offset=o-1}return i}p(de,"deserializeIndex");var He=class extends Error{};p(He,"EtagMismatch");var pe=He;function ye(r,e){return F(this,null,function*(){let t=yield r.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let i=t.data.slice(0,It),n=ze(i,t.etag),s=t.data.slice(n.rootDirectoryOffset,n.rootDirectoryOffset+n.rootDirectoryLength),o=`${r.getKey()}|${n.etag||""}|${n.rootDirectoryOffset}|${n.rootDirectoryLength}`,a=de(yield e(s,n.internalCompression));return[n,[o,a.length,a]]})}p(ye,"getHeaderAndRoot");function ge(r,e,t,i,n){return F(this,null,function*(){let s=yield r.getBytes(t,i,void 0,n.etag),o=yield e(s.data,n.internalCompression),a=de(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}p(ge,"getDirectory");var Ot=class{constructor(e=100,t=!0,i=X){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=i}getHeader(e){return F(this,null,function*(){let t=e.getKey(),i=this.cache.get(t);if(i)return i.lastUsed=this.counter++,i.data;let n=yield ye(e,this.decompress);return n[1]&&this.cache.set(n[1][0],{lastUsed:this.counter++,data:n[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:n[0]}),this.prune(),n[0]})}getDirectory(e,t,i,n){return F(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${i}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield ge(e,this.decompress,t,i,n);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((i,n)=>{i.lastUsed<e&&(e=i.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return F(this,null,function*(){this.cache.delete(e.getKey())})}};p(Ot,"ResolvedValueCache");var Ne=class{constructor(e=100,t=!0,i=X){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=i}getHeader(e){return F(this,null,function*(){let t=e.getKey(),i=this.cache.get(t);if(i)return i.lastUsed=this.counter++,yield i.data;let n=new Promise((s,o)=>{ye(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:n}),n})}getDirectory(e,t,i,n){return F(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${i}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((h,l)=>{ge(e,this.decompress,t,i,n).then(f=>{h(f),this.prune()}).catch(f=>{l(f)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((i,n)=>{i.lastUsed<e&&(e=i.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return F(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let i=new Promise((n,s)=>{this.getHeader(e).then(o=>{n(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,i)})}};p(Ne,"SharedPromiseCache");var zt=Ne,$e=class{constructor(e,t,i){typeof e=="string"?this.source=new At(e):this.source=e,i?this.decompress=i:this.decompress=X,t?this.cache=t:this.cache=new zt}getHeader(){return F(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,i,n){return F(this,null,function*(){let s=Be(e,t,i),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,h=o.rootDirectoryLength;for(let l=0;l<=3;l++){let f=yield this.cache.getDirectory(this.source,a,h,o),c=Ae(f,s);if(c){if(c.runLength>0){let u=yield this.source.getBytes(o.tileDataOffset+c.offset,c.length,n,o.etag);return{data:yield this.decompress(u.data,o.tileCompression),cacheControl:u.cacheControl,expires:u.expires}}a=o.leafDirectoryOffset+c.offset,h=c.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,i,n){return F(this,null,function*(){try{return yield this.getZxyAttempt(e,t,i,n)}catch(s){if(s instanceof pe)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,i,n);throw s}})}getMetadataAttempt(){return F(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),i=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(i))})}getMetadata(){return F(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof pe)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return F(this,null,function*(){let t=yield this.getHeader(),i=yield this.getMetadata(),n=Re(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${n}`],vector_layers:i.vector_layers,attribution:i.attribution,description:i.description,name:i.name,version:i.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};p($e,"PMTiles");var ee=$e;function U(r,e){this.x=r,this.y=e}U.prototype={clone(){return new U(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const e=r.x-this.x,t=r.y-this.y;return e*e+t*t},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){const e=r[0]*this.x+r[1]*this.y,t=r[2]*this.x+r[3]*this.y;return this.x=e,this.y=t,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const e=Math.cos(r),t=Math.sin(r),i=e*this.x-t*this.y,n=t*this.x+e*this.y;return this.x=i,this.y=n,this},_rotateAround(r,e){const t=Math.cos(r),i=Math.sin(r),n=e.x+t*(this.x-e.x)-i*(this.y-e.y),s=e.y+i*(this.x-e.x)+t*(this.y-e.y);return this.x=n,this.y=s,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:U},U.convert=function(r){if(r instanceof U)return r;if(Array.isArray(r))return new U(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new U(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};class We{constructor(e,t,i,n,s){this.properties={},this.extent=i,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=n,this._values=s,e.readFields(Ht,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,i=[];let n,s=1,o=0,a=0,h=0;for(;e.pos<t;){if(o<=0){const l=e.readVarint();s=l&7,o=l>>3}if(o--,s===1||s===2)a+=e.readSVarint(),h+=e.readSVarint(),s===1&&(n&&i.push(n),n=[]),n&&n.push(new U(a,h));else if(s===7)n&&n.push(n[0].clone());else throw new Error(`unknown command ${s}`)}return n&&i.push(n),i}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let i=1,n=0,s=0,o=0,a=1/0,h=-1/0,l=1/0,f=-1/0;for(;e.pos<t;){if(n<=0){const c=e.readVarint();i=c&7,n=c>>3}if(n--,i===1||i===2)s+=e.readSVarint(),o+=e.readSVarint(),s<a&&(a=s),s>h&&(h=s),o<l&&(l=o),o>f&&(f=o);else if(i!==7)throw new Error(`unknown command ${i}`)}return[a,l,h,f]}toGeoJSON(e,t,i){const n=this.extent*Math.pow(2,i),s=this.extent*e,o=this.extent*t,a=this.loadGeometry();function h(u){return[(u.x+s)*360/n-180,360/Math.PI*Math.atan(Math.exp((1-(u.y+o)*2/n)*Math.PI))-90]}function l(u){return u.map(h)}let f;if(this.type===1){const u=[];for(const P of a)u.push(P[0]);const g=l(u);f=u.length===1?{type:"Point",coordinates:g[0]}:{type:"MultiPoint",coordinates:g}}else if(this.type===2){const u=a.map(l);f=u.length===1?{type:"LineString",coordinates:u[0]}:{type:"MultiLineString",coordinates:u}}else if(this.type===3){const u=$t(a),g=[];for(const P of u)g.push(P.map(l));f=g.length===1?{type:"Polygon",coordinates:g[0]}:{type:"MultiPolygon",coordinates:g}}else throw new Error("unknown feature type");const c={type:"Feature",geometry:f,properties:this.properties};return this.id!=null&&(c.id=this.id),c}}We.types=["Unknown","Point","LineString","Polygon"];function Ht(r,e,t){r===1?e.id=t.readVarint():r===2?Nt(t,e):r===3?e.type=t.readVarint():r===4&&(e._geometry=t.pos)}function Nt(r,e){const t=r.readVarint()+r.pos;for(;r.pos<t;){const i=e._keys[r.readVarint()],n=e._values[r.readVarint()];e.properties[i]=n}}function $t(r){const e=r.length;if(e<=1)return[r];const t=[];let i,n;for(let s=0;s<e;s++){const o=Wt(r[s]);o!==0&&(n===void 0&&(n=o<0),n===o<0?(i&&t.push(i),i=[r[s]]):i&&i.push(r[s]))}return i&&t.push(i),t}function Wt(r){let e=0;for(let t=0,i=r.length,n=i-1,s,o;t<i;n=t++)s=r[t],o=r[n],e+=(o.x-s.x)*(s.y+o.y);return e}class Zt{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Kt,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new We(this._pbf,t,this.extent,this._keys,this._values)}}function Kt(r,e,t){r===15?e.version=t.readVarint():r===1?e.name=t.readString():r===5?e.extent=t.readVarint():r===2?e._features.push(t.pos):r===3?e._keys.push(t.readString()):r===4&&e._values.push(jt(t))}function jt(r){let e=null;const t=r.readVarint()+r.pos;for(;r.pos<t;){const i=r.readVarint()>>3;e=i===1?r.readString():i===2?r.readFloat():i===3?r.readDouble():i===4?r.readVarint64():i===5?r.readVarint():i===6?r.readSVarint():i===7?r.readBoolean():null}if(e==null)throw new Error("unknown feature value");return e}class qt{constructor(e,t){this.layers=e.readFields(Gt,{},t)}}function Gt(r,e,t){if(r===3){const i=new Zt(t,t.readVarint()+t.pos);i.length&&(e[i.name]=i)}}const we=65536*65536,Ze=1/we,Jt=12,Ke=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),xe=0,te=1,j=2,re=5;class Yt{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,i=this.length){for(;this.pos<i;){const n=this.readVarint(),s=n>>3,o=this.pos;this.type=n&7,e(s,t,this),this.pos===o&&this.skip(n)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*we;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*we;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let i,n;return n=t[this.pos++],i=n&127,n<128||(n=t[this.pos++],i|=(n&127)<<7,n<128)||(n=t[this.pos++],i|=(n&127)<<14,n<128)||(n=t[this.pos++],i|=(n&127)<<21,n<128)?i:(n=t[this.pos],i|=(n&15)<<28,Qt(i,e,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2===1?(e+1)/-2:e/2}readBoolean(){return!!this.readVarint()}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=Jt&&Ke?Ke.decode(this.buf.subarray(t,e)):ur(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const i=this.readPackedEnd();for(;this.pos<i;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return this.type===j?this.readVarint()+this.pos:this.pos+1}skip(e){const t=e&7;if(t===xe)for(;this.buf[this.pos++]>127;);else if(t===j)this.pos=this.readVarint()+this.pos;else if(t===re)this.pos+=4;else if(t===te)this.pos+=8;else throw new Error(`Unimplemented type: ${t}`)}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Ze),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Ze),!0),this.pos+=8}writeVarint(e){if(e=+e||0,e>268435455||e<0){Xt(e,this);return}this.realloc(4),this.buf[this.pos++]=e&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=e>>>7&127)))}writeSVarint(e){this.writeVarint(e<0?-e*2-1:e*2)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(e.length*4),this.pos++;const t=this.pos;this.pos=fr(this.buf,e,this.pos);const i=this.pos-t;i>=128&&je(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let i=0;i<t;i++)this.buf[this.pos++]=e[i]}writeRawMessage(e,t){this.pos++;const i=this.pos;e(t,this);const n=this.pos-i;n>=128&&je(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n}writeMessage(e,t,i){this.writeTag(e,j),this.writeRawMessage(t,i)}writePackedVarint(e,t){t.length&&this.writeMessage(e,rr,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,ir,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,or,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,nr,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,sr,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,ar,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,lr,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,hr,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,cr,t)}writeBytesField(e,t){this.writeTag(e,j),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,re),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,re),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,te),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,te),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,xe),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,xe),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,j),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,re),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,te),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function Qt(r,e,t){const i=t.buf;let n,s;if(s=i[t.pos++],n=(s&112)>>4,s<128||(s=i[t.pos++],n|=(s&127)<<3,s<128)||(s=i[t.pos++],n|=(s&127)<<10,s<128)||(s=i[t.pos++],n|=(s&127)<<17,s<128)||(s=i[t.pos++],n|=(s&127)<<24,s<128)||(s=i[t.pos++],n|=(s&1)<<31,s<128))return z(r,n,e);throw new Error("Expected varint not more than 10 bytes")}function z(r,e,t){return t?e*4294967296+(r>>>0):(e>>>0)*4294967296+(r>>>0)}function Xt(r,e){let t,i;if(r>=0?(t=r%4294967296|0,i=r/4294967296|0):(t=~(-r%4294967296),i=~(-r/4294967296),t^4294967295?t=t+1|0:(t=0,i=i+1|0)),r>=18446744073709552e3||r<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),er(t,i,e),tr(i,e)}function er(r,e,t){t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos]=r&127}function tr(r,e){const t=(r&7)<<4;e.buf[e.pos++]|=t|((r>>>=3)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127)))))}function je(r,e,t){const i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));t.realloc(i);for(let n=t.pos-1;n>=r;n--)t.buf[n+i]=t.buf[n]}function rr(r,e){for(let t=0;t<r.length;t++)e.writeVarint(r[t])}function ir(r,e){for(let t=0;t<r.length;t++)e.writeSVarint(r[t])}function nr(r,e){for(let t=0;t<r.length;t++)e.writeFloat(r[t])}function sr(r,e){for(let t=0;t<r.length;t++)e.writeDouble(r[t])}function or(r,e){for(let t=0;t<r.length;t++)e.writeBoolean(r[t])}function ar(r,e){for(let t=0;t<r.length;t++)e.writeFixed32(r[t])}function lr(r,e){for(let t=0;t<r.length;t++)e.writeSFixed32(r[t])}function hr(r,e){for(let t=0;t<r.length;t++)e.writeFixed64(r[t])}function cr(r,e){for(let t=0;t<r.length;t++)e.writeSFixed64(r[t])}function ur(r,e,t){let i="",n=e;for(;n<t;){const s=r[n];let o=null,a=s>239?4:s>223?3:s>191?2:1;if(n+a>t)break;let h,l,f;a===1?s<128&&(o=s):a===2?(h=r[n+1],(h&192)===128&&(o=(s&31)<<6|h&63,o<=127&&(o=null))):a===3?(h=r[n+1],l=r[n+2],(h&192)===128&&(l&192)===128&&(o=(s&15)<<12|(h&63)<<6|l&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):a===4&&(h=r[n+1],l=r[n+2],f=r[n+3],(h&192)===128&&(l&192)===128&&(f&192)===128&&(o=(s&15)<<18|(h&63)<<12|(l&63)<<6|f&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,a=1):o>65535&&(o-=65536,i+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),i+=String.fromCharCode(o),n+=a}return i}function fr(r,e,t){for(let i=0,n,s;i<e.length;i++){if(n=e.charCodeAt(i),n>55295&&n<57344)if(s)if(n<56320){r[t++]=239,r[t++]=191,r[t++]=189,s=n;continue}else n=s-55296<<10|n-56320|65536,s=null;else{n>56319||i+1===e.length?(r[t++]=239,r[t++]=191,r[t++]=189):s=n;continue}else s&&(r[t++]=239,r[t++]=191,r[t++]=189,s=null);n<128?r[t++]=n:(n<2048?r[t++]=n>>6|192:(n<65536?r[t++]=n>>12|224:(r[t++]=n>>18|240,r[t++]=n>>12&63|128),r[t++]=n>>6&63|128),r[t++]=n&63|128)}return t}const m={ocean:1990538,sea:1990538,lake:2783920,reservoir:2783920,pond:3377339,river:2783920,stream:3377339,canal:2783920,water:1990538,bathymetry:1990538,forest:1723694,wood:1987888,grass:5934922,shrub:3832376,crop:9414744,barren:10518624,wetland:3827784,swamp:3827784,mangrove:2773056,moss:6982224,snow:15266040,urban:6974058,park:4882512,meadow:5934922,farmland:9414744,residential:7368816,commercial:7895160,industrial:6316128,land:9414784,default:9414784},me={motorway:{color:11051152,width:3},trunk:{color:10130568,width:2.5},primary:{color:9209984,width:2},secondary:{color:8288884,width:1.5},tertiary:{color:7367784,width:1.2},residential:{color:6710886,width:.8},unclassified:{color:5592405,width:.6},service:{color:4473924,width:.4},living_street:{color:5592405,width:.6},pedestrian:{color:8947848,width:.5},footway:{color:7829367,width:.3},path:{color:6710886,width:.3},cycleway:{color:5933658,width:.4},rail:{color:3355443,width:1},subway:{color:3355443,width:.8},tram:{color:3355443,width:.6},default:{color:5592405,width:.5}},B=[{depth:0,color:{r:74,g:176,b:208}},{depth:200,color:{r:58,g:154,b:192}},{depth:1e3,color:{r:42,g:128,b:176}},{depth:2e3,color:{r:30,g:95,b:138}},{depth:4e3,color:{r:21,g:69,b:112}},{depth:6e3,color:{r:13,g:48,b:85}},{depth:1e4,color:{r:8,g:32,b:64}}],dr=["river","stream","canal","drain","ditch","waterway"],pr=["ocean","sea","bay","strait","gulf","sound","harbour","harbor"],qe={service:0,path:1,footway:2,cycleway:3,pedestrian:4,unclassified:5,living_street:6,residential:7,tertiary:8,secondary:9,primary:10,trunk:11,motorway:12};function V(r){return"#"+r.toString(16).padStart(6,"0")}function yr(r){const e=Math.max(0,Math.min(r,1e4));let t=B[0],i=B[B.length-1];for(let l=0;l<B.length-1;l++)if(e>=B[l].depth&&e<=B[l+1].depth){t=B[l],i=B[l+1];break}const n=i.depth-t.depth,s=n>0?(e-t.depth)/n:0,o=Math.round(t.color.r+s*(i.color.r-t.color.r)),a=Math.round(t.color.g+s*(i.color.g-t.color.g)),h=Math.round(t.color.b+s*(i.color.b-t.color.b));return o<<16|a<<8|h}function ve(r,e){const i=(e.subtype||e.class||e.type||e.category||"").toLowerCase();if(r==="bathymetry"){const n=typeof e.depth=="number"?e.depth:0;return yr(n)}return r==="land_cover"?m[i]??m.grass:m[i]?m[i]:r==="water"?m.water:r==="land"?m.land:r==="land_use"?i.includes("forest")||i.includes("wood")?m.forest:i.includes("park")||i.includes("recreation")?m.park:i.includes("grass")||i.includes("green")||i.includes("meadow")?m.grass:i.includes("farm")||i.includes("orchard")||i.includes("vineyard")?m.crop:i.includes("water")||i.includes("basin")?m.water:i.includes("residential")?m.residential:i.includes("commercial")||i.includes("retail")?m.commercial:i.includes("industrial")?m.industrial:i.includes("cemetery")||i.includes("grave")?m.grass:m.land:m.default}function gr(r){if(!r)return me.default;const t=(r.class||r.road_class||r.highway||"").toLowerCase();return me[t]??me.default}function wr(r,e){const t=r.east-r.west,i=r.north-r.south;return(n,s)=>({x:(n-r.west)/t*e,y:(r.north-s)/i*e})}function Ge(r,e,t){if(!e||e.length===0)return;r.beginPath();const i=e[0];if(!i||i.length===0)return;const n=t(i[0][0],i[0][1]);r.moveTo(n.x,n.y);for(let s=1;s<i.length;s++){const o=t(i[s][0],i[s][1]);r.lineTo(o.x,o.y)}r.closePath();for(let s=1;s<e.length;s++){const o=e[s];if(!o||o.length===0)continue;const a=t(o[0][0],o[0][1]);r.moveTo(a.x,a.y);for(let h=1;h<o.length;h++){const l=t(o[h][0],o[h][1]);r.lineTo(l.x,l.y)}r.closePath()}}function q(r,e,t,i){if(t==="Polygon")Ge(r,e,i);else if(t==="MultiPolygon")for(const n of e)Ge(r,n,i)}function Je(r,e,t){if(!e||e.length<2)return;r.beginPath();const i=t(e[0][0],e[0][1]);r.moveTo(i.x,i.y);for(let n=1;n<e.length;n++){const s=t(e[n][0],e[n][1]);r.lineTo(s.x,s.y)}r.stroke()}function Ye(r,e,t,i){if(t==="LineString")Je(r,e,i);else if(t==="MultiLineString")for(const n of e)Je(r,n,i)}function xr(r,e,t,i){const n=r.width,s=r.getContext("2d");if(!s)return;s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const o=wr(i,n),h=(i.east-i.west)*111320*Math.cos((i.north+i.south)/2*Math.PI/180)/n,l=[],f=[],c=[],u=[],g=[],P=[];for(const d of e){const y=d.layer,v=(d.properties.subtype||d.properties.class||"").toLowerCase();if(y==="land")(d.type==="Polygon"||d.type==="MultiPolygon")&&l.push(d);else if(y==="land_use")f.push(d);else if(y==="land_cover")c.push(d);else if(y==="water"){if(d.type==="LineString"||d.type==="MultiLineString")dr.includes(v)&&u.push(d);else if(d.type==="Polygon"||d.type==="MultiPolygon"){const b=d.properties._fromLowerZoom===!0;pr.includes(v)||b?P.push(d):g.push(d)}}}const x=P.length>0&&l.length<10;if(x?(s.fillStyle=V(m.water),s.fillRect(0,0,n,n)):(s.fillStyle=V(m.land),s.fillRect(0,0,n,n)),x&&l.length>0){s.save(),s.fillStyle=V(m.land);for(const d of l)q(s,d.coordinates,d.type,o),s.fill("evenodd");s.restore()}s.save();for(const d of f){if(d.type!=="Polygon"&&d.type!=="MultiPolygon")continue;const y=ve("land_use",d.properties);s.fillStyle=V(y),q(s,d.coordinates,d.type,o),s.fill("evenodd")}s.restore(),s.save();for(const d of c){if(d.type!=="Polygon"&&d.type!=="MultiPolygon")continue;const y=ve("land_cover",d.properties);s.fillStyle=V(y),q(s,d.coordinates,d.type,o),s.fill("evenodd")}s.restore(),s.save(),s.strokeStyle=V(m.river),s.lineWidth=Math.max(1,3/h),s.lineCap="round",s.lineJoin="round";for(const d of u)Ye(s,d.coordinates,d.type,o);s.restore(),s.save();for(const d of P)s.fillStyle=V(m.water),q(s,d.coordinates,d.type,o),s.fill("evenodd");for(const d of g){const y=ve("water",d.properties);s.fillStyle=V(y),q(s,d.coordinates,d.type,o),s.fill("evenodd")}s.restore();const k=t.filter(d=>{var v;if(d.layer==="connector"||d.layer!=="segment"||d.type!=="LineString"&&d.type!=="MultiLineString"||((v=d.properties)==null?void 0:v.subtype)!=="road")return!1;const y=d.properties;if(typeof y.road_flags=="string")try{if(JSON.parse(y.road_flags).some(C=>{var J;return(J=C.values)==null?void 0:J.includes("is_tunnel")}))return!1}catch{}if(typeof y.level_rules=="string")try{const b=JSON.parse(y.level_rules);if(b.length>0&&b.every(C=>typeof C.value=="number"&&C.value<0))return!1}catch{}return!(y.is_tunnel===!0||y.is_underground===!0||typeof y.level=="number"&&y.level<0)}).sort((d,y)=>{var I,C;const v=(((I=d.properties)==null?void 0:I.class)||"default").toLowerCase(),b=(((C=y.properties)==null?void 0:C.class)||"default").toLowerCase();return(qe[v]??5)-(qe[b]??5)});s.save(),s.lineCap="round",s.lineJoin="round";for(const d of k){const y=gr(d.properties),v=Math.max(1,y.width*5/h);s.strokeStyle=V(y.color),s.lineWidth=v,Ye(s,d.coordinates,d.type,o)}s.restore()}let H=null,G=null,ie=!1,N=null,ne=null,se=null,oe=!1;try{oe=new OffscreenCanvas(1,1).getContext("2d")!==null}catch{oe=!1}async function Qe(r,e){if(!(ie&&ne===r&&se===e)){if(N)if(ne!==r||se!==e)await N,ie=!1;else{await N;return}N=(async()=>{try{ne=r,se=e,H=new ee(r),G=new ee(e),await Promise.all([H.getHeader(),G.getHeader()]),ie=!0}catch(t){throw console.error("[FullPipelineWorker] Failed to initialize PMTiles:",t),H=null,G=null,ne=null,se=null,ie=!1,t}})();try{await N}finally{N=null}}}function mr(r,e,t){const i=Math.PI-2*Math.PI*e/Math.pow(2,t),n=180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i))),s=Math.PI-2*Math.PI*(e+1)/Math.pow(2,t),o=180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s))),a=r/Math.pow(2,t)*360-180,h=(r+1)/Math.pow(2,t)*360-180;return{north:n,south:o,west:a,east:h}}function Fe(r,e,t,i,n=null){const s=new qt(new Yt(r)),o=[],a=Object.keys(s.layers),h=n&&s.layers[n]?[n]:a;for(const l of h){const f=s.layers[l];if(f)for(let c=0;c<f.length;c++){const u=f.feature(c),g=u.toGeoJSON(e,t,i);o.push({type:g.geometry.type,coordinates:g.geometry.coordinates,properties:u.properties,layer:l})}}return o}async function Pe(r,e,t,i){try{const n=await r.getZxy(e,t,i);return(n==null?void 0:n.data)??null}catch(n){return console.warn(`[FullPipelineWorker] Failed to fetch tile ${e}/${t}/${i}:`,n),null}}async function vr(r,e,t,i){if(!H)return[];const n=[],s=await Pe(H,t,r,e);if(s&&n.push(...Fe(s,r,e,t)),i){const o=[];for(let h=-1;h<=1;h++)for(let l=-1;l<=1;l++){if(h===0&&l===0)continue;const f=r+h,c=e+l;o.push(Pe(H,t,f,c).then(u=>u?Fe(u,f,c,t):[]))}const a=await Promise.all(o);for(const h of a)n.push(...h)}return n}async function Fr(r,e,t){if(!G)return[];const i=await Pe(G,t,r,e);return i?Fe(i,r,e,t):[]}async function Pr(r,e,t,i,n,s,o,a){await Qe(n,s);const h=mr(r,e,t),[l,f]=await Promise.all([vr(r,e,t,o),a?Fr(r,e,t):Promise.resolve([])]),c=new OffscreenCanvas(i,i);return xr(c,l,f,h),c.transferToImageBitmap()}self.onmessage=async r=>{const e=r.data;try{switch(e.type){case"CAPABILITY_CHECK":{const t={type:"CAPABILITY_CHECK_RESULT",id:e.id,supported:oe};self.postMessage(t);break}case"INIT_PMTILES":{const{basePMTilesUrl:t,transportationPMTilesUrl:i}=e.payload;await Qe(t,i);const n={type:"CAPABILITY_CHECK_RESULT",id:e.id,supported:!0};self.postMessage(n);break}case"RENDER_FULL_PIPELINE":{if(!oe){const u={type:"ERROR",id:e.id,error:"OffscreenCanvas not supported"};self.postMessage(u);return}const{tileX:t,tileY:i,tileZ:n,textureSize:s,basePMTilesUrl:o,transportationPMTilesUrl:a,includeNeighbors:h,includeTransportation:l}=e.payload,f=await Pr(t,i,n,s,o,a,h,l),c={type:"RENDER_TILE_TEXTURE_RESULT",id:e.id,result:f};self.postMessage(c,{transfer:[f]});break}default:{const t=e,i=typeof t.id=="string"?t.id:"unknown",n=typeof t.type=="string"?t.type:"undefined",s={type:"ERROR",id:i,error:`Unknown request type: ${n}`};self.postMessage(s)}}}catch(t){const i={type:"ERROR",id:e.id,error:t instanceof Error?t.message:"Unknown error in full-pipeline worker"};self.postMessage(i)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=full-pipeline.worker-C4lL5-SH.js.map
