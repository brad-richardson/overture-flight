(function(){"use strict";function he(e,n,t=2){const i=n&&n.length,r=i?n[0]*t:e.length;let s=ie(e,0,r,t,!0);const o=[];if(!s||s.next===s.prev)return o;let l,a,c;if(i&&(s=me(e,n,s,t)),e.length>80*t){l=e[0],a=e[1];let h=l,d=a;for(let b=t;b<r;b+=t){const m=e[b],g=e[b+1];m<l&&(l=m),g<a&&(a=g),m>h&&(h=m),g>d&&(d=g)}c=Math.max(h-l,d-a),c=c!==0?32767/c:0}return j(s,o,t,l,a,c,0),o}function ie(e,n,t,i,r){let s;if(r===Ae(e,n,t,i)>0)for(let o=n;o<t;o+=i)s=le(o/i|0,e[o],e[o+1],s);else for(let o=t-i;o>=n;o-=i)s=le(o/i|0,e[o],e[o+1],s);return s&&U(s,s.next)&&(J(s),s=s.next),s}function P(e,n){if(!e)return e;n||(n=e);let t=e,i;do if(i=!1,!t.steiner&&(U(t,t.next)||y(t.prev,t,t.next)===0)){if(J(t),t=n=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==n);return n}function j(e,n,t,i,r,s,o){if(!e)return;!o&&s&&Me(e,i,r,s);let l=e;for(;e.prev!==e.next;){const a=e.prev,c=e.next;if(s?de(e,i,r,s):ge(e)){n.push(a.i,e.i,c.i),J(e),e=c.next,l=c.next;continue}if(e=c,e===l){o?o===1?(e=pe(P(e),n),j(e,n,t,i,r,s,2)):o===2&&ye(e,n,t,i,r,s):j(P(e),n,t,i,r,s,1);break}}}function ge(e){const n=e.prev,t=e,i=e.next;if(y(n,t,i)>=0)return!1;const r=n.x,s=t.x,o=i.x,l=n.y,a=t.y,c=i.y,h=Math.min(r,s,o),d=Math.min(l,a,c),b=Math.max(r,s,o),m=Math.max(l,a,c);let g=i.next;for(;g!==n;){if(g.x>=h&&g.x<=b&&g.y>=d&&g.y<=m&&W(r,l,s,a,o,c,g.x,g.y)&&y(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function de(e,n,t,i){const r=e.prev,s=e,o=e.next;if(y(r,s,o)>=0)return!1;const l=r.x,a=s.x,c=o.x,h=r.y,d=s.y,b=o.y,m=Math.min(l,a,c),g=Math.min(h,d,b),I=Math.max(l,a,c),M=Math.max(h,d,b),D=q(m,g,n,t,i),A=q(I,M,n,t,i);let f=e.prevZ,u=e.nextZ;for(;f&&f.z>=D&&u&&u.z<=A;){if(f.x>=m&&f.x<=I&&f.y>=g&&f.y<=M&&f!==r&&f!==o&&W(l,h,a,d,c,b,f.x,f.y)&&y(f.prev,f,f.next)>=0||(f=f.prevZ,u.x>=m&&u.x<=I&&u.y>=g&&u.y<=M&&u!==r&&u!==o&&W(l,h,a,d,c,b,u.x,u.y)&&y(u.prev,u,u.next)>=0))return!1;u=u.nextZ}for(;f&&f.z>=D;){if(f.x>=m&&f.x<=I&&f.y>=g&&f.y<=M&&f!==r&&f!==o&&W(l,h,a,d,c,b,f.x,f.y)&&y(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;u&&u.z<=A;){if(u.x>=m&&u.x<=I&&u.y>=g&&u.y<=M&&u!==r&&u!==o&&W(l,h,a,d,c,b,u.x,u.y)&&y(u.prev,u,u.next)>=0)return!1;u=u.nextZ}return!0}function pe(e,n){let t=e;do{const i=t.prev,r=t.next.next;!U(i,r)&&oe(i,t,t.next,r)&&K(i,r)&&K(r,i)&&(n.push(i.i,t.i,r.i),J(t),J(t.next),t=e=r),t=t.next}while(t!==e);return P(t)}function ye(e,n,t,i,r,s){let o=e;do{let l=o.next.next;for(;l!==o.prev;){if(o.i!==l.i&&Ie(o,l)){let a=se(o,l);o=P(o,o.next),a=P(a,a.next),j(o,n,t,i,r,s,0),j(a,n,t,i,r,s,0);return}l=l.next}o=o.next}while(o!==e)}function me(e,n,t,i){const r=[];for(let s=0,o=n.length;s<o;s++){const l=n[s]*i,a=s<o-1?n[s+1]*i:e.length,c=ie(e,l,a,i,!1);c===c.next&&(c.steiner=!0),r.push(Ee(c))}r.sort(ve);for(let s=0;s<r.length;s++)t=we(r[s],t);return t}function ve(e,n){let t=e.x-n.x;if(t===0&&(t=e.y-n.y,t===0)){const i=(e.next.y-e.y)/(e.next.x-e.x),r=(n.next.y-n.y)/(n.next.x-n.x);t=i-r}return t}function we(e,n){const t=_e(e,n);if(!t)return n;const i=se(t,e);return P(i,i.next),P(t,t.next)}function _e(e,n){let t=n;const i=e.x,r=e.y;let s=-1/0,o;if(U(e,t))return t;do{if(U(e,t.next))return t.next;if(r<=t.y&&r>=t.next.y&&t.next.y!==t.y){const d=t.x+(r-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(d<=i&&d>s&&(s=d,o=t.x<t.next.x?t:t.next,d===i))return o}t=t.next}while(t!==n);if(!o)return null;const l=o,a=o.x,c=o.y;let h=1/0;t=o;do{if(i>=t.x&&t.x>=a&&i!==t.x&&re(r<c?i:s,r,a,c,r<c?s:i,r,t.x,t.y)){const d=Math.abs(r-t.y)/(i-t.x);K(t,e)&&(d<h||d===h&&(t.x>o.x||t.x===o.x&&be(o,t)))&&(o=t,h=d)}t=t.next}while(t!==l);return o}function be(e,n){return y(e.prev,e,n.prev)<0&&y(n.next,e,e.next)<0}function Me(e,n,t,i){let r=e;do r.z===0&&(r.z=q(r.x,r.y,n,t,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,ze(r)}function ze(e){let n,t=1;do{let i=e,r;e=null;let s=null;for(n=0;i;){n++;let o=i,l=0;for(let c=0;c<t&&(l++,o=o.nextZ,!!o);c++);let a=t;for(;l>0||a>0&&o;)l!==0&&(a===0||!o||i.z<=o.z)?(r=i,i=i.nextZ,l--):(r=o,o=o.nextZ,a--),s?s.nextZ=r:e=r,r.prevZ=s,s=r;i=o}s.nextZ=null,t*=2}while(n>1);return e}function q(e,n,t,i,r){return e=(e-t)*r|0,n=(n-i)*r|0,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e|n<<1}function Ee(e){let n=e,t=e;do(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next;while(n!==e);return t}function re(e,n,t,i,r,s,o,l){return(r-o)*(n-l)>=(e-o)*(s-l)&&(e-o)*(i-l)>=(t-o)*(n-l)&&(t-o)*(s-l)>=(r-o)*(i-l)}function W(e,n,t,i,r,s,o,l){return!(e===o&&n===l)&&re(e,n,t,i,r,s,o,l)}function Ie(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!Ce(e,n)&&(K(e,n)&&K(n,e)&&Ze(e,n)&&(y(e.prev,e,n.prev)||y(e,n.prev,n))||U(e,n)&&y(e.prev,e,e.next)>0&&y(n.prev,n,n.next)>0)}function y(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function U(e,n){return e.x===n.x&&e.y===n.y}function oe(e,n,t,i){const r=X(y(e,n,t)),s=X(y(e,n,i)),o=X(y(t,i,e)),l=X(y(t,i,n));return!!(r!==s&&o!==l||r===0&&Q(e,t,n)||s===0&&Q(e,i,n)||o===0&&Q(t,e,i)||l===0&&Q(t,n,i))}function Q(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function X(e){return e>0?1:e<0?-1:0}function Ce(e,n){let t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&oe(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}function K(e,n){return y(e.prev,e,e.next)<0?y(e,n,e.next)>=0&&y(e,e.prev,n)>=0:y(e,n,e.prev)<0||y(e,e.next,n)<0}function Ze(e,n){let t=e,i=!1;const r=(e.x+n.x)/2,s=(e.y+n.y)/2;do t.y>s!=t.next.y>s&&t.next.y!==t.y&&r<(t.next.x-t.x)*(s-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==e);return i}function se(e,n){const t=ee(e.i,e.x,e.y),i=ee(n.i,n.x,n.y),r=e.next,s=n.prev;return e.next=n,n.prev=e,t.next=r,r.prev=t,i.next=t,t.prev=i,s.next=i,i.prev=s,i}function le(e,n,t,i){const r=ee(e,n,t);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function J(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function ee(e,n,t){return{i:e,x:n,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ae(e,n,t,i){let r=0;for(let s=n,o=t-i;s<t;s+=i)r+=(e[o]-e[s])*(e[s+1]+e[o+1]),o=s;return r}const ue={residential:{walls:[15260872,13943976,12099714,13219990,15062464,11047024,9139029,13468991,12357519,16113331]},commercial:{walls:[7372944,7833753,11119017,12632256,13882323,5929610,5930366,8034986,9084076,10531e3]},industrial:{walls:[6908265,8421504,11119017,7372944,4871528,6052956,7041664,10265519,12892568,13943976]},civic:{walls:[13882323,12632256,15261904,15064272,15262940,13684952,14737632,12433259,13808780,12357519]},religious:{walls:[15789024,15261909,13808780,14596231,12357519,15262936,14210252,13943976,9127187,13468991]},education:{walls:[13468991,10506797,13789470,9127187,13808780,14596231,12632256,11119017,12357519,16032864]},medical:{walls:[16316664,15790320,15263976,14737632,16119285,15527148,14213344,13160660,12109e3,10531e3]},agricultural:{walls:[9127187,10506797,13468991,13789470,8077056,9132587,14596231,13808780,7048739,8421376]},entertainment:{walls:[4868682,3100495,4013404,4868698,5921370,3947580,3096399,1842204,12632256,7372944]},military:{walls:[5597999,7048739,8421376,9145088,6908265,4871528,6250335,10506797,9139029,8421504]},outbuilding:{walls:[9127187,10506797,6908265,8421504,13808780,14596231,7048739,9083546,11053224,7372944]},service:{walls:[7372944,8421504,11119017,9083560,11579568,13158600,4871528,7041664,14211288,14737632]},transportation:{walls:[7372944,7833753,11579568,13158600,5929610,5930366,8034986,9084076,14211288,14735568]},default:{walls:[8421504,9474192,10526880,11579568,8947865,10000536,11053224,12632256,7833753,7372944]}},ce={house:"residential",residential:"residential",detached:"residential",semi:"residential",semidetached_house:"residential",terrace:"residential",apartments:"residential",bungalow:"residential",dwelling_house:"residential",stilt_house:"residential",trullo:"residential",cabin:"residential",houseboat:"residential",static_caravan:"residential",ger:"residential",hut:"residential",beach_hut:"residential",allotment_house:"residential",dormitory:"residential",garage:"residential",garages:"residential",carport:"residential",boathouse:"residential",commercial:"commercial",office:"commercial",retail:"commercial",supermarket:"commercial",hotel:"commercial",kiosk:"commercial",parking:"commercial",industrial:"industrial",warehouse:"industrial",factory:"industrial",manufacture:"industrial",hangar:"industrial",storage_tank:"industrial",silo:"industrial",slurry_tank:"industrial",digester:"industrial",transformer_tower:"industrial",roof:"industrial",bridge_structure:"industrial",civic:"civic",public:"civic",government:"civic",fire_station:"civic",post_office:"civic",library:"civic",toilets:"civic",guardhouse:"civic",stadium:"civic",sports_centre:"civic",sports_hall:"civic",grandstand:"civic",pavilion:"civic",religious:"religious",church:"religious",chapel:"religious",cathedral:"religious",mosque:"religious",temple:"religious",synagogue:"religious",shrine:"religious",wayside_shrine:"religious",monastery:"religious",presbytery:"religious",school:"education",university:"education",college:"education",kindergarten:"education",hospital:"medical",agricultural:"agricultural",farm:"agricultural",barn:"agricultural",farm_auxiliary:"agricultural",cowshed:"agricultural",stable:"agricultural",sty:"agricultural",greenhouse:"agricultural",glasshouse:"agricultural",military:"military",bunker:"military",outbuilding:"outbuilding",shed:"outbuilding",service:"service",transportation:"transportation",train_station:"transportation"},Le=new Set(["agricultural","civic","commercial","education","entertainment","industrial","medical","military","outbuilding","religious","residential","service","transportation"]);function ke(e){return function(){let n=e+=1831565813;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}function Fe(e){const n=e.properties;if((n==null?void 0:n.building_id)!==void 0){let t=0;const i=String(n.building_id);for(let r=0;r<i.length;r++)t=(t<<5)-t+i.charCodeAt(r),t=t&t;return Math.abs(t)}if((n==null?void 0:n.id)!==void 0){let t=0;const i=String(n.id);for(let r=0;r<i.length;r++)t=(t<<5)-t+i.charCodeAt(r),t=t&t;return Math.abs(t)}if(e.coordinates){const t=e.type==="MultiPolygon"?e.coordinates[0][0][0]:e.coordinates[0][0];if(t&&t.length>=2)return Math.abs(Math.floor(t[0]*1e6+t[1]*1e3))}return 42}function Re(e){const n=e.properties;if(!n)return"default";const t=n.subtype;if(t){const r=String(t).toLowerCase();if(Le.has(r))return r}const i=n.class;if(i){const r=String(i).toLowerCase();if(ce[r])return ce[r]}return"default"}function Te(e){const n=Re(e),t=ue[n]||ue.default,i=Fe(e),r=ke(i),s=Math.floor(r()*t.walls.length);return t.walls[s]}const te=2,Be=.5,Se=.3,Pe=50;function ae(e,n,t,i){const r=(e-i.lng)*i.metersPerDegLng,s=-(n-i.lat)*i.metersPerDegLat;return{x:r,y:t,z:s}}function ne(e){let n=0;for(let t=0,i=e.length-1;t<e.length;i=t++)n+=(e[i].x+e[t].x)*(e[i].z-e[t].z);return n/2}function De(e,n){return typeof e.height=="number"&&e.height>0?e.height:typeof e.num_floors=="number"&&e.num_floors>0?e.num_floors*3:n}function Oe(e){return Te({type:e.type,coordinates:e.coordinates,properties:e.properties})}function Ge(e,n,t,i,r,s,o,l,a){if(!e||e.length===0)return null;const c=e[0];if(!c||c.length<3)return null;let h=[];for(const x of c){const p=ae(x[0],x[1],0,a);h.push({x:p.x,z:p.z})}if(h.length>1){const x=h[0],p=h[h.length-1];Math.abs(x.x-p.x)<.01&&Math.abs(x.z-p.z)<.01&&h.pop()}if(h.length<3)return null;const d=ne(h);if(Math.abs(d)<1||r===te&&Math.abs(d)<Pe||h.length<3)return null;const b=ne(h);if(Math.abs(b)<1)return null;b>0&&h.reverse();const m=s*l+Be-o*Se,g=m+n,I=m+t,M=[];for(const x of h)M.push(x.x,x.z);const D=[],A=[];if(r!==te&&e.length>1)for(let x=1;x<e.length;x++){const p=e[x];if(!p||p.length<3)continue;D.push(M.length/2);let w=[];for(const z of p){const C=ae(z[0],z[1],0,a);w.push({x:C.x,z:C.z})}if(w.length>1){const z=w[0],C=w[w.length-1];Math.abs(z.x-C.x)<.01&&Math.abs(z.z-C.z)<.01&&w.pop()}ne(w)<0&&w.reverse(),A.push(w.length);for(const z of w)M.push(z.x,z.z)}const f=he(M,D,2);if(f.length===0)return null;const u=M.length/2,_=[];for(let x=0;x<u;x++)_.push({x:M[x*2],z:M[x*2+1]});const v=[],O=[],G=[],Z=[],L=(i>>16&255)/255,$=(i>>8&255)/255,N=(i&255)/255,T=v.length/3;for(const x of _)v.push(x.x,g,x.z),O.push(0,1,0),G.push(L,$,N);for(let x=0;x<f.length;x+=3)Z.push(T+f[x]),Z.push(T+f[x+2]),Z.push(T+f[x+1]);if(t>0){const x=v.length/3;for(const p of _)v.push(p.x,I,p.z),O.push(0,-1,0),G.push(L*.7,$*.7,N*.7);for(let p=f.length-1;p>=0;p--)Z.push(x+f[p])}const k=h.length,E=.85;for(let x=0;x<k;x++){const p=h[x],w=h[(x+1)%k],R=w.x-p.x,z=w.z-p.z,C=Math.sqrt(R*R+z*z);if(C<.01)continue;const B=z/C,S=-R/C,F=v.length/3,Y=t>0?I:m;v.push(p.x,Y,p.z),v.push(w.x,Y,w.z),v.push(w.x,g,w.z),v.push(p.x,g,p.z);for(let H=0;H<4;H++)O.push(B,0,S),G.push(L*E,$*E,N*E);Z.push(F+0,F+3,F+2),Z.push(F+0,F+2,F+1)}if(r!==te&&A.length>0){let x=k;for(let p=0;p<A.length;p++){const w=A[p];for(let R=0;R<w;R++){const z=x+R,C=x+(R+1)%w;if(z>=_.length||C>=_.length)break;const B=_[z],S=_[C],F=S.x-B.x,Y=S.z-B.z,H=Math.sqrt(F*F+Y*Y);if(H<.01)continue;const Ne=-Y/H,Ye=F/H,V=v.length/3,fe=t>0?I:m;v.push(B.x,fe,B.z),v.push(S.x,fe,S.z),v.push(S.x,g,S.z),v.push(B.x,g,B.z);for(let xe=0;xe<4;xe++)O.push(Ne,0,Ye),G.push(L*E,$*E,N*E);Z.push(V+0,V+3,V+2),Z.push(V+0,V+2,V+1)}x+=w}}return{positions:v,normals:O,colors:G,indices:Z}}function Ue(e){const{features:n,origin:t,lodLevel:i,defaultHeight:r,terrainHeights:s,verticalExaggeration:o}=e,l=[],a=[],c=[],h=[];let d=0,b=0,m=0;const g={},I="80c3f0b9-16cf-47c3-9e79-fa1e182b470f",M=[],D=new Set;let A=0;for(const u of n){g[u.layer||"unknown"]=(g[u.layer||"unknown"]||0)+1;const _=u.properties.id,v=u.properties.building_id;v&&(D.add(v),A++),(_===I||v===I)&&M.push({layer:u.layer||"unknown",id:_||"no-id",building_id:v,height:u.properties.height,min_height:u.properties.min_height,has_parts:u.properties.has_parts})}if(M.length>0){console.log(`[BuildingDebug] Found ${M.length} features for building ${I}:`);for(const u of M)console.log(`  - ${u.layer}: id=${u.id}, height=${u.height}, min_height=${u.min_height}, has_parts=${u.has_parts}, building_id=${u.building_id}`);console.log(`[BuildingDebug] Stats: ${A}/${g.building_part||0} building_parts have building_id`)}for(let u=0;u<n.length;u++){const _=n[u];if(_.properties.is_underground||_.properties.has_parts===!0)continue;const v=_.type==="Polygon"?[_.coordinates]:_.coordinates,O=De(_.properties,r),G=typeof _.properties.min_height=="number"?_.properties.min_height:0,Z=Oe(_),L=s==null?void 0:s[u],$=L?L[0]:0,N=L?L[1]-L[0]:0;for(const T of v)if(!(!T||!T[0]||T[0].length<3))try{const k=Ge(T,O,G,Z,i,$,N,o,t);if(k){for(const E of k.positions)l.push(E);for(const E of k.normals)a.push(E);for(const E of k.colors)c.push(E);for(const E of k.indices)h.push(E+d);d+=k.positions.length/3,b++}else m++}catch{m++}}return l.length===0?{geometry:null,stats:{buildingsProcessed:0,buildingsSkipped:m,totalVertices:0,totalTriangles:0}}:{geometry:{positions:new Float32Array(l),normals:new Float32Array(a),colors:new Float32Array(c),indices:new Uint32Array(h)},stats:{buildingsProcessed:b,buildingsSkipped:m,totalVertices:l.length/3,totalTriangles:h.length/3}}}function $e(e){return e.geometry?[e.geometry.positions.buffer,e.geometry.normals.buffer,e.geometry.colors.buffer,e.geometry.indices.buffer]:[]}self.onmessage=e=>{const n=e.data;try{switch(n.type){case"CAPABILITY_CHECK":{const t={type:"CAPABILITY_CHECK_RESULT",id:n.id,supported:!0};self.postMessage(t);break}case"CREATE_BUILDING_GEOMETRY":{const t=n.payload,i=Ue(t),r=$e(i),s={type:"CREATE_BUILDING_GEOMETRY_RESULT",id:n.id,result:i};self.postMessage(s,{transfer:r});break}default:{const t={type:"ERROR",id:n.id||"unknown",error:`Building geometry worker received unsupported request type: ${n.type}`};self.postMessage(t)}}}catch(t){const i={type:"ERROR",id:n.id,error:t instanceof Error?t.message:"Unknown error in building geometry worker"};self.postMessage(i)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=building-geometry.worker-CEguWavM.js.map
