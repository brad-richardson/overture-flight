(function(){"use strict";function he(e,n,t=2){const r=n&&n.length,i=r?n[0]*t:e.length;let s=re(e,0,i,t,!0);const o=[];if(!s||s.next===s.prev)return o;let l,a,u;if(r&&(s=ve(e,n,s,t)),e.length>80*t){l=e[0],a=e[1];let x=l,p=a;for(let _=t;_<i;_+=t){const y=e[_],g=e[_+1];y<l&&(l=y),g<a&&(a=g),y>x&&(x=y),g>p&&(p=g)}u=Math.max(x-l,p-a),u=u!==0?32767/u:0}return Y(s,o,t,l,a,u,0),o}function re(e,n,t,r,i){let s;if(i===Ie(e,n,t,r)>0)for(let o=n;o<t;o+=r)s=le(o/r|0,e[o],e[o+1],s);else for(let o=t-r;o>=n;o-=r)s=le(o/r|0,e[o],e[o+1],s);return s&&O(s,s.next)&&(j(s),s=s.next),s}function S(e,n){if(!e)return e;n||(n=e);let t=e,r;do if(r=!1,!t.steiner&&(O(t,t.next)||v(t.prev,t,t.next)===0)){if(j(t),t=n=t.prev,t===t.next)break;r=!0}else t=t.next;while(r||t!==n);return n}function Y(e,n,t,r,i,s,o){if(!e)return;!o&&s&&be(e,r,i,s);let l=e;for(;e.prev!==e.next;){const a=e.prev,u=e.next;if(s?pe(e,r,i,s):ge(e)){n.push(a.i,e.i,u.i),j(e),e=u.next,l=u.next;continue}if(e=u,e===l){o?o===1?(e=de(S(e),n),Y(e,n,t,r,i,s,2)):o===2&&ye(e,n,t,r,i,s):Y(S(e),n,t,r,i,s,1);break}}}function ge(e){const n=e.prev,t=e,r=e.next;if(v(n,t,r)>=0)return!1;const i=n.x,s=t.x,o=r.x,l=n.y,a=t.y,u=r.y,x=Math.min(i,s,o),p=Math.min(l,a,u),_=Math.max(i,s,o),y=Math.max(l,a,u);let g=r.next;for(;g!==n;){if(g.x>=x&&g.x<=_&&g.y>=p&&g.y<=y&&H(i,l,s,a,o,u,g.x,g.y)&&v(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function pe(e,n,t,r){const i=e.prev,s=e,o=e.next;if(v(i,s,o)>=0)return!1;const l=i.x,a=s.x,u=o.x,x=i.y,p=s.y,_=o.y,y=Math.min(l,a,u),g=Math.min(x,p,_),E=Math.max(l,a,u),m=Math.max(x,p,_),B=Q(y,g,n,t,r),R=Q(E,m,n,t,r);let c=e.prevZ,h=e.nextZ;for(;c&&c.z>=B&&h&&h.z<=R;){if(c.x>=y&&c.x<=E&&c.y>=g&&c.y<=m&&c!==i&&c!==o&&H(l,x,a,p,u,_,c.x,c.y)&&v(c.prev,c,c.next)>=0||(c=c.prevZ,h.x>=y&&h.x<=E&&h.y>=g&&h.y<=m&&h!==i&&h!==o&&H(l,x,a,p,u,_,h.x,h.y)&&v(h.prev,h,h.next)>=0))return!1;h=h.nextZ}for(;c&&c.z>=B;){if(c.x>=y&&c.x<=E&&c.y>=g&&c.y<=m&&c!==i&&c!==o&&H(l,x,a,p,u,_,c.x,c.y)&&v(c.prev,c,c.next)>=0)return!1;c=c.prevZ}for(;h&&h.z<=R;){if(h.x>=y&&h.x<=E&&h.y>=g&&h.y<=m&&h!==i&&h!==o&&H(l,x,a,p,u,_,h.x,h.y)&&v(h.prev,h,h.next)>=0)return!1;h=h.nextZ}return!0}function de(e,n){let t=e;do{const r=t.prev,i=t.next.next;!O(r,i)&&oe(r,t,t.next,i)&&V(r,i)&&V(i,r)&&(n.push(r.i,t.i,i.i),j(t),j(t.next),t=e=i),t=t.next}while(t!==e);return S(t)}function ye(e,n,t,r,i,s){let o=e;do{let l=o.next.next;for(;l!==o.prev;){if(o.i!==l.i&&Ce(o,l)){let a=se(o,l);o=S(o,o.next),a=S(a,a.next),Y(o,n,t,r,i,s,0),Y(a,n,t,r,i,s,0);return}l=l.next}o=o.next}while(o!==e)}function ve(e,n,t,r){const i=[];for(let s=0,o=n.length;s<o;s++){const l=n[s]*r,a=s<o-1?n[s+1]*r:e.length,u=re(e,l,a,r,!1);u===u.next&&(u.steiner=!0),i.push(Ee(u))}i.sort(me);for(let s=0;s<i.length;s++)t=we(i[s],t);return t}function me(e,n){let t=e.x-n.x;if(t===0&&(t=e.y-n.y,t===0)){const r=(e.next.y-e.y)/(e.next.x-e.x),i=(n.next.y-n.y)/(n.next.x-n.x);t=r-i}return t}function we(e,n){const t=_e(e,n);if(!t)return n;const r=se(t,e);return S(r,r.next),S(t,t.next)}function _e(e,n){let t=n;const r=e.x,i=e.y;let s=-1/0,o;if(O(e,t))return t;do{if(O(e,t.next))return t.next;if(i<=t.y&&i>=t.next.y&&t.next.y!==t.y){const p=t.x+(i-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(p<=r&&p>s&&(s=p,o=t.x<t.next.x?t:t.next,p===r))return o}t=t.next}while(t!==n);if(!o)return null;const l=o,a=o.x,u=o.y;let x=1/0;t=o;do{if(r>=t.x&&t.x>=a&&r!==t.x&&ie(i<u?r:s,i,a,u,i<u?s:r,i,t.x,t.y)){const p=Math.abs(i-t.y)/(r-t.x);V(t,e)&&(p<x||p===x&&(t.x>o.x||t.x===o.x&&Me(o,t)))&&(o=t,x=p)}t=t.next}while(t!==l);return o}function Me(e,n){return v(e.prev,e,n.prev)<0&&v(n.next,e,e.next)<0}function be(e,n,t,r){let i=e;do i.z===0&&(i.z=Q(i.x,i.y,n,t,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,ze(i)}function ze(e){let n,t=1;do{let r=e,i;e=null;let s=null;for(n=0;r;){n++;let o=r,l=0;for(let u=0;u<t&&(l++,o=o.nextZ,!!o);u++);let a=t;for(;l>0||a>0&&o;)l!==0&&(a===0||!o||r.z<=o.z)?(i=r,r=r.nextZ,l--):(i=o,o=o.nextZ,a--),s?s.nextZ=i:e=i,i.prevZ=s,s=i;r=o}s.nextZ=null,t*=2}while(n>1);return e}function Q(e,n,t,r,i){return e=(e-t)*i|0,n=(n-r)*i|0,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e|n<<1}function Ee(e){let n=e,t=e;do(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next;while(n!==e);return t}function ie(e,n,t,r,i,s,o,l){return(i-o)*(n-l)>=(e-o)*(s-l)&&(e-o)*(r-l)>=(t-o)*(n-l)&&(t-o)*(s-l)>=(i-o)*(r-l)}function H(e,n,t,r,i,s,o,l){return!(e===o&&n===l)&&ie(e,n,t,r,i,s,o,l)}function Ce(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!Ze(e,n)&&(V(e,n)&&V(n,e)&&Ae(e,n)&&(v(e.prev,e,n.prev)||v(e,n.prev,n))||O(e,n)&&v(e.prev,e,e.next)>0&&v(n.prev,n,n.next)>0)}function v(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function O(e,n){return e.x===n.x&&e.y===n.y}function oe(e,n,t,r){const i=W(v(e,n,t)),s=W(v(e,n,r)),o=W(v(t,r,e)),l=W(v(t,r,n));return!!(i!==s&&o!==l||i===0&&K(e,t,n)||s===0&&K(e,r,n)||o===0&&K(t,e,r)||l===0&&K(t,n,r))}function K(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function W(e){return e>0?1:e<0?-1:0}function Ze(e,n){let t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&oe(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}function V(e,n){return v(e.prev,e,e.next)<0?v(e,n,e.next)>=0&&v(e,e.prev,n)>=0:v(e,n,e.prev)<0||v(e,e.next,n)<0}function Ae(e,n){let t=e,r=!1;const i=(e.x+n.x)/2,s=(e.y+n.y)/2;do t.y>s!=t.next.y>s&&t.next.y!==t.y&&i<(t.next.x-t.x)*(s-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next;while(t!==e);return r}function se(e,n){const t=X(e.i,e.x,e.y),r=X(n.i,n.x,n.y),i=e.next,s=n.prev;return e.next=n,n.prev=e,t.next=i,i.prev=t,r.next=t,t.prev=r,s.next=r,r.prev=s,r}function le(e,n,t,r){const i=X(e,n,t);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function j(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function X(e,n,t){return{i:e,x:n,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ie(e,n,t,r){let i=0;for(let s=n,o=t-r;s<t;s+=r)i+=(e[o]-e[s])*(e[s+1]+e[o+1]),o=s;return i}const ue={residential:{walls:[15260872,13943976,12099714,13219990,15062464,11047024,9139029,13468991,12357519,16113331]},commercial:{walls:[7372944,7833753,11119017,12632256,13882323,5929610,5930366,8034986,9084076,10531e3]},industrial:{walls:[6908265,8421504,11119017,7372944,4871528,6052956,7041664,10265519,12892568,13943976]},civic:{walls:[13882323,12632256,15261904,15064272,15262940,13684952,14737632,12433259,13808780,12357519]},religious:{walls:[15789024,15261909,13808780,14596231,12357519,15262936,14210252,13943976,9127187,13468991]},education:{walls:[13468991,10506797,13789470,9127187,13808780,14596231,12632256,11119017,12357519,16032864]},medical:{walls:[16316664,15790320,15263976,14737632,16119285,15527148,14213344,13160660,12109e3,10531e3]},agricultural:{walls:[9127187,10506797,13468991,13789470,8077056,9132587,14596231,13808780,7048739,8421376]},entertainment:{walls:[4868682,3100495,4013404,4868698,5921370,3947580,3096399,1842204,12632256,7372944]},military:{walls:[5597999,7048739,8421376,9145088,6908265,4871528,6250335,10506797,9139029,8421504]},outbuilding:{walls:[9127187,10506797,6908265,8421504,13808780,14596231,7048739,9083546,11053224,7372944]},service:{walls:[7372944,8421504,11119017,9083560,11579568,13158600,4871528,7041664,14211288,14737632]},transportation:{walls:[7372944,7833753,11579568,13158600,5929610,5930366,8034986,9084076,14211288,14735568]},default:{walls:[8421504,9474192,10526880,11579568,8947865,10000536,11053224,12632256,7833753,7372944]}},ce={house:"residential",residential:"residential",detached:"residential",semi:"residential",semidetached_house:"residential",terrace:"residential",apartments:"residential",bungalow:"residential",dwelling_house:"residential",stilt_house:"residential",trullo:"residential",cabin:"residential",houseboat:"residential",static_caravan:"residential",ger:"residential",hut:"residential",beach_hut:"residential",allotment_house:"residential",dormitory:"residential",garage:"residential",garages:"residential",carport:"residential",boathouse:"residential",commercial:"commercial",office:"commercial",retail:"commercial",supermarket:"commercial",hotel:"commercial",kiosk:"commercial",parking:"commercial",industrial:"industrial",warehouse:"industrial",factory:"industrial",manufacture:"industrial",hangar:"industrial",storage_tank:"industrial",silo:"industrial",slurry_tank:"industrial",digester:"industrial",transformer_tower:"industrial",roof:"industrial",bridge_structure:"industrial",civic:"civic",public:"civic",government:"civic",fire_station:"civic",post_office:"civic",library:"civic",toilets:"civic",guardhouse:"civic",stadium:"civic",sports_centre:"civic",sports_hall:"civic",grandstand:"civic",pavilion:"civic",religious:"religious",church:"religious",chapel:"religious",cathedral:"religious",mosque:"religious",temple:"religious",synagogue:"religious",shrine:"religious",wayside_shrine:"religious",monastery:"religious",presbytery:"religious",school:"education",university:"education",college:"education",kindergarten:"education",hospital:"medical",agricultural:"agricultural",farm:"agricultural",barn:"agricultural",farm_auxiliary:"agricultural",cowshed:"agricultural",stable:"agricultural",sty:"agricultural",greenhouse:"agricultural",glasshouse:"agricultural",military:"military",bunker:"military",outbuilding:"outbuilding",shed:"outbuilding",service:"service",transportation:"transportation",train_station:"transportation"},Le=new Set(["agricultural","civic","commercial","education","entertainment","industrial","medical","military","outbuilding","religious","residential","service","transportation"]);function Re(e){return function(){let n=e+=1831565813;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}function Fe(e){const n=e.properties;if((n==null?void 0:n.building_id)!==void 0){let t=0;const r=String(n.building_id);for(let i=0;i<r.length;i++)t=(t<<5)-t+r.charCodeAt(i),t=t&t;return Math.abs(t)}if((n==null?void 0:n.id)!==void 0){let t=0;const r=String(n.id);for(let i=0;i<r.length;i++)t=(t<<5)-t+r.charCodeAt(i),t=t&t;return Math.abs(t)}if(e.coordinates){const t=e.type==="MultiPolygon"?e.coordinates[0][0][0]:e.coordinates[0][0];if(t&&t.length>=2)return Math.abs(Math.floor(t[0]*1e6+t[1]*1e3))}return 42}function Te(e){const n=e.properties;if(!n)return"default";const t=n.subtype;if(t){const i=String(t).toLowerCase();if(Le.has(i))return i}const r=n.class;if(r){const i=String(r).toLowerCase();if(ce[i])return ce[i]}return"default"}function ke(e){const n=Te(e),t=ue[n]||ue.default,r=Fe(e),i=Re(r),s=Math.floor(i()*t.walls.length);return t.walls[s]}const q=2,Se=.5,Be=.3,Pe=50;function ae(e,n,t,r){const i=(e-r.lng)*r.metersPerDegLng,s=-(n-r.lat)*r.metersPerDegLat;return{x:i,y:t,z:s}}function ee(e){let n=0;for(let t=0,r=e.length-1;t<e.length;r=t++)n+=(e[r].x+e[t].x)*(e[r].z-e[t].z);return n/2}function Oe(e,n){return typeof e.height=="number"&&e.height>0?e.height:typeof e.num_floors=="number"&&e.num_floors>0?e.num_floors*3:n}function De(e){return ke({type:e.type,coordinates:e.coordinates,properties:e.properties})}function Ue(e,n,t,r,i,s,o,l,a){if(!e||e.length===0)return null;const u=e[0];if(!u||u.length<3)return null;let x=[];for(const f of u){const d=ae(f[0],f[1],0,a);x.push({x:d.x,z:d.z})}if(x.length>1){const f=x[0],d=x[x.length-1];Math.abs(f.x-d.x)<.01&&Math.abs(f.z-d.z)<.01&&x.pop()}if(x.length<3)return null;const p=ee(x);if(Math.abs(p)<1||i===q&&Math.abs(p)<Pe||x.length<3)return null;const _=ee(x);if(Math.abs(_)<1)return null;_>0&&x.reverse();const y=s*l+Se-o*Be,g=y+n,E=y+t,m=[];for(const f of x)m.push(f.x,f.z);const B=[],R=[];if(i!==q&&e.length>1)for(let f=1;f<e.length;f++){const d=e[f];if(!d||d.length<3)continue;B.push(m.length/2);let w=[];for(const z of d){const A=ae(z[0],z[1],0,a);w.push({x:A.x,z:A.z})}if(w.length>1){const z=w[0],A=w[w.length-1];Math.abs(z.x-A.x)<.01&&Math.abs(z.z-A.z)<.01&&w.pop()}ee(w)<0&&w.reverse(),R.push(w.length);for(const z of w)m.push(z.x,z.z)}const c=he(m,B,2);if(c.length===0)return null;const h=m.length/2,C=[];for(let f=0;f<h;f++)C.push({x:m[f*2],z:m[f*2+1]});const M=[],P=[],I=[],b=[],Z=(r>>16&255)/255,$=(r>>8&255)/255,J=(r&255)/255,te=M.length/3;for(const f of C)M.push(f.x,g,f.z),P.push(0,1,0),I.push(Z,$,J);for(let f=0;f<c.length;f+=3)b.push(te+c[f]),b.push(te+c[f+2]),b.push(te+c[f+1]);if(t>0){const f=M.length/3;for(const d of C)M.push(d.x,E,d.z),P.push(0,-1,0),I.push(Z*.7,$*.7,J*.7);for(let d=c.length-1;d>=0;d--)b.push(f+c[d])}const ne=x.length,D=.85;for(let f=0;f<ne;f++){const d=x[f],w=x[(f+1)%ne],F=w.x-d.x,z=w.z-d.z,A=Math.sqrt(F*F+z*z);if(A<.01)continue;const T=z/A,k=-F/A,L=M.length/3,U=t>0?E:y;M.push(d.x,U,d.z),M.push(w.x,U,w.z),M.push(w.x,g,w.z),M.push(d.x,g,d.z);for(let G=0;G<4;G++)P.push(T,0,k),I.push(Z*D,$*D,J*D);b.push(L+0,L+3,L+2),b.push(L+0,L+2,L+1)}if(i!==q&&R.length>0){let f=ne;for(let d=0;d<R.length;d++){const w=R[d];for(let F=0;F<w;F++){const z=f+F,A=f+(F+1)%w;if(z>=C.length||A>=C.length)break;const T=C[z],k=C[A],L=k.x-T.x,U=k.z-T.z,G=Math.sqrt(L*L+U*U);if(G<.01)continue;const Ye=-U/G,He=L/G,N=M.length/3,fe=t>0?E:y;M.push(T.x,fe,T.z),M.push(k.x,fe,k.z),M.push(k.x,g,k.z),M.push(T.x,g,T.z);for(let xe=0;xe<4;xe++)P.push(Ye,0,He),I.push(Z*D,$*D,J*D);b.push(N+0,N+3,N+2),b.push(N+0,N+2,N+1)}f+=w}}return{positions:M,normals:P,colors:I,indices:b}}function Ge(e){const{features:n,origin:t,lodLevel:r,defaultHeight:i,terrainHeights:s,verticalExaggeration:o}=e,l=[],a=[],u=[],x=[];let p=0,_=0,y=0;for(let E=0;E<n.length;E++){const m=n[E];if(m.properties.is_underground){y++;continue}if(m.properties.has_parts===!0){y++;continue}const B=m.type==="Polygon"?[m.coordinates]:m.coordinates,R=Oe(m.properties,i),c=typeof m.properties.min_height=="number"?m.properties.min_height:0,h=De(m),C=s==null?void 0:s[E],M=C?C[0]:0,P=C?C[1]-C[0]:0;for(const I of B)if(!(!I||!I[0]||I[0].length<3))try{const b=Ue(I,R,c,h,r,M,P,o,t);if(b){for(const Z of b.positions)l.push(Z);for(const Z of b.normals)a.push(Z);for(const Z of b.colors)u.push(Z);for(const Z of b.indices)x.push(Z+p);p+=b.positions.length/3,_++}else y++}catch{y++}}return l.length===0?{geometry:null,stats:{buildingsProcessed:0,buildingsSkipped:y,totalVertices:0,totalTriangles:0}}:{geometry:{positions:new Float32Array(l),normals:new Float32Array(a),colors:new Float32Array(u),indices:new Uint32Array(x)},stats:{buildingsProcessed:_,buildingsSkipped:y,totalVertices:l.length/3,totalTriangles:x.length/3}}}function Ne(e){return e.geometry?[e.geometry.positions.buffer,e.geometry.normals.buffer,e.geometry.colors.buffer,e.geometry.indices.buffer]:[]}self.onmessage=e=>{const n=e.data;try{switch(n.type){case"CAPABILITY_CHECK":{const t={type:"CAPABILITY_CHECK_RESULT",id:n.id,supported:!0};self.postMessage(t);break}case"CREATE_BUILDING_GEOMETRY":{const t=n.payload,r=Ge(t),i=Ne(r),s={type:"CREATE_BUILDING_GEOMETRY_RESULT",id:n.id,result:r};self.postMessage(s,{transfer:i});break}default:{const t={type:"ERROR",id:n.id||"unknown",error:`Building geometry worker received unsupported request type: ${n.type}`};self.postMessage(t)}}}catch(t){const r={type:"ERROR",id:n.id,error:t instanceof Error?t.message:"Unknown error in building geometry worker"};self.postMessage(r)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=building-geometry.worker-DODlGkkp.js.map
