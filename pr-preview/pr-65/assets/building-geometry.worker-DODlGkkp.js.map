{"version":3,"file":"building-geometry.worker-DODlGkkp.js","sources":["../node_modules/earcut/src/earcut.js","../src/building-colors.ts","../src/workers/building-geometry-builder.ts","../src/workers/building-geometry.worker.ts"],"sourcesContent":["\nexport default function earcut(data, holeIndices, dim = 2) {\n\n    const hasHoles = holeIndices && holeIndices.length;\n    const outerLen = hasHoles ? holeIndices[0] * dim : data.length;\n    let outerNode = linkedList(data, 0, outerLen, dim, true);\n    const triangles = [];\n\n    if (!outerNode || outerNode.next === outerNode.prev) return triangles;\n\n    let minX, minY, invSize;\n\n    if (hasHoles) outerNode = eliminateHoles(data, holeIndices, outerNode, dim);\n\n    // if the shape is not too simple, we'll use z-order curve hash later; calculate polygon bbox\n    if (data.length > 80 * dim) {\n        minX = data[0];\n        minY = data[1];\n        let maxX = minX;\n        let maxY = minY;\n\n        for (let i = dim; i < outerLen; i += dim) {\n            const x = data[i];\n            const y = data[i + 1];\n            if (x < minX) minX = x;\n            if (y < minY) minY = y;\n            if (x > maxX) maxX = x;\n            if (y > maxY) maxY = y;\n        }\n\n        // minX, minY and invSize are later used to transform coords into integers for z-order calculation\n        invSize = Math.max(maxX - minX, maxY - minY);\n        invSize = invSize !== 0 ? 32767 / invSize : 0;\n    }\n\n    earcutLinked(outerNode, triangles, dim, minX, minY, invSize, 0);\n\n    return triangles;\n}\n\n// create a circular doubly linked list from polygon points in the specified winding order\nfunction linkedList(data, start, end, dim, clockwise) {\n    let last;\n\n    if (clockwise === (signedArea(data, start, end, dim) > 0)) {\n        for (let i = start; i < end; i += dim) last = insertNode(i / dim | 0, data[i], data[i + 1], last);\n    } else {\n        for (let i = end - dim; i >= start; i -= dim) last = insertNode(i / dim | 0, data[i], data[i + 1], last);\n    }\n\n    if (last && equals(last, last.next)) {\n        removeNode(last);\n        last = last.next;\n    }\n\n    return last;\n}\n\n// eliminate colinear or duplicate points\nfunction filterPoints(start, end) {\n    if (!start) return start;\n    if (!end) end = start;\n\n    let p = start,\n        again;\n    do {\n        again = false;\n\n        if (!p.steiner && (equals(p, p.next) || area(p.prev, p, p.next) === 0)) {\n            removeNode(p);\n            p = end = p.prev;\n            if (p === p.next) break;\n            again = true;\n\n        } else {\n            p = p.next;\n        }\n    } while (again || p !== end);\n\n    return end;\n}\n\n// main ear slicing loop which triangulates a polygon (given as a linked list)\nfunction earcutLinked(ear, triangles, dim, minX, minY, invSize, pass) {\n    if (!ear) return;\n\n    // interlink polygon nodes in z-order\n    if (!pass && invSize) indexCurve(ear, minX, minY, invSize);\n\n    let stop = ear;\n\n    // iterate through ears, slicing them one by one\n    while (ear.prev !== ear.next) {\n        const prev = ear.prev;\n        const next = ear.next;\n\n        if (invSize ? isEarHashed(ear, minX, minY, invSize) : isEar(ear)) {\n            triangles.push(prev.i, ear.i, next.i); // cut off the triangle\n\n            removeNode(ear);\n\n            // skipping the next vertex leads to less sliver triangles\n            ear = next.next;\n            stop = next.next;\n\n            continue;\n        }\n\n        ear = next;\n\n        // if we looped through the whole remaining polygon and can't find any more ears\n        if (ear === stop) {\n            // try filtering points and slicing again\n            if (!pass) {\n                earcutLinked(filterPoints(ear), triangles, dim, minX, minY, invSize, 1);\n\n            // if this didn't work, try curing all small self-intersections locally\n            } else if (pass === 1) {\n                ear = cureLocalIntersections(filterPoints(ear), triangles);\n                earcutLinked(ear, triangles, dim, minX, minY, invSize, 2);\n\n            // as a last resort, try splitting the remaining polygon into two\n            } else if (pass === 2) {\n                splitEarcut(ear, triangles, dim, minX, minY, invSize);\n            }\n\n            break;\n        }\n    }\n}\n\n// check whether a polygon node forms a valid ear with adjacent nodes\nfunction isEar(ear) {\n    const a = ear.prev,\n        b = ear,\n        c = ear.next;\n\n    if (area(a, b, c) >= 0) return false; // reflex, can't be an ear\n\n    // now make sure we don't have other points inside the potential ear\n    const ax = a.x, bx = b.x, cx = c.x, ay = a.y, by = b.y, cy = c.y;\n\n    // triangle bbox\n    const x0 = Math.min(ax, bx, cx),\n        y0 = Math.min(ay, by, cy),\n        x1 = Math.max(ax, bx, cx),\n        y1 = Math.max(ay, by, cy);\n\n    let p = c.next;\n    while (p !== a) {\n        if (p.x >= x0 && p.x <= x1 && p.y >= y0 && p.y <= y1 &&\n            pointInTriangleExceptFirst(ax, ay, bx, by, cx, cy, p.x, p.y) &&\n            area(p.prev, p, p.next) >= 0) return false;\n        p = p.next;\n    }\n\n    return true;\n}\n\nfunction isEarHashed(ear, minX, minY, invSize) {\n    const a = ear.prev,\n        b = ear,\n        c = ear.next;\n\n    if (area(a, b, c) >= 0) return false; // reflex, can't be an ear\n\n    const ax = a.x, bx = b.x, cx = c.x, ay = a.y, by = b.y, cy = c.y;\n\n    // triangle bbox\n    const x0 = Math.min(ax, bx, cx),\n        y0 = Math.min(ay, by, cy),\n        x1 = Math.max(ax, bx, cx),\n        y1 = Math.max(ay, by, cy);\n\n    // z-order range for the current triangle bbox;\n    const minZ = zOrder(x0, y0, minX, minY, invSize),\n        maxZ = zOrder(x1, y1, minX, minY, invSize);\n\n    let p = ear.prevZ,\n        n = ear.nextZ;\n\n    // look for points inside the triangle in both directions\n    while (p && p.z >= minZ && n && n.z <= maxZ) {\n        if (p.x >= x0 && p.x <= x1 && p.y >= y0 && p.y <= y1 && p !== a && p !== c &&\n            pointInTriangleExceptFirst(ax, ay, bx, by, cx, cy, p.x, p.y) && area(p.prev, p, p.next) >= 0) return false;\n        p = p.prevZ;\n\n        if (n.x >= x0 && n.x <= x1 && n.y >= y0 && n.y <= y1 && n !== a && n !== c &&\n            pointInTriangleExceptFirst(ax, ay, bx, by, cx, cy, n.x, n.y) && area(n.prev, n, n.next) >= 0) return false;\n        n = n.nextZ;\n    }\n\n    // look for remaining points in decreasing z-order\n    while (p && p.z >= minZ) {\n        if (p.x >= x0 && p.x <= x1 && p.y >= y0 && p.y <= y1 && p !== a && p !== c &&\n            pointInTriangleExceptFirst(ax, ay, bx, by, cx, cy, p.x, p.y) && area(p.prev, p, p.next) >= 0) return false;\n        p = p.prevZ;\n    }\n\n    // look for remaining points in increasing z-order\n    while (n && n.z <= maxZ) {\n        if (n.x >= x0 && n.x <= x1 && n.y >= y0 && n.y <= y1 && n !== a && n !== c &&\n            pointInTriangleExceptFirst(ax, ay, bx, by, cx, cy, n.x, n.y) && area(n.prev, n, n.next) >= 0) return false;\n        n = n.nextZ;\n    }\n\n    return true;\n}\n\n// go through all polygon nodes and cure small local self-intersections\nfunction cureLocalIntersections(start, triangles) {\n    let p = start;\n    do {\n        const a = p.prev,\n            b = p.next.next;\n\n        if (!equals(a, b) && intersects(a, p, p.next, b) && locallyInside(a, b) && locallyInside(b, a)) {\n\n            triangles.push(a.i, p.i, b.i);\n\n            // remove two nodes involved\n            removeNode(p);\n            removeNode(p.next);\n\n            p = start = b;\n        }\n        p = p.next;\n    } while (p !== start);\n\n    return filterPoints(p);\n}\n\n// try splitting polygon into two and triangulate them independently\nfunction splitEarcut(start, triangles, dim, minX, minY, invSize) {\n    // look for a valid diagonal that divides the polygon into two\n    let a = start;\n    do {\n        let b = a.next.next;\n        while (b !== a.prev) {\n            if (a.i !== b.i && isValidDiagonal(a, b)) {\n                // split the polygon in two by the diagonal\n                let c = splitPolygon(a, b);\n\n                // filter colinear points around the cuts\n                a = filterPoints(a, a.next);\n                c = filterPoints(c, c.next);\n\n                // run earcut on each half\n                earcutLinked(a, triangles, dim, minX, minY, invSize, 0);\n                earcutLinked(c, triangles, dim, minX, minY, invSize, 0);\n                return;\n            }\n            b = b.next;\n        }\n        a = a.next;\n    } while (a !== start);\n}\n\n// link every hole into the outer loop, producing a single-ring polygon without holes\nfunction eliminateHoles(data, holeIndices, outerNode, dim) {\n    const queue = [];\n\n    for (let i = 0, len = holeIndices.length; i < len; i++) {\n        const start = holeIndices[i] * dim;\n        const end = i < len - 1 ? holeIndices[i + 1] * dim : data.length;\n        const list = linkedList(data, start, end, dim, false);\n        if (list === list.next) list.steiner = true;\n        queue.push(getLeftmost(list));\n    }\n\n    queue.sort(compareXYSlope);\n\n    // process holes from left to right\n    for (let i = 0; i < queue.length; i++) {\n        outerNode = eliminateHole(queue[i], outerNode);\n    }\n\n    return outerNode;\n}\n\nfunction compareXYSlope(a, b) {\n    let result = a.x - b.x;\n    // when the left-most point of 2 holes meet at a vertex, sort the holes counterclockwise so that when we find\n    // the bridge to the outer shell is always the point that they meet at.\n    if (result === 0) {\n        result = a.y - b.y;\n        if (result === 0) {\n            const aSlope = (a.next.y - a.y) / (a.next.x - a.x);\n            const bSlope = (b.next.y - b.y) / (b.next.x - b.x);\n            result = aSlope - bSlope;\n        }\n    }\n    return result;\n}\n\n// find a bridge between vertices that connects hole with an outer ring and link it\nfunction eliminateHole(hole, outerNode) {\n    const bridge = findHoleBridge(hole, outerNode);\n    if (!bridge) {\n        return outerNode;\n    }\n\n    const bridgeReverse = splitPolygon(bridge, hole);\n\n    // filter collinear points around the cuts\n    filterPoints(bridgeReverse, bridgeReverse.next);\n    return filterPoints(bridge, bridge.next);\n}\n\n// David Eberly's algorithm for finding a bridge between hole and outer polygon\nfunction findHoleBridge(hole, outerNode) {\n    let p = outerNode;\n    const hx = hole.x;\n    const hy = hole.y;\n    let qx = -Infinity;\n    let m;\n\n    // find a segment intersected by a ray from the hole's leftmost point to the left;\n    // segment's endpoint with lesser x will be potential connection point\n    // unless they intersect at a vertex, then choose the vertex\n    if (equals(hole, p)) return p;\n    do {\n        if (equals(hole, p.next)) return p.next;\n        else if (hy <= p.y && hy >= p.next.y && p.next.y !== p.y) {\n            const x = p.x + (hy - p.y) * (p.next.x - p.x) / (p.next.y - p.y);\n            if (x <= hx && x > qx) {\n                qx = x;\n                m = p.x < p.next.x ? p : p.next;\n                if (x === hx) return m; // hole touches outer segment; pick leftmost endpoint\n            }\n        }\n        p = p.next;\n    } while (p !== outerNode);\n\n    if (!m) return null;\n\n    // look for points inside the triangle of hole point, segment intersection and endpoint;\n    // if there are no points found, we have a valid connection;\n    // otherwise choose the point of the minimum angle with the ray as connection point\n\n    const stop = m;\n    const mx = m.x;\n    const my = m.y;\n    let tanMin = Infinity;\n\n    p = m;\n\n    do {\n        if (hx >= p.x && p.x >= mx && hx !== p.x &&\n                pointInTriangle(hy < my ? hx : qx, hy, mx, my, hy < my ? qx : hx, hy, p.x, p.y)) {\n\n            const tan = Math.abs(hy - p.y) / (hx - p.x); // tangential\n\n            if (locallyInside(p, hole) &&\n                (tan < tanMin || (tan === tanMin && (p.x > m.x || (p.x === m.x && sectorContainsSector(m, p)))))) {\n                m = p;\n                tanMin = tan;\n            }\n        }\n\n        p = p.next;\n    } while (p !== stop);\n\n    return m;\n}\n\n// whether sector in vertex m contains sector in vertex p in the same coordinates\nfunction sectorContainsSector(m, p) {\n    return area(m.prev, m, p.prev) < 0 && area(p.next, m, m.next) < 0;\n}\n\n// interlink polygon nodes in z-order\nfunction indexCurve(start, minX, minY, invSize) {\n    let p = start;\n    do {\n        if (p.z === 0) p.z = zOrder(p.x, p.y, minX, minY, invSize);\n        p.prevZ = p.prev;\n        p.nextZ = p.next;\n        p = p.next;\n    } while (p !== start);\n\n    p.prevZ.nextZ = null;\n    p.prevZ = null;\n\n    sortLinked(p);\n}\n\n// Simon Tatham's linked list merge sort algorithm\n// http://www.chiark.greenend.org.uk/~sgtatham/algorithms/listsort.html\nfunction sortLinked(list) {\n    let numMerges;\n    let inSize = 1;\n\n    do {\n        let p = list;\n        let e;\n        list = null;\n        let tail = null;\n        numMerges = 0;\n\n        while (p) {\n            numMerges++;\n            let q = p;\n            let pSize = 0;\n            for (let i = 0; i < inSize; i++) {\n                pSize++;\n                q = q.nextZ;\n                if (!q) break;\n            }\n            let qSize = inSize;\n\n            while (pSize > 0 || (qSize > 0 && q)) {\n\n                if (pSize !== 0 && (qSize === 0 || !q || p.z <= q.z)) {\n                    e = p;\n                    p = p.nextZ;\n                    pSize--;\n                } else {\n                    e = q;\n                    q = q.nextZ;\n                    qSize--;\n                }\n\n                if (tail) tail.nextZ = e;\n                else list = e;\n\n                e.prevZ = tail;\n                tail = e;\n            }\n\n            p = q;\n        }\n\n        tail.nextZ = null;\n        inSize *= 2;\n\n    } while (numMerges > 1);\n\n    return list;\n}\n\n// z-order of a point given coords and inverse of the longer side of data bbox\nfunction zOrder(x, y, minX, minY, invSize) {\n    // coords are transformed into non-negative 15-bit integer range\n    x = (x - minX) * invSize | 0;\n    y = (y - minY) * invSize | 0;\n\n    x = (x | (x << 8)) & 0x00FF00FF;\n    x = (x | (x << 4)) & 0x0F0F0F0F;\n    x = (x | (x << 2)) & 0x33333333;\n    x = (x | (x << 1)) & 0x55555555;\n\n    y = (y | (y << 8)) & 0x00FF00FF;\n    y = (y | (y << 4)) & 0x0F0F0F0F;\n    y = (y | (y << 2)) & 0x33333333;\n    y = (y | (y << 1)) & 0x55555555;\n\n    return x | (y << 1);\n}\n\n// find the leftmost node of a polygon ring\nfunction getLeftmost(start) {\n    let p = start,\n        leftmost = start;\n    do {\n        if (p.x < leftmost.x || (p.x === leftmost.x && p.y < leftmost.y)) leftmost = p;\n        p = p.next;\n    } while (p !== start);\n\n    return leftmost;\n}\n\n// check if a point lies within a convex triangle\nfunction pointInTriangle(ax, ay, bx, by, cx, cy, px, py) {\n    return (cx - px) * (ay - py) >= (ax - px) * (cy - py) &&\n           (ax - px) * (by - py) >= (bx - px) * (ay - py) &&\n           (bx - px) * (cy - py) >= (cx - px) * (by - py);\n}\n\n// check if a point lies within a convex triangle but false if its equal to the first point of the triangle\nfunction pointInTriangleExceptFirst(ax, ay, bx, by, cx, cy, px, py) {\n    return !(ax === px && ay === py) && pointInTriangle(ax, ay, bx, by, cx, cy, px, py);\n}\n\n// check if a diagonal between two polygon nodes is valid (lies in polygon interior)\nfunction isValidDiagonal(a, b) {\n    return a.next.i !== b.i && a.prev.i !== b.i && !intersectsPolygon(a, b) && // doesn't intersect other edges\n           (locallyInside(a, b) && locallyInside(b, a) && middleInside(a, b) && // locally visible\n            (area(a.prev, a, b.prev) || area(a, b.prev, b)) || // does not create opposite-facing sectors\n            equals(a, b) && area(a.prev, a, a.next) > 0 && area(b.prev, b, b.next) > 0); // special zero-length case\n}\n\n// signed area of a triangle\nfunction area(p, q, r) {\n    return (q.y - p.y) * (r.x - q.x) - (q.x - p.x) * (r.y - q.y);\n}\n\n// check if two points are equal\nfunction equals(p1, p2) {\n    return p1.x === p2.x && p1.y === p2.y;\n}\n\n// check if two segments intersect\nfunction intersects(p1, q1, p2, q2) {\n    const o1 = sign(area(p1, q1, p2));\n    const o2 = sign(area(p1, q1, q2));\n    const o3 = sign(area(p2, q2, p1));\n    const o4 = sign(area(p2, q2, q1));\n\n    if (o1 !== o2 && o3 !== o4) return true; // general case\n\n    if (o1 === 0 && onSegment(p1, p2, q1)) return true; // p1, q1 and p2 are collinear and p2 lies on p1q1\n    if (o2 === 0 && onSegment(p1, q2, q1)) return true; // p1, q1 and q2 are collinear and q2 lies on p1q1\n    if (o3 === 0 && onSegment(p2, p1, q2)) return true; // p2, q2 and p1 are collinear and p1 lies on p2q2\n    if (o4 === 0 && onSegment(p2, q1, q2)) return true; // p2, q2 and q1 are collinear and q1 lies on p2q2\n\n    return false;\n}\n\n// for collinear points p, q, r, check if point q lies on segment pr\nfunction onSegment(p, q, r) {\n    return q.x <= Math.max(p.x, r.x) && q.x >= Math.min(p.x, r.x) && q.y <= Math.max(p.y, r.y) && q.y >= Math.min(p.y, r.y);\n}\n\nfunction sign(num) {\n    return num > 0 ? 1 : num < 0 ? -1 : 0;\n}\n\n// check if a polygon diagonal intersects any polygon segments\nfunction intersectsPolygon(a, b) {\n    let p = a;\n    do {\n        if (p.i !== a.i && p.next.i !== a.i && p.i !== b.i && p.next.i !== b.i &&\n                intersects(p, p.next, a, b)) return true;\n        p = p.next;\n    } while (p !== a);\n\n    return false;\n}\n\n// check if a polygon diagonal is locally inside the polygon\nfunction locallyInside(a, b) {\n    return area(a.prev, a, a.next) < 0 ?\n        area(a, b, a.next) >= 0 && area(a, a.prev, b) >= 0 :\n        area(a, b, a.prev) < 0 || area(a, a.next, b) < 0;\n}\n\n// check if the middle point of a polygon diagonal is inside the polygon\nfunction middleInside(a, b) {\n    let p = a;\n    let inside = false;\n    const px = (a.x + b.x) / 2;\n    const py = (a.y + b.y) / 2;\n    do {\n        if (((p.y > py) !== (p.next.y > py)) && p.next.y !== p.y &&\n                (px < (p.next.x - p.x) * (py - p.y) / (p.next.y - p.y) + p.x))\n            inside = !inside;\n        p = p.next;\n    } while (p !== a);\n\n    return inside;\n}\n\n// link two polygon vertices with a bridge; if the vertices belong to the same ring, it splits polygon into two;\n// if one belongs to the outer ring and another to a hole, it merges it into a single ring\nfunction splitPolygon(a, b) {\n    const a2 = createNode(a.i, a.x, a.y),\n        b2 = createNode(b.i, b.x, b.y),\n        an = a.next,\n        bp = b.prev;\n\n    a.next = b;\n    b.prev = a;\n\n    a2.next = an;\n    an.prev = a2;\n\n    b2.next = a2;\n    a2.prev = b2;\n\n    bp.next = b2;\n    b2.prev = bp;\n\n    return b2;\n}\n\n// create a node and optionally link it with previous one (in a circular doubly linked list)\nfunction insertNode(i, x, y, last) {\n    const p = createNode(i, x, y);\n\n    if (!last) {\n        p.prev = p;\n        p.next = p;\n\n    } else {\n        p.next = last.next;\n        p.prev = last;\n        last.next.prev = p;\n        last.next = p;\n    }\n    return p;\n}\n\nfunction removeNode(p) {\n    p.next.prev = p.prev;\n    p.prev.next = p.next;\n\n    if (p.prevZ) p.prevZ.nextZ = p.nextZ;\n    if (p.nextZ) p.nextZ.prevZ = p.prevZ;\n}\n\nfunction createNode(i, x, y) {\n    return {\n        i, // vertex index in coordinates array\n        x, y, // vertex coordinates\n        prev: null, // previous and next vertex nodes in a polygon ring\n        next: null,\n        z: 0, // z-order curve value\n        prevZ: null, // previous and next nodes in z-order\n        nextZ: null,\n        steiner: false // indicates whether this is a steiner point\n    };\n}\n\n// return a percentage difference between the polygon area and its triangulation area;\n// used to verify correctness of triangulation\nexport function deviation(data, holeIndices, dim, triangles) {\n    const hasHoles = holeIndices && holeIndices.length;\n    const outerLen = hasHoles ? holeIndices[0] * dim : data.length;\n\n    let polygonArea = Math.abs(signedArea(data, 0, outerLen, dim));\n    if (hasHoles) {\n        for (let i = 0, len = holeIndices.length; i < len; i++) {\n            const start = holeIndices[i] * dim;\n            const end = i < len - 1 ? holeIndices[i + 1] * dim : data.length;\n            polygonArea -= Math.abs(signedArea(data, start, end, dim));\n        }\n    }\n\n    let trianglesArea = 0;\n    for (let i = 0; i < triangles.length; i += 3) {\n        const a = triangles[i] * dim;\n        const b = triangles[i + 1] * dim;\n        const c = triangles[i + 2] * dim;\n        trianglesArea += Math.abs(\n            (data[a] - data[c]) * (data[b + 1] - data[a + 1]) -\n            (data[a] - data[b]) * (data[c + 1] - data[a + 1]));\n    }\n\n    return polygonArea === 0 && trianglesArea === 0 ? 0 :\n        Math.abs((trianglesArea - polygonArea) / polygonArea);\n}\n\nfunction signedArea(data, start, end, dim) {\n    let sum = 0;\n    for (let i = start, j = end - dim; i < end; i += dim) {\n        sum += (data[j] - data[i]) * (data[i + 1] + data[j + 1]);\n        j = i;\n    }\n    return sum;\n}\n\n// turn a polygon in a multi-dimensional array form (e.g. as in GeoJSON) into a form Earcut accepts\nexport function flatten(data) {\n    const vertices = [];\n    const holes = [];\n    const dimensions = data[0][0].length;\n    let holeIndex = 0;\n    let prevLen = 0;\n\n    for (const ring of data) {\n        for (const p of ring) {\n            for (let d = 0; d < dimensions; d++) vertices.push(p[d]);\n        }\n        if (prevLen) {\n            holeIndex += prevLen;\n            holes.push(holeIndex);\n        }\n        prevLen = ring.length;\n    }\n    return {vertices, holes, dimensions};\n}\n","/**\n * Building Color System (Shared between main thread and workers)\n *\n * This module provides deterministic color selection for buildings based on\n * Overture Maps properties. It uses a seeded random number generator to ensure\n * the same building always gets the same color.\n *\n * NOTE: This module must NOT import Three.js to remain usable in workers.\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface BuildingColorInput {\n  type: string;\n  coordinates: number[][][] | number[][][][];\n  properties?: {\n    id?: string | number;\n    building_id?: string; // For building parts - parent building ID\n    subtype?: string;\n    class?: string;\n    [key: string]: unknown;\n  };\n}\n\ninterface ColorPalette {\n  walls: number[];\n}\n\n// ============================================================================\n// Color Palettes by Building Category\n// ============================================================================\n\n/**\n * Predefined wall color palettes for different building categories\n * Colors are hex values (e.g., 0xE8DCC8)\n */\nexport const BUILDING_PALETTES: Record<string, ColorPalette> = {\n  // Residential colors - warmer, more varied\n  residential: {\n    walls: [\n      0xe8dcc8, // cream/beige\n      0xd4c4a8, // tan\n      0xb8a082, // brownish beige\n      0xc9b896, // warm gray-beige\n      0xe5d5c0, // off-white\n      0xa89070, // brown\n      0x8b7355, // dark tan\n      0xcd853f, // peru/terracotta\n      0xbc8f8f, // rosy brown\n      0xf5deb3, // wheat\n    ],\n  },\n\n  // Commercial/office - modern, glass-heavy\n  commercial: {\n    walls: [\n      0x708090, // slate gray\n      0x778899, // light slate gray\n      0xa9a9a9, // dark gray\n      0xc0c0c0, // silver\n      0xd3d3d3, // light gray\n      0x5a7a8a, // muted steel blue\n      0x5a7d7e, // muted cadet blue\n      0x7a9aaa, // muted blue-gray (glass effect)\n      0x8a9cac, // muted steel blue\n      0xa0b0b8, // muted blue-gray\n    ],\n  },\n\n  // Industrial - utilitarian colors\n  industrial: {\n    walls: [\n      0x696969, // dim gray\n      0x808080, // gray\n      0xa9a9a9, // dark gray\n      0x708090, // slate gray\n      0x4a5568, // cool gray\n      0x5c5c5c, // charcoal\n      0x6b7280, // gray 500\n      0x9ca3af, // gray 400\n      0xc4b998, // tan industrial\n      0xd4c4a8, // beige industrial\n    ],\n  },\n\n  // Civic/government - dignified, classic\n  civic: {\n    walls: [\n      0xd3d3d3, // light gray\n      0xc0c0c0, // silver\n      0xe8e0d0, // warm beige\n      0xe5dcd0, // muted linen\n      0xe8e4dc, // off-white\n      0xd0d0d8, // muted gray with slight warmth\n      0xe0e0e0, // light gray\n      0xbdb76b, // dark khaki\n      0xd2b48c, // tan\n      0xbc8f8f, // rosy brown\n    ],\n  },\n\n  // Religious - varied based on tradition\n  religious: {\n    walls: [\n      0xf0ebe0, // muted off-white\n      0xe8e0d5, // muted linen\n      0xd2b48c, // tan\n      0xdeb887, // burlywood\n      0xbc8f8f, // rosy brown\n      0xe8e4d8, // muted beige\n      0xd8d4cc, // warm gray\n      0xd4c4a8, // warm beige\n      0x8b4513, // saddle brown\n      0xcd853f, // peru\n    ],\n  },\n\n  // Education - institutional\n  education: {\n    walls: [\n      0xcd853f, // peru (brick-like)\n      0xa0522d, // sienna\n      0xd2691e, // chocolate\n      0x8b4513, // saddle brown\n      0xd2b48c, // tan\n      0xdeb887, // burlywood\n      0xc0c0c0, // silver\n      0xa9a9a9, // dark gray\n      0xbc8f8f, // rosy brown\n      0xf4a460, // sandy brown\n    ],\n  },\n\n  // Medical - clean, clinical\n  medical: {\n    walls: [\n      0xf8f8f8, // near white\n      0xf0f0f0, // white smoke\n      0xe8e8e8, // light gray\n      0xe0e0e0, // light gray\n      0xf5f5f5, // near white\n      0xececec, // light gray\n      0xd8e0e0, // muted blue-gray\n      0xc8d0d4, // muted gray-blue\n      0xb8c4c8, // muted steel\n      0xa0b0b8, // muted blue-gray\n    ],\n  },\n\n  // Agricultural - rustic\n  agricultural: {\n    walls: [\n      0x8b4513, // saddle brown\n      0xa0522d, // sienna\n      0xcd853f, // peru\n      0xd2691e, // chocolate\n      0x7b3f00, // chocolate brown (barn)\n      0x8b5a2b, // tan brown (barn)\n      0xdeb887, // burlywood\n      0xd2b48c, // tan\n      0x6b8e23, // olive drab\n      0x808000, // olive\n    ],\n  },\n\n  // Entertainment - venues, theaters, arenas\n  entertainment: {\n    walls: [\n      0x4a4a4a, // dark gray\n      0x2f4f4f, // dark slate gray\n      0x3d3d5c, // muted dark blue-gray\n      0x4a4a5a, // neutral dark gray-blue\n      0x5a5a5a, // medium dark gray\n      0x3c3c3c, // charcoal\n      0x2f3f4f, // dark slate\n      0x1c1c1c, // near black\n      0xc0c0c0, // silver\n      0x708090, // slate gray\n    ],\n  },\n\n  // Military - utilitarian, secure\n  military: {\n    walls: [\n      0x556b2f, // dark olive green\n      0x6b8e23, // olive drab\n      0x808000, // olive\n      0x8b8b00, // dark khaki\n      0x696969, // dim gray\n      0x4a5568, // cool gray\n      0x5f5f5f, // charcoal\n      0xa0522d, // sienna\n      0x8b7355, // dark tan\n      0x808080, // gray\n    ],\n  },\n\n  // Outbuilding - small auxiliary structures\n  outbuilding: {\n    walls: [\n      0x8b4513, // saddle brown\n      0xa0522d, // sienna\n      0x696969, // dim gray\n      0x808080, // gray\n      0xd2b48c, // tan\n      0xdeb887, // burlywood\n      0x6b8e23, // olive drab\n      0x8a9a9a, // muted steel (metal shed)\n      0xa8a8a8, // muted silver (metal shed)\n      0x708090, // slate gray\n    ],\n  },\n\n  // Service - utility buildings\n  service: {\n    walls: [\n      0x708090, // slate gray\n      0x808080, // gray\n      0xa9a9a9, // dark gray\n      0x8a9aa8, // muted steel blue\n      0xb0b0b0, // muted silver\n      0xc8c8c8, // light gray\n      0x4a5568, // cool gray\n      0x6b7280, // gray 500\n      0xd8d8d8, // gray 200\n      0xe0e0e0, // gray 100\n    ],\n  },\n\n  // Transportation - stations, terminals\n  transportation: {\n    walls: [\n      0x708090, // slate gray\n      0x778899, // light slate gray\n      0xb0b0b0, // muted silver\n      0xc8c8c8, // light gray\n      0x5a7a8a, // muted steel blue\n      0x5a7d7e, // muted cadet blue\n      0x7a9aaa, // muted blue-gray (glass)\n      0x8a9cac, // muted steel blue\n      0xd8d8d8, // light gray\n      0xe0d8d0, // muted linen\n    ],\n  },\n\n  // Default/unknown - neutral\n  default: {\n    walls: [\n      0x808080, // gray\n      0x909090, // light gray\n      0xa0a0a0, // lighter gray\n      0xb0b0b0, // even lighter\n      0x888899, // blue-gray\n      0x989898, // neutral gray\n      0xa8a8a8, // medium gray\n      0xc0c0c0, // silver\n      0x778899, // light slate gray\n      0x708090, // slate gray\n    ],\n  },\n};\n\n// ============================================================================\n// Building Class to Category Mapping\n// ============================================================================\n\n/**\n * Map Overture building classes to palette categories\n */\nexport const CLASS_TO_CATEGORY: Record<string, string> = {\n  // Residential\n  house: 'residential',\n  residential: 'residential',\n  detached: 'residential',\n  semi: 'residential',\n  semidetached_house: 'residential',\n  terrace: 'residential',\n  apartments: 'residential',\n  bungalow: 'residential',\n  dwelling_house: 'residential',\n  stilt_house: 'residential',\n  trullo: 'residential',\n  cabin: 'residential',\n  houseboat: 'residential',\n  static_caravan: 'residential',\n  ger: 'residential',\n  hut: 'residential',\n  beach_hut: 'residential',\n  allotment_house: 'residential',\n  dormitory: 'residential',\n  garage: 'residential',\n  garages: 'residential',\n  carport: 'residential',\n  boathouse: 'residential',\n\n  // Commercial\n  commercial: 'commercial',\n  office: 'commercial',\n  retail: 'commercial',\n  supermarket: 'commercial',\n  hotel: 'commercial',\n  kiosk: 'commercial',\n  parking: 'commercial',\n\n  // Industrial\n  industrial: 'industrial',\n  warehouse: 'industrial',\n  factory: 'industrial',\n  manufacture: 'industrial',\n  hangar: 'industrial',\n  storage_tank: 'industrial',\n  silo: 'industrial',\n  slurry_tank: 'industrial',\n  digester: 'industrial',\n  transformer_tower: 'industrial',\n  roof: 'industrial',\n  bridge_structure: 'industrial',\n\n  // Civic/Government\n  civic: 'civic',\n  public: 'civic',\n  government: 'civic',\n  fire_station: 'civic',\n  post_office: 'civic',\n  library: 'civic',\n  toilets: 'civic',\n  guardhouse: 'civic',\n  stadium: 'civic',\n  sports_centre: 'civic',\n  sports_hall: 'civic',\n  grandstand: 'civic',\n  pavilion: 'civic',\n\n  // Religious\n  religious: 'religious',\n  church: 'religious',\n  chapel: 'religious',\n  cathedral: 'religious',\n  mosque: 'religious',\n  temple: 'religious',\n  synagogue: 'religious',\n  shrine: 'religious',\n  wayside_shrine: 'religious',\n  monastery: 'religious',\n  presbytery: 'religious',\n\n  // Education\n  school: 'education',\n  university: 'education',\n  college: 'education',\n  kindergarten: 'education',\n\n  // Medical\n  hospital: 'medical',\n\n  // Agricultural\n  agricultural: 'agricultural',\n  farm: 'agricultural',\n  barn: 'agricultural',\n  farm_auxiliary: 'agricultural',\n  cowshed: 'agricultural',\n  stable: 'agricultural',\n  sty: 'agricultural',\n  greenhouse: 'agricultural',\n  glasshouse: 'agricultural',\n\n  // Military\n  military: 'military',\n  bunker: 'military',\n\n  // Outbuilding\n  outbuilding: 'outbuilding',\n  shed: 'outbuilding',\n\n  // Service\n  service: 'service',\n\n  // Transportation\n  transportation: 'transportation',\n  train_station: 'transportation',\n};\n\n/**\n * Valid Overture subtypes that map directly to palette categories\n */\nexport const OVERTURE_SUBTYPES = new Set<string>([\n  'agricultural',\n  'civic',\n  'commercial',\n  'education',\n  'entertainment',\n  'industrial',\n  'medical',\n  'military',\n  'outbuilding',\n  'religious',\n  'residential',\n  'service',\n  'transportation',\n]);\n\n// ============================================================================\n// Seeded Random Number Generator\n// ============================================================================\n\n/**\n * Simple seeded random number generator for deterministic results\n * Uses mulberry32 algorithm\n */\nfunction seededRandom(seed: number): () => number {\n  return function (): number {\n    let t = (seed += 0x6d2b79f5);\n    t = Math.imul(t ^ (t >>> 15), t | 1);\n    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);\n    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;\n  };\n}\n\n/**\n * Generate a deterministic seed from feature properties\n * For building parts, uses building_id (parent) so all parts share the same color\n * For main buildings, uses their own id\n * Falls back to coordinates if no id available\n */\nfunction generateSeed(feature: BuildingColorInput): number {\n  const props = feature.properties;\n\n  // For building parts, use building_id so all parts of the same building share color\n  // This prevents z-fighting artifacts from being visible (same color = invisible flicker)\n  if (props?.building_id !== undefined) {\n    let hash = 0;\n    const str = String(props.building_id);\n    for (let i = 0; i < str.length; i++) {\n      hash = (hash << 5) - hash + str.charCodeAt(i);\n      hash = hash & hash;\n    }\n    return Math.abs(hash);\n  }\n\n  // Use Overture id property if available (for main buildings)\n  if (props?.id !== undefined) {\n    let hash = 0;\n    const str = String(props.id);\n    for (let i = 0; i < str.length; i++) {\n      hash = (hash << 5) - hash + str.charCodeAt(i);\n      hash = hash & hash;\n    }\n    return Math.abs(hash);\n  }\n\n  // Fallback: use first coordinate as seed (deterministic)\n  if (feature.coordinates) {\n    const coords =\n      feature.type === 'MultiPolygon'\n        ? (feature.coordinates as number[][][][])[0][0][0]\n        : (feature.coordinates as number[][][])[0][0];\n    if (coords && coords.length >= 2) {\n      return Math.abs(Math.floor(coords[0] * 1000000 + coords[1] * 1000));\n    }\n  }\n\n  // Final fallback: use a fixed seed for consistency\n  return 42;\n}\n\n// ============================================================================\n// Color Selection Functions\n// ============================================================================\n\n/**\n * Get the building category based on Overture properties\n *\n * Priority order:\n * 1. Overture subtype (direct category mapping)\n * 2. Overture class (lookup in CLASS_TO_CATEGORY)\n * 3. Default category\n */\nexport function getBuildingCategory(feature: BuildingColorInput): string {\n  const props = feature.properties;\n  if (!props) {\n    return 'default';\n  }\n\n  // Priority 1: Overture subtype (normalized category)\n  const subtype = props.subtype;\n  if (subtype) {\n    const subtypeLower = String(subtype).toLowerCase();\n    if (OVERTURE_SUBTYPES.has(subtypeLower)) {\n      return subtypeLower;\n    }\n  }\n\n  // Priority 2: Overture class (specific building type)\n  const buildingClass = props.class;\n  if (buildingClass) {\n    const classLower = String(buildingClass).toLowerCase();\n    if (CLASS_TO_CATEGORY[classLower]) {\n      return CLASS_TO_CATEGORY[classLower];\n    }\n  }\n\n  // Priority 3: Default fallback\n  return 'default';\n}\n\n/**\n * Get a deterministic color for a building feature\n * Uses seeded random to select from the category's palette\n *\n * @param feature - Building feature with Overture properties\n * @returns Hex color value (e.g., 0xE8DCC8)\n */\nexport function getBuildingColor(feature: BuildingColorInput): number {\n  const category = getBuildingCategory(feature);\n  const palette = BUILDING_PALETTES[category] || BUILDING_PALETTES.default;\n\n  const seed = generateSeed(feature);\n  const rng = seededRandom(seed);\n\n  const wallColorIndex = Math.floor(rng() * palette.walls.length);\n  return palette.walls[wallColorIndex];\n}\n","/**\n * Building geometry builder for web workers\n * Creates 3D building geometry without Three.js ExtrudeGeometry dependency\n * Uses earcut for polygon triangulation (roof) and manual wall quad generation\n *\n * Known trade-offs vs main thread implementation:\n * - Material uniformity: All buildings share the same vertexColorMaterial properties\n *   (roughness=0.75, metalness=0.1). Main thread can use category-specific materials.\n *   Color variation is preserved via vertex colors from the shared palette.\n * - Data transfer: Feature data is structured-cloned to worker. For tiles with many\n *   buildings, this can cause brief main thread overhead before worker processing begins.\n * - Floating origin: Geometry is generated relative to the scene origin at request time.\n *   If origin shifts during async processing, geometry may be slightly misaligned.\n *   This is acceptable for typical flight sim movement speeds.\n */\n\nimport earcut from 'earcut';\nimport type {\n  SceneOrigin,\n  BuildingFeatureInput,\n  CreateBuildingGeometryPayload,\n  CreateBuildingGeometryResult,\n  BuildingGeometryBuffers,\n} from './types.js';\nimport { getBuildingColor as getColor } from '../building-colors.js';\n\n// LOD level (must match buildings.ts) - used for skipping small buildings and holes at far distances\nconst LOD_LOW = 2;\n\nconst BUILDING_TERRAIN_OFFSET = 0.5;\nconst SLOPE_COMPENSATION_FACTOR = 0.3;\nconst MIN_BUILDING_AREA_FAR = 50; // m^2\n\n/**\n * Convert geographic coordinates to world coordinates\n */\nfunction geoToWorld(\n  lng: number,\n  lat: number,\n  altitude: number,\n  origin: SceneOrigin\n): { x: number; y: number; z: number } {\n  const x = (lng - origin.lng) * origin.metersPerDegLng;\n  const z = -(lat - origin.lat) * origin.metersPerDegLat;\n  const y = altitude;\n  return { x, y, z };\n}\n\n/**\n * Calculate signed area of a 2D polygon\n * Positive = clockwise, Negative = counter-clockwise\n */\nfunction calculatePolygonArea(points: { x: number; z: number }[]): number {\n  let area = 0;\n  for (let i = 0, j = points.length - 1; i < points.length; j = i++) {\n    area += (points[j].x + points[i].x) * (points[j].z - points[i].z);\n  }\n  return area / 2;\n}\n\n/**\n * Get building height from properties\n */\nfunction getBuildingHeight(\n  properties: BuildingFeatureInput['properties'],\n  defaultHeight: number\n): number {\n  // Try explicit height first\n  if (typeof properties.height === 'number' && properties.height > 0) {\n    return properties.height;\n  }\n\n  // Calculate from floors (3m per floor is typical)\n  if (typeof properties.num_floors === 'number' && properties.num_floors > 0) {\n    return properties.num_floors * 3;\n  }\n\n  return defaultHeight;\n}\n\n/**\n * Get building color from feature using shared color logic\n * Uses deterministic seeded random for consistent colors\n */\nfunction getBuildingColor(feature: BuildingFeatureInput): number {\n  return getColor({\n    type: feature.type,\n    coordinates: feature.coordinates,\n    properties: feature.properties,\n  });\n}\n\n/**\n * Generate building geometry for a single polygon\n * Returns null for invalid/too-small geometries\n */\nfunction generateBuildingGeometry(\n  coordinates: number[][][],\n  height: number,\n  minHeight: number,\n  color: number,\n  lodLevel: number,\n  terrainHeight: number,\n  terrainSlope: number,\n  verticalExaggeration: number,\n  origin: SceneOrigin\n): {\n  positions: number[];\n  normals: number[];\n  colors: number[];\n  indices: number[];\n} | null {\n  if (!coordinates || coordinates.length === 0) return null;\n\n  const outerRing = coordinates[0];\n  if (!outerRing || outerRing.length < 3) return null;\n\n  // Convert to world coordinates\n  // Main thread uses Vector2(world.x, -world.z) then rotateX(-PI/2) which gives final z = world.z\n  // Worker builds geometry directly in 3D, so we use world.z directly (no rotation step)\n  let points: { x: number; z: number }[] = [];\n  for (const coord of outerRing) {\n    const world = geoToWorld(coord[0], coord[1], 0, origin);\n    points.push({ x: world.x, z: world.z });\n  }\n\n  // Remove duplicate last point if present\n  if (points.length > 1) {\n    const first = points[0];\n    const last = points[points.length - 1];\n    if (Math.abs(first.x - last.x) < 0.01 && Math.abs(first.z - last.z) < 0.01) {\n      points.pop();\n    }\n  }\n\n  if (points.length < 3) return null;\n\n  // Calculate area\n  const area = calculatePolygonArea(points);\n  if (Math.abs(area) < 1) return null;\n\n  // Skip small buildings at far distances\n  if (lodLevel === LOD_LOW && Math.abs(area) < MIN_BUILDING_AREA_FAR) {\n    return null;\n  }\n\n  // Simplification disabled - caused visual artifacts (jagged edges)\n  // Modern GPUs handle the extra vertices fine\n\n  if (points.length < 3) return null;\n\n  // Recalculate area\n  const finalArea = calculatePolygonArea(points);\n  if (Math.abs(finalArea) < 1) return null;\n\n  // Ensure counter-clockwise winding (for correct normals when viewed from +Y)\n  // Worker uses z = world.z directly, while main thread uses y = -world.z\n  // This inverts the sign of the shoelace formula, so:\n  // - Main thread: area < 0 means CW, reverse to get CCW\n  // - Worker: area > 0 means CW (opposite sign), reverse to get CCW\n  if (finalArea > 0) {\n    points.reverse();\n  }\n\n  // Calculate base and top Y positions\n  const baseY = terrainHeight * verticalExaggeration + BUILDING_TERRAIN_OFFSET - terrainSlope * SLOPE_COMPENSATION_FACTOR;\n  const topY = baseY + height;\n  const bottomY = baseY + minHeight; // For buildings with min_height (floating bases)\n\n  // Flatten points for earcut (x, z format)\n  const flatCoords: number[] = [];\n  for (const p of points) {\n    flatCoords.push(p.x, p.z);\n  }\n\n  // Process holes (skip for LOW LOD)\n  // Track hole start indices and vertex counts for wall generation\n  const holes: number[] = [];\n  const holeVertexCounts: number[] = [];\n  if (lodLevel !== LOD_LOW && coordinates.length > 1) {\n    for (let i = 1; i < coordinates.length; i++) {\n      const holeRing = coordinates[i];\n      if (!holeRing || holeRing.length < 3) continue;\n\n      holes.push(flatCoords.length / 2); // Start index of hole\n\n      // Use world.z directly (same as outer ring - no rotation in worker)\n      let holePoints: { x: number; z: number }[] = [];\n      for (const coord of holeRing) {\n        const world = geoToWorld(coord[0], coord[1], 0, origin);\n        holePoints.push({ x: world.x, z: world.z });\n      }\n\n      // Remove duplicate last point\n      if (holePoints.length > 1) {\n        const first = holePoints[0];\n        const last = holePoints[holePoints.length - 1];\n        if (Math.abs(first.x - last.x) < 0.01 && Math.abs(first.z - last.z) < 0.01) {\n          holePoints.pop();\n        }\n      }\n\n      // Holes should be clockwise (opposite winding from outer ring which is CCW)\n      // Same sign inversion as outer ring: worker uses z directly, main thread uses -z\n      // So worker reverses when area < 0 (opposite of main thread's > 0 check)\n      const holeArea = calculatePolygonArea(holePoints);\n      if (holeArea < 0) {\n        holePoints.reverse();\n      }\n\n      // Track actual vertex count after processing\n      holeVertexCounts.push(holePoints.length);\n\n      for (const p of holePoints) {\n        flatCoords.push(p.x, p.z);\n      }\n    }\n  }\n\n  // Triangulate roof using earcut\n  const roofIndices = earcut(flatCoords, holes, 2);\n  if (roofIndices.length === 0) return null;\n\n  // Extract vertex positions from flatCoords\n  const vertexCount = flatCoords.length / 2;\n  const roofVertices: { x: number; z: number }[] = [];\n  for (let i = 0; i < vertexCount; i++) {\n    roofVertices.push({\n      x: flatCoords[i * 2],\n      z: flatCoords[i * 2 + 1],\n    });\n  }\n\n  // Build geometry buffers\n  const positions: number[] = [];\n  const normals: number[] = [];\n  const colors: number[] = [];\n  const indices: number[] = [];\n\n  // Extract RGB from hex color\n  const r = ((color >> 16) & 0xff) / 255;\n  const g = ((color >> 8) & 0xff) / 255;\n  const b = (color & 0xff) / 255;\n\n  // === ROOF (top face) ===\n  const roofStartIndex = positions.length / 3;\n  for (const v of roofVertices) {\n    positions.push(v.x, topY, v.z);\n    normals.push(0, 1, 0); // Up\n    colors.push(r, g, b);\n  }\n  // Reverse triangle winding for correct face culling when viewed from above\n  // Earcut produces CCW triangles in 2D (x,z), but Three.js needs them reversed\n  // for front-face visibility when looking down from +Y\n  for (let i = 0; i < roofIndices.length; i += 3) {\n    indices.push(roofStartIndex + roofIndices[i]);\n    indices.push(roofStartIndex + roofIndices[i + 2]);\n    indices.push(roofStartIndex + roofIndices[i + 1]);\n  }\n\n  // === BOTTOM (base face, if minHeight > 0 for floating buildings) ===\n  if (minHeight > 0) {\n    const bottomStartIndex = positions.length / 3;\n    for (const v of roofVertices) {\n      positions.push(v.x, bottomY, v.z);\n      normals.push(0, -1, 0); // Down\n      colors.push(r * 0.7, g * 0.7, b * 0.7); // Darker\n    }\n    // Reverse winding for bottom face\n    for (let i = roofIndices.length - 1; i >= 0; i--) {\n      indices.push(bottomStartIndex + roofIndices[i]);\n    }\n  }\n\n  // === WALLS ===\n  // Use only outer ring points for walls (index 0 to points.length)\n  const outerPointCount = points.length;\n  const wallDarkening = 0.85; // Slightly darker walls\n\n  for (let i = 0; i < outerPointCount; i++) {\n    const p0 = points[i];\n    const p1 = points[(i + 1) % outerPointCount];\n\n    // Calculate wall normal (perpendicular to wall segment)\n    const dx = p1.x - p0.x;\n    const dz = p1.z - p0.z;\n    const len = Math.sqrt(dx * dx + dz * dz);\n    if (len < 0.01) continue; // Skip degenerate segments\n\n    // Normal pointing outward: perpendicular to travel direction, 90째 clockwise\n    // For CCW polygon (when viewed from +Y), this points outward\n    // 90째 clockwise rotation of (dx, dz) is (dz, -dx)\n    const nx = dz / len;\n    const nz = -dx / len;\n\n    const wallStartIndex = positions.length / 3;\n\n    // Four vertices per wall quad: bottom-left, bottom-right, top-right, top-left\n    // Using bottomY for base (or baseY if no minHeight)\n    const wallBaseY = minHeight > 0 ? bottomY : baseY;\n\n    positions.push(p0.x, wallBaseY, p0.z); // 0: bottom-left\n    positions.push(p1.x, wallBaseY, p1.z); // 1: bottom-right\n    positions.push(p1.x, topY, p1.z);      // 2: top-right\n    positions.push(p0.x, topY, p0.z);      // 3: top-left\n\n    for (let j = 0; j < 4; j++) {\n      normals.push(nx, 0, nz);\n      colors.push(r * wallDarkening, g * wallDarkening, b * wallDarkening);\n    }\n\n    // Two triangles with CCW winding when viewed from outside: (0,3,2) and (0,2,1)\n    indices.push(wallStartIndex + 0, wallStartIndex + 3, wallStartIndex + 2);\n    indices.push(wallStartIndex + 0, wallStartIndex + 2, wallStartIndex + 1);\n  }\n\n  // Add walls for holes (only for higher LOD)\n  // Use tracked hole vertex counts from earcut setup (after simplification/dedup)\n  if (lodLevel !== LOD_LOW && holeVertexCounts.length > 0) {\n    let holeStartIdx = outerPointCount;\n    for (let h = 0; h < holeVertexCounts.length; h++) {\n      const holeVertexCount = holeVertexCounts[h];\n\n      for (let i = 0; i < holeVertexCount; i++) {\n        const idx0 = holeStartIdx + i;\n        const idx1 = holeStartIdx + ((i + 1) % holeVertexCount);\n        if (idx0 >= roofVertices.length || idx1 >= roofVertices.length) break;\n\n        const p0 = roofVertices[idx0];\n        const p1 = roofVertices[idx1];\n\n        const dx = p1.x - p0.x;\n        const dz = p1.z - p0.z;\n        const len = Math.sqrt(dx * dx + dz * dz);\n        if (len < 0.01) continue;\n\n        // Normal pointing inward for holes (opposite of outer walls)\n        // Holes are CW when viewed from above, so 90째 CCW rotation points inward\n        // 90째 counter-clockwise rotation of (dx, dz) is (-dz, dx)\n        const nx = -dz / len;\n        const nz = dx / len;\n\n        const wallStartIndex = positions.length / 3;\n        const wallBaseY = minHeight > 0 ? bottomY : baseY;\n\n        positions.push(p0.x, wallBaseY, p0.z);\n        positions.push(p1.x, wallBaseY, p1.z);\n        positions.push(p1.x, topY, p1.z);\n        positions.push(p0.x, topY, p0.z);\n\n        for (let j = 0; j < 4; j++) {\n          normals.push(nx, 0, nz);\n          colors.push(r * wallDarkening, g * wallDarkening, b * wallDarkening);\n        }\n\n        // Two triangles with CCW winding when viewed from inside (hole walls face inward)\n        indices.push(wallStartIndex + 0, wallStartIndex + 3, wallStartIndex + 2);\n        indices.push(wallStartIndex + 0, wallStartIndex + 2, wallStartIndex + 1);\n      }\n\n      holeStartIdx += holeVertexCount;\n    }\n  }\n\n  return { positions, normals, colors, indices };\n}\n\n/**\n * Build geometry for all buildings in a tile\n * Returns geometry buffers ready for GPU upload\n */\nexport function buildBuildingGeometry(\n  payload: CreateBuildingGeometryPayload\n): CreateBuildingGeometryResult {\n  const {\n    features,\n    origin,\n    lodLevel,\n    defaultHeight,\n    terrainHeights,\n    verticalExaggeration,\n  } = payload;\n\n  const allPositions: number[] = [];\n  const allNormals: number[] = [];\n  const allColors: number[] = [];\n  const allIndices: number[] = [];\n  let vertexOffset = 0;\n\n  let buildingsProcessed = 0;\n  let buildingsSkipped = 0;\n\n  for (let i = 0; i < features.length; i++) {\n    const feature = features[i];\n\n    // Skip underground buildings\n    if (feature.properties.is_underground) {\n      buildingsSkipped++;\n      continue;\n    }\n\n    // Skip main building footprints that have parts - only render the parts\n    // This prevents z-fighting between main footprint and building_part features\n    if (feature.properties.has_parts === true) {\n      buildingsSkipped++;\n      continue;\n    }\n\n    // Get polygon coordinates\n    const polygons = feature.type === 'Polygon'\n      ? [feature.coordinates as number[][][]]\n      : feature.coordinates as number[][][][];\n\n    // Get building properties\n    const height = getBuildingHeight(feature.properties, defaultHeight);\n    const minHeight = typeof feature.properties.min_height === 'number'\n      ? feature.properties.min_height : 0;\n    const color = getBuildingColor(feature);\n\n    // Get terrain height\n    const terrainData = terrainHeights?.[i];\n    const terrainHeight = terrainData ? terrainData[0] : 0;\n    const terrainSlope = terrainData ? (terrainData[1] - terrainData[0]) : 0;\n\n    for (const polygon of polygons) {\n      if (!polygon || !polygon[0] || polygon[0].length < 3) continue;\n\n      try {\n        const geom = generateBuildingGeometry(\n          polygon,\n          height,\n          minHeight,\n          color,\n          lodLevel,\n          terrainHeight,\n          terrainSlope,\n          verticalExaggeration,\n          origin\n        );\n\n        if (geom) {\n          // Append positions\n          for (const v of geom.positions) {\n            allPositions.push(v);\n          }\n\n          // Append normals\n          for (const n of geom.normals) {\n            allNormals.push(n);\n          }\n\n          // Append colors\n          for (const c of geom.colors) {\n            allColors.push(c);\n          }\n\n          // Append indices with offset\n          for (const idx of geom.indices) {\n            allIndices.push(idx + vertexOffset);\n          }\n\n          vertexOffset += geom.positions.length / 3;\n          buildingsProcessed++;\n        } else {\n          buildingsSkipped++;\n        }\n      } catch {\n        buildingsSkipped++;\n      }\n    }\n  }\n\n\n  // Create result\n  if (allPositions.length === 0) {\n    return {\n      geometry: null,\n      stats: {\n        buildingsProcessed: 0,\n        buildingsSkipped: buildingsSkipped,\n        totalVertices: 0,\n        totalTriangles: 0,\n      },\n    };\n  }\n\n  const geometry: BuildingGeometryBuffers = {\n    positions: new Float32Array(allPositions),\n    normals: new Float32Array(allNormals),\n    colors: new Float32Array(allColors),\n    indices: new Uint32Array(allIndices),\n  };\n\n  return {\n    geometry,\n    stats: {\n      buildingsProcessed,\n      buildingsSkipped,\n      totalVertices: allPositions.length / 3,\n      totalTriangles: allIndices.length / 3,\n    },\n  };\n}\n\n/**\n * Get transferable buffers from building geometry result\n * Note: TypedArray.buffer returns ArrayBufferLike, cast needed for transfer list\n */\nexport function getBuildingTransferables(result: CreateBuildingGeometryResult): ArrayBuffer[] {\n  if (!result.geometry) return [];\n\n  return [\n    result.geometry.positions.buffer as ArrayBuffer,\n    result.geometry.normals.buffer as ArrayBuffer,\n    result.geometry.colors.buffer as ArrayBuffer,\n    result.geometry.indices.buffer as ArrayBuffer,\n  ];\n}\n","/**\n * Web Worker for building geometry creation\n * Offloads CPU-intensive building extrusion from the main thread\n *\n * Benefits:\n * - No main thread blocking during building geometry generation\n * - Uses earcut for fast polygon triangulation (no Three.js dependency)\n * - Transfers Float32Array buffers (zero-copy)\n */\n\nimport type { WorkerRequest, WorkerResponse, CreateBuildingGeometryPayload } from './types.js';\nimport { buildBuildingGeometry, getBuildingTransferables } from './building-geometry-builder.js';\n\n/**\n * Handle incoming messages from the main thread\n */\nself.onmessage = (event: MessageEvent<WorkerRequest>) => {\n  const request = event.data;\n\n  try {\n    switch (request.type) {\n      case 'CAPABILITY_CHECK': {\n        // Building geometry workers don't need special capabilities\n        const response: WorkerResponse = {\n          type: 'CAPABILITY_CHECK_RESULT',\n          id: request.id,\n          supported: true,\n        };\n        self.postMessage(response);\n        break;\n      }\n\n      case 'CREATE_BUILDING_GEOMETRY': {\n        const payload = request.payload as CreateBuildingGeometryPayload;\n\n        // Build geometry buffers\n        const result = buildBuildingGeometry(payload);\n\n        // Get transferable buffers for zero-copy transfer\n        const transferables = getBuildingTransferables(result);\n\n        const response: WorkerResponse = {\n          type: 'CREATE_BUILDING_GEOMETRY_RESULT',\n          id: request.id,\n          result,\n        };\n\n        // Transfer ownership of buffers (zero-copy)\n        self.postMessage(response, { transfer: transferables });\n        break;\n      }\n\n      default: {\n        const response: WorkerResponse = {\n          type: 'ERROR',\n          id: (request as { id?: string }).id || 'unknown',\n          error: `Building geometry worker received unsupported request type: ${(request as { type?: string }).type}`,\n        };\n        self.postMessage(response);\n      }\n    }\n  } catch (error) {\n    const response: WorkerResponse = {\n      type: 'ERROR',\n      id: request.id,\n      error: error instanceof Error ? error.message : 'Unknown error in building geometry worker',\n    };\n    self.postMessage(response);\n  }\n};\n\n// Signal that worker is ready\nself.postMessage({ type: 'READY' });\n"],"names":["earcut","data","holeIndices","dim","hasHoles","outerLen","outerNode","linkedList","triangles","minX","minY","invSize","eliminateHoles","maxX","maxY","i","x","y","earcutLinked","start","end","clockwise","last","signedArea","insertNode","equals","removeNode","filterPoints","p","again","area","ear","pass","indexCurve","stop","prev","next","isEarHashed","isEar","cureLocalIntersections","splitEarcut","a","b","c","ax","bx","cx","ay","by","cy","x0","y0","x1","y1","pointInTriangleExceptFirst","minZ","zOrder","maxZ","n","intersects","locallyInside","isValidDiagonal","splitPolygon","queue","len","list","getLeftmost","compareXYSlope","eliminateHole","result","aSlope","bSlope","hole","bridge","findHoleBridge","bridgeReverse","hx","hy","qx","m","mx","my","tanMin","pointInTriangle","tan","sectorContainsSector","sortLinked","numMerges","inSize","e","tail","q","pSize","qSize","leftmost","px","py","intersectsPolygon","middleInside","r","p1","p2","q1","q2","o1","sign","o2","o3","o4","onSegment","num","inside","a2","createNode","b2","an","bp","sum","j","BUILDING_PALETTES","CLASS_TO_CATEGORY","OVERTURE_SUBTYPES","seededRandom","seed","t","generateSeed","feature","props","hash","str","coords","getBuildingCategory","subtype","subtypeLower","buildingClass","classLower","getBuildingColor","category","palette","rng","wallColorIndex","LOD_LOW","BUILDING_TERRAIN_OFFSET","SLOPE_COMPENSATION_FACTOR","MIN_BUILDING_AREA_FAR","geoToWorld","lng","lat","altitude","origin","z","calculatePolygonArea","points","getBuildingHeight","properties","defaultHeight","getColor","generateBuildingGeometry","coordinates","height","minHeight","color","lodLevel","terrainHeight","terrainSlope","verticalExaggeration","outerRing","coord","world","first","finalArea","baseY","topY","bottomY","flatCoords","holes","holeVertexCounts","holeRing","holePoints","roofIndices","vertexCount","roofVertices","positions","normals","colors","indices","g","roofStartIndex","v","bottomStartIndex","outerPointCount","wallDarkening","p0","dx","dz","nx","nz","wallStartIndex","wallBaseY","holeStartIdx","h","holeVertexCount","idx0","idx1","buildBuildingGeometry","payload","features","terrainHeights","allPositions","allNormals","allColors","allIndices","vertexOffset","buildingsProcessed","buildingsSkipped","polygons","terrainData","polygon","geom","idx","getBuildingTransferables","event","request","response","transferables","error"],"mappings":"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ACF,EAIF,WAAY,CACV,MAAO,CACL,QACA,QACA,SACA,QACA,QACA,QACA,QACA,SACA,SACA,QAAA,CACF,EAIF,MAAO,CACL,MAAO,CACL,SACA,SACA,SACA,SACA,SACA,SACA,SACA,SACA,SACA,QAAA,CACF,EAIF,UAAW,CACT,MAAO,CACL,SACA,SACA,SACA,SACA,SACA,SACA,SACA,SACA,QACA,QAAA,CACF,EAIF,UAAW,CACT,MAAO,CACL,SACA,SACA,SACA,QACA,SACA,SACA,SACA,SACA,SACA,QAAA,CACF,EAIF,QAAS,CACP,MAAO,CACL,SACA,SACA,SACA,SACA,SACA,SACA,SACA,SACA,QACA,OAAA,CACF,EAIF,aAAc,CACZ,MAAO,CACL,QACA,SACA,SACA,SACA,QACA,QACA,SACA,SACA,QACA,OAAA,CACF,EAIF,cAAe,CACb,MAAO,CACL,QACA,QACA,QACA,QACA,QACA,QACA,QACA,QACA,SACA,OAAA,CACF,EAIF,SAAU,CACR,MAAO,CACL,QACA,QACA,QACA,QACA,QACA,QACA,QACA,SACA,QACA,OAAA,CACF,EAIF,YAAa,CACX,MAAO,CACL,QACA,SACA,QACA,QACA,SACA,SACA,QACA,QACA,SACA,OAAA,CACF,EAIF,QAAS,CACP,MAAO,CACL,QACA,QACA,SACA,QACA,SACA,SACA,QACA,QACA,SACA,QAAA,CACF,EAIF,eAAgB,CACd,MAAO,CACL,QACA,QACA,SACA,SACA,QACA,QACA,QACA,QACA,SACA,QAAA,CACF,EAIF,QAAS,CACP,MAAO,CACL,QACA,QACA,SACA,SACA,QACA,SACA,SACA,SACA,QACA,OAAA,CACF,CAEJ,EASaC,GAA4C,CAEvD,MAAO,cACP,YAAa,cACb,SAAU,cACV,KAAM,cACN,mBAAoB,cACpB,QAAS,cACT,WAAY,cACZ,SAAU,cACV,eAAgB,cAChB,YAAa,cACb,OAAQ,cACR,MAAO,cACP,UAAW,cACX,eAAgB,cAChB,IAAK,cACL,IAAK,cACL,UAAW,cACX,gBAAiB,cACjB,UAAW,cACX,OAAQ,cACR,QA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","x_google_ignoreList":[0]}