(function(){"use strict";function ge(e,n,t=2){const r=n&&n.length,o=r?n[0]*t:e.length;let i=oe(e,0,o,t,!0);const s=[];if(!i||i.next===i.prev)return s;let l,c,f;if(r&&(i=ve(e,n,i,t)),e.length>80*t){l=e[0],c=e[1];let x=l,a=c;for(let M=t;M<o;M+=t){const m=e[M],p=e[M+1];m<l&&(l=m),p<c&&(c=p),m>x&&(x=m),p>a&&(a=p)}f=Math.max(x-l,a-c),f=f!==0?32767/f:0}return H(i,s,t,l,c,f,0),s}function oe(e,n,t,r,o){let i;if(o===Ae(e,n,t,r)>0)for(let s=n;s<t;s+=r)i=ue(s/r|0,e[s],e[s+1],i);else for(let s=t-r;s>=n;s-=r)i=ue(s/r|0,e[s],e[s+1],i);return i&&D(i,i.next)&&(j(i),i=i.next),i}function T(e,n){if(!e)return e;n||(n=e);let t=e,r;do if(r=!1,!t.steiner&&(D(t,t.next)||v(t.prev,t,t.next)===0)){if(j(t),t=n=t.prev,t===t.next)break;r=!0}else t=t.next;while(r||t!==n);return n}function H(e,n,t,r,o,i,s){if(!e)return;!s&&i&&Ze(e,r,o,i);let l=e;for(;e.prev!==e.next;){const c=e.prev,f=e.next;if(i?ye(e,r,o,i):pe(e)){n.push(c.i,e.i,f.i),j(e),e=f.next,l=f.next;continue}if(e=f,e===l){s?s===1?(e=ae(T(e),n),H(e,n,t,r,o,i,2)):s===2&&de(e,n,t,r,o,i):H(T(e),n,t,r,o,i,1);break}}}function pe(e){const n=e.prev,t=e,r=e.next;if(v(n,t,r)>=0)return!1;const o=n.x,i=t.x,s=r.x,l=n.y,c=t.y,f=r.y,x=Math.min(o,i,s),a=Math.min(l,c,f),M=Math.max(o,i,s),m=Math.max(l,c,f);let p=r.next;for(;p!==n;){if(p.x>=x&&p.x<=M&&p.y>=a&&p.y<=m&&Y(o,l,i,c,s,f,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function ye(e,n,t,r){const o=e.prev,i=e,s=e.next;if(v(o,i,s)>=0)return!1;const l=o.x,c=i.x,f=s.x,x=o.y,a=i.y,M=s.y,m=Math.min(l,c,f),p=Math.min(x,a,M),E=Math.max(l,c,f),z=Math.max(x,a,M),B=X(m,p,n,t,r),C=X(E,z,n,t,r);let h=e.prevZ,u=e.nextZ;for(;h&&h.z>=B&&u&&u.z<=C;){if(h.x>=m&&h.x<=E&&h.y>=p&&h.y<=z&&h!==o&&h!==s&&Y(l,x,c,a,f,M,h.x,h.y)&&v(h.prev,h,h.next)>=0||(h=h.prevZ,u.x>=m&&u.x<=E&&u.y>=p&&u.y<=z&&u!==o&&u!==s&&Y(l,x,c,a,f,M,u.x,u.y)&&v(u.prev,u,u.next)>=0))return!1;u=u.nextZ}for(;h&&h.z>=B;){if(h.x>=m&&h.x<=E&&h.y>=p&&h.y<=z&&h!==o&&h!==s&&Y(l,x,c,a,f,M,h.x,h.y)&&v(h.prev,h,h.next)>=0)return!1;h=h.prevZ}for(;u&&u.z<=C;){if(u.x>=m&&u.x<=E&&u.y>=p&&u.y<=z&&u!==o&&u!==s&&Y(l,x,c,a,f,M,u.x,u.y)&&v(u.prev,u,u.next)>=0)return!1;u=u.nextZ}return!0}function ae(e,n){let t=e;do{const r=t.prev,o=t.next.next;!D(r,o)&&ie(r,t,t.next,o)&&V(r,o)&&V(o,r)&&(n.push(r.i,t.i,o.i),j(t),j(t.next),t=e=o),t=t.next}while(t!==e);return T(t)}function de(e,n,t,r,o,i){let s=e;do{let l=s.next.next;for(;l!==s.prev;){if(s.i!==l.i&&Fe(s,l)){let c=le(s,l);s=T(s,s.next),c=T(c,c.next),H(s,n,t,r,o,i,0),H(c,n,t,r,o,i,0);return}l=l.next}s=s.next}while(s!==e)}function ve(e,n,t,r){const o=[];for(let i=0,s=n.length;i<s;i++){const l=n[i]*r,c=i<s-1?n[i+1]*r:e.length,f=oe(e,l,c,r,!1);f===f.next&&(f.steiner=!0),o.push(Ie(f))}o.sort(me);for(let i=0;i<o.length;i++)t=ze(o[i],t);return t}function me(e,n){let t=e.x-n.x;if(t===0&&(t=e.y-n.y,t===0)){const r=(e.next.y-e.y)/(e.next.x-e.x),o=(n.next.y-n.y)/(n.next.x-n.x);t=r-o}return t}function ze(e,n){const t=Me(e,n);if(!t)return n;const r=le(t,e);return T(r,r.next),T(t,t.next)}function Me(e,n){let t=n;const r=e.x,o=e.y;let i=-1/0,s;if(D(e,t))return t;do{if(D(e,t.next))return t.next;if(o<=t.y&&o>=t.next.y&&t.next.y!==t.y){const a=t.x+(o-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(a<=r&&a>i&&(i=a,s=t.x<t.next.x?t:t.next,a===r))return s}t=t.next}while(t!==n);if(!s)return null;const l=s,c=s.x,f=s.y;let x=1/0;t=s;do{if(r>=t.x&&t.x>=c&&r!==t.x&&se(o<f?r:i,o,c,f,o<f?i:r,o,t.x,t.y)){const a=Math.abs(o-t.y)/(r-t.x);V(t,e)&&(a<x||a===x&&(t.x>s.x||t.x===s.x&&we(s,t)))&&(s=t,x=a)}t=t.next}while(t!==l);return s}function we(e,n){return v(e.prev,e,n.prev)<0&&v(n.next,e,e.next)<0}function Ze(e,n,t,r){let o=e;do o.z===0&&(o.z=X(o.x,o.y,n,t,r)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next;while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,Ee(o)}function Ee(e){let n,t=1;do{let r=e,o;e=null;let i=null;for(n=0;r;){n++;let s=r,l=0;for(let f=0;f<t&&(l++,s=s.nextZ,!!s);f++);let c=t;for(;l>0||c>0&&s;)l!==0&&(c===0||!s||r.z<=s.z)?(o=r,r=r.nextZ,l--):(o=s,s=s.nextZ,c--),i?i.nextZ=o:e=o,o.prevZ=i,i=o;r=s}i.nextZ=null,t*=2}while(n>1);return e}function X(e,n,t,r,o){return e=(e-t)*o|0,n=(n-r)*o|0,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e|n<<1}function Ie(e){let n=e,t=e;do(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next;while(n!==e);return t}function se(e,n,t,r,o,i,s,l){return(o-s)*(n-l)>=(e-s)*(i-l)&&(e-s)*(r-l)>=(t-s)*(n-l)&&(t-s)*(i-l)>=(o-s)*(r-l)}function Y(e,n,t,r,o,i,s,l){return!(e===s&&n===l)&&se(e,n,t,r,o,i,s,l)}function Fe(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!_e(e,n)&&(V(e,n)&&V(n,e)&&Re(e,n)&&(v(e.prev,e,n.prev)||v(e,n.prev,n))||D(e,n)&&v(e.prev,e,e.next)>0&&v(n.prev,n,n.next)>0)}function v(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function D(e,n){return e.x===n.x&&e.y===n.y}function ie(e,n,t,r){const o=W(v(e,n,t)),i=W(v(e,n,r)),s=W(v(t,r,e)),l=W(v(t,r,n));return!!(o!==i&&s!==l||o===0&&K(e,t,n)||i===0&&K(e,r,n)||s===0&&K(t,e,r)||l===0&&K(t,n,r))}function K(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function W(e){return e>0?1:e<0?-1:0}function _e(e,n){let t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&ie(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}function V(e,n){return v(e.prev,e,e.next)<0?v(e,n,e.next)>=0&&v(e,e.prev,n)>=0:v(e,n,e.prev)<0||v(e,e.next,n)<0}function Re(e,n){let t=e,r=!1;const o=(e.x+n.x)/2,i=(e.y+n.y)/2;do t.y>i!=t.next.y>i&&t.next.y!==t.y&&o<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next;while(t!==e);return r}function le(e,n){const t=q(e.i,e.x,e.y),r=q(n.i,n.x,n.y),o=e.next,i=n.prev;return e.next=n,n.prev=e,t.next=o,o.prev=t,r.next=t,t.prev=r,i.next=r,r.prev=i,r}function ue(e,n,t,r){const o=q(e,n,t);return r?(o.next=r.next,o.prev=r,r.next.prev=o,r.next=o):(o.prev=o,o.next=o),o}function j(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function q(e,n,t){return{i:e,x:n,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ae(e,n,t,r){let o=0;for(let i=n,s=t-r;i<t;i+=r)o+=(e[s]-e[i])*(e[i+1]+e[s+1]),s=i;return o}const ce=1,$=2,Ce=.5,be=.3,Le=50,A={residential:10132136,commercial:8947872,industrial:7368832,retail:10526896,office:8421536,warehouse:6316144,hospital:12632272,school:12103840,university:12103840,religious:13682880,government:10526896,transportation:8421520,default:8947865};function fe(e,n,t,r){const o=(e-r.lng)*r.metersPerDegLng,i=-(n-r.lat)*r.metersPerDegLat;return{x:o,y:t,z:i}}function ee(e){let n=0;for(let t=0,r=e.length-1;t<e.length;r=t++)n+=(e[r].x+e[t].x)*(e[r].z-e[t].z);return n/2}function te(e,n){if(e.length<=4)return e;const t=[e[0]];let r=e[0];for(let o=1;o<e.length-1;o++){const i=e[o],s=i.x-r.x,l=i.z-r.z;Math.sqrt(s*s+l*l)>=n&&(t.push(i),r=i)}return e.length>1&&t.push(e[e.length-1]),t.length<3?e.length>=3?e.slice(0,3):e.slice():t}function Pe(e,n){return typeof e.height=="number"&&e.height>0?e.height:typeof e.num_floors=="number"&&e.num_floors>0?e.num_floors*3:n}function Te(e){const n=(e.subtype||e.class||"").toString().toLowerCase();return n in A?A[n]:n.includes("residential")||n.includes("house")||n.includes("apartment")?A.residential:n.includes("commercial")||n.includes("retail")||n.includes("shop")?A.commercial:n.includes("industrial")||n.includes("factory")||n.includes("warehouse")?A.industrial:n.includes("office")?A.office:n.includes("school")||n.includes("education")?A.school:n.includes("hospital")||n.includes("medical")?A.hospital:n.includes("church")||n.includes("religious")||n.includes("mosque")||n.includes("temple")?A.religious:A.default}function Be(e,n,t,r,o,i,s,l,c){if(!e||e.length===0)return null;const f=e[0];if(!f||f.length<3)return null;let x=[];for(const g of f){const d=fe(g[0],g[1],0,c);x.push({x:d.x,z:-d.z})}if(x.length>1){const g=x[0],d=x[x.length-1];Math.abs(g.x-d.x)<.01&&Math.abs(g.z-d.z)<.01&&x.pop()}if(x.length<3)return null;const a=ee(x);if(Math.abs(a)<1||o===$&&Math.abs(a)<Le||(o===ce?x=te(x,2):o===$&&(x=te(x,5)),x.length<3))return null;const M=ee(x);if(Math.abs(M)<1)return null;M>0&&x.reverse();const m=i*l+Ce-s*be,p=m+n,E=m+t,z=[];for(const g of x)z.push(g.x,g.z);const B=[];if(o!==$&&e.length>1)for(let g=1;g<e.length;g++){const d=e[g];if(!d||d.length<3)continue;B.push(z.length/2);let y=[];for(const Z of d){const _=fe(Z[0],Z[1],0,c);y.push({x:_.x,z:-_.z})}if(y.length>1){const Z=y[0],_=y[y.length-1];Math.abs(Z.x-_.x)<.01&&Math.abs(Z.z-_.z)<.01&&y.pop()}o===ce&&y.length>4&&(y=te(y,2)),ee(y)<0&&y.reverse();for(const Z of y)z.push(Z.x,Z.z)}const C=ge(z,B,2);if(C.length===0)return null;const h=z.length/2,u=[];for(let g=0;g<h;g++)u.push({x:z[g*2],z:z[g*2+1]});const w=[],O=[],k=[],b=[],R=(r>>16&255)/255,F=(r>>8&255)/255,J=(r&255)/255,De=w.length/3;for(const g of u)w.push(g.x,p,g.z),O.push(0,1,0),k.push(R,F,J);for(const g of C)b.push(De+g);if(t>0){const g=w.length/3;for(const d of u)w.push(d.x,E,d.z),O.push(0,-1,0),k.push(R*.7,F*.7,J*.7);for(let d=C.length-1;d>=0;d--)b.push(g+C[d])}const ne=x.length,S=.85;for(let g=0;g<ne;g++){const d=x[g],y=x[(g+1)%ne],L=y.x-d.x,Z=y.z-d.z,_=Math.sqrt(L*L+Z*Z);if(_<.01)continue;const Q=-Z/_,P=L/_,I=w.length/3,N=t>0?E:m;w.push(d.x,N,d.z),w.push(y.x,N,y.z),w.push(y.x,p,y.z),w.push(d.x,p,d.z);for(let U=0;U<4;U++)O.push(Q,0,P),k.push(R*S,F*S,J*S);b.push(I+0,I+3,I+2),b.push(I+0,I+2,I+1)}if(o!==$&&e.length>1){let g=ne;for(let d=1;d<e.length;d++){const y=e[d];if(!y||y.length<3)continue;const L=y.length-(y.length>1&&Math.abs(y[0][0]-y[y.length-1][0])<1e-4&&Math.abs(y[0][1]-y[y.length-1][1])<1e-4?1:0);for(let Z=0;Z<Math.min(L,u.length-g);Z++){const _=g+Z,Q=g+(Z+1)%L;if(_>=u.length||Q>=u.length)break;const P=u[_],I=u[Q],N=I.x-P.x,U=I.z-P.z,re=Math.sqrt(N*N+U*U);if(re<.01)continue;const Se=U/re,Ne=-N/re,G=w.length/3,xe=t>0?E:m;w.push(P.x,xe,P.z),w.push(I.x,xe,I.z),w.push(I.x,p,I.z),w.push(P.x,p,P.z);for(let he=0;he<4;he++)O.push(Se,0,Ne),k.push(R*S,F*S,J*S);b.push(G+0,G+3,G+2),b.push(G+0,G+2,G+1)}g+=L}}return{positions:w,normals:O,colors:k,indices:b}}function Oe(e){const{features:n,origin:t,lodLevel:r,defaultHeight:o,terrainHeights:i,verticalExaggeration:s}=e,l=[],c=[],f=[],x=[];let a=0,M=0,m=0;for(let E=0;E<n.length;E++){const z=n[E];if(z.properties.is_underground){m++;continue}const B=Pe(z.properties,o),C=typeof z.properties.min_height=="number"?z.properties.min_height:0,h=Te(z.properties),u=i==null?void 0:i[E],w=u?u[0]:0,O=u?u[1]-u[0]:0,k=z.type==="Polygon"?[z.coordinates]:z.coordinates;for(const b of k)try{const R=Be(b,B,C,h,r,w,O,s,t);if(R){for(const F of R.positions)l.push(F);for(const F of R.normals)c.push(F);for(const F of R.colors)f.push(F);for(const F of R.indices)x.push(F+a);a+=R.positions.length/3,M++}else m++}catch{m++}}return l.length===0?{geometry:null,stats:{buildingsProcessed:0,buildingsSkipped:m,totalVertices:0,totalTriangles:0}}:{geometry:{positions:new Float32Array(l),normals:new Float32Array(c),colors:new Float32Array(f),indices:new Uint32Array(x)},stats:{buildingsProcessed:M,buildingsSkipped:m,totalVertices:l.length/3,totalTriangles:x.length/3}}}function ke(e){return e.geometry?[e.geometry.positions.buffer,e.geometry.normals.buffer,e.geometry.colors.buffer,e.geometry.indices.buffer]:[]}self.onmessage=e=>{const n=e.data;try{switch(n.type){case"CAPABILITY_CHECK":{const t={type:"CAPABILITY_CHECK_RESULT",id:n.id,supported:!0};self.postMessage(t);break}case"CREATE_BUILDING_GEOMETRY":{const t=n.payload,r=Oe(t),o=ke(r),i={type:"CREATE_BUILDING_GEOMETRY_RESULT",id:n.id,result:r};self.postMessage(i,{transfer:o});break}default:{const t={type:"ERROR",id:n.id||"unknown",error:`Building geometry worker received unsupported request type: ${n.type}`};self.postMessage(t)}}}catch(t){const r={type:"ERROR",id:n.id,error:t instanceof Error?t.message:"Unknown error in building geometry worker"};self.postMessage(r)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=building-geometry.worker-bwWCFT6z.js.map
