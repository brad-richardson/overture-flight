(function(){"use strict";function x(i,t){this.x=i,this.y=t}x.prototype={clone(){return new x(this.x,this.y)},add(i){return this.clone()._add(i)},sub(i){return this.clone()._sub(i)},multByPoint(i){return this.clone()._multByPoint(i)},divByPoint(i){return this.clone()._divByPoint(i)},mult(i){return this.clone()._mult(i)},div(i){return this.clone()._div(i)},rotate(i){return this.clone()._rotate(i)},rotateAround(i,t){return this.clone()._rotateAround(i,t)},matMult(i){return this.clone()._matMult(i)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(i){return this.x===i.x&&this.y===i.y},dist(i){return Math.sqrt(this.distSqr(i))},distSqr(i){const t=i.x-this.x,e=i.y-this.y;return t*t+e*e},angle(){return Math.atan2(this.y,this.x)},angleTo(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith(i){return this.angleWithSep(i.x,i.y)},angleWithSep(i,t){return Math.atan2(this.x*t-this.y*i,this.x*i+this.y*t)},_matMult(i){const t=i[0]*this.x+i[1]*this.y,e=i[2]*this.x+i[3]*this.y;return this.x=t,this.y=e,this},_add(i){return this.x+=i.x,this.y+=i.y,this},_sub(i){return this.x-=i.x,this.y-=i.y,this},_mult(i){return this.x*=i,this.y*=i,this},_div(i){return this.x/=i,this.y/=i,this},_multByPoint(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint(i){return this.x/=i.x,this.y/=i.y,this},_unit(){return this._div(this.mag()),this},_perp(){const i=this.y;return this.y=this.x,this.x=-i,this},_rotate(i){const t=Math.cos(i),e=Math.sin(i),s=t*this.x-e*this.y,n=e*this.x+t*this.y;return this.x=s,this.y=n,this},_rotateAround(i,t){const e=Math.cos(i),s=Math.sin(i),n=t.x+e*(this.x-t.x)-s*(this.y-t.y),r=t.y+s*(this.x-t.x)+e*(this.y-t.y);return this.x=n,this.y=r,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:x},x.convert=function(i){if(i instanceof x)return i;if(Array.isArray(i))return new x(+i[0],+i[1]);if(i.x!==void 0&&i.y!==void 0)return new x(+i.x,+i.y);throw new Error("Expected [x, y] or {x, y} point format")};class P{constructor(t,e,s,n,r){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=n,this._values=r,t.readFields(T,this,e)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos,s=[];let n,r=1,o=0,d=0,h=0;for(;t.pos<e;){if(o<=0){const a=t.readVarint();r=a&7,o=a>>3}if(o--,r===1||r===2)d+=t.readSVarint(),h+=t.readSVarint(),r===1&&(n&&s.push(n),n=[]),n&&n.push(new x(d,h));else if(r===7)n&&n.push(n[0].clone());else throw new Error(`unknown command ${r}`)}return n&&s.push(n),s}bbox(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos;let s=1,n=0,r=0,o=0,d=1/0,h=-1/0,a=1/0,l=-1/0;for(;t.pos<e;){if(n<=0){const f=t.readVarint();s=f&7,n=f>>3}if(n--,s===1||s===2)r+=t.readSVarint(),o+=t.readSVarint(),r<d&&(d=r),r>h&&(h=r),o<a&&(a=o),o>l&&(l=o);else if(s!==7)throw new Error(`unknown command ${s}`)}return[d,a,h,l]}toGeoJSON(t,e,s){const n=this.extent*Math.pow(2,s),r=this.extent*t,o=this.extent*e,d=this.loadGeometry();function h(u){return[(u.x+r)*360/n-180,360/Math.PI*Math.atan(Math.exp((1-(u.y+o)*2/n)*Math.PI))-90]}function a(u){return u.map(h)}let l;if(this.type===1){const u=[];for(const y of d)u.push(y[0]);const c=a(u);l=u.length===1?{type:"Point",coordinates:c[0]}:{type:"MultiPoint",coordinates:c}}else if(this.type===2){const u=d.map(a);l=u.length===1?{type:"LineString",coordinates:u[0]}:{type:"MultiLineString",coordinates:u}}else if(this.type===3){const u=I(d),c=[];for(const y of u)c.push(y.map(a));l=c.length===1?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}else throw new Error("unknown feature type");const f={type:"Feature",geometry:l,properties:this.properties};return this.id!=null&&(f.id=this.id),f}}P.types=["Unknown","Point","LineString","Polygon"];function T(i,t,e){i===1?t.id=e.readVarint():i===2?v(e,t):i===3?t.type=e.readVarint():i===4&&(t._geometry=e.pos)}function v(i,t){const e=i.readVarint()+i.pos;for(;i.pos<e;){const s=t._keys[i.readVarint()],n=t._values[i.readVarint()];t.properties[s]=n}}function I(i){const t=i.length;if(t<=1)return[i];const e=[];let s,n;for(let r=0;r<t;r++){const o=D(i[r]);o!==0&&(n===void 0&&(n=o<0),n===o<0?(s&&e.push(s),s=[i[r]]):s&&s.push(i[r]))}return s&&e.push(s),e}function D(i){let t=0;for(let e=0,s=i.length,n=s-1,r,o;e<s;n=e++)r=i[e],o=i[n],t+=(o.x-r.x)*(r.y+o.y);return t}class C{constructor(t,e){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(A,this,e),this.length=this._features.length}feature(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];const e=this._pbf.readVarint()+this._pbf.pos;return new P(this._pbf,e,this.extent,this._keys,this._values)}}function A(i,t,e){i===15?t.version=e.readVarint():i===1?t.name=e.readString():i===5?t.extent=e.readVarint():i===2?t._features.push(e.pos):i===3?t._keys.push(e.readString()):i===4&&t._values.push(L(e))}function L(i){let t=null;const e=i.readVarint()+i.pos;for(;i.pos<e;){const s=i.readVarint()>>3;t=s===1?i.readString():s===2?i.readFloat():s===3?i.readDouble():s===4?i.readVarint64():s===5?i.readVarint():s===6?i.readSVarint():s===7?i.readBoolean():null}if(t==null)throw new Error("unknown feature value");return t}class b{constructor(t,e){this.layers=t.readFields(R,{},e)}}function R(i,t,e){if(i===3){const s=new C(e,e.readVarint()+e.pos);s.length&&(t[s.name]=s)}}const V=65536*65536,m=1/V,U=12,S=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),p=0,F=1,g=2,_=5;class q{constructor(t=new Uint8Array(16)){this.buf=ArrayBuffer.isView(t)?t:new Uint8Array(t),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(t,e,s=this.length){for(;this.pos<s;){const n=this.readVarint(),r=n>>3,o=this.pos;this.type=n&7,t(r,e,this),this.pos===o&&this.skip(n)}return e}readMessage(t,e){return this.readFields(t,e,this.readVarint()+this.pos)}readFixed32(){const t=this.dataView.getUint32(this.pos,!0);return this.pos+=4,t}readSFixed32(){const t=this.dataView.getInt32(this.pos,!0);return this.pos+=4,t}readFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*V;return this.pos+=8,t}readSFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*V;return this.pos+=8,t}readFloat(){const t=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,t}readDouble(){const t=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,t}readVarint(t){const e=this.buf;let s,n;return n=e[this.pos++],s=n&127,n<128||(n=e[this.pos++],s|=(n&127)<<7,n<128)||(n=e[this.pos++],s|=(n&127)<<14,n<128)||(n=e[this.pos++],s|=(n&127)<<21,n<128)?s:(n=e[this.pos],s|=(n&15)<<28,G(s,t,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const t=this.readVarint();return t%2===1?(t+1)/-2:t/2}readBoolean(){return!!this.readVarint()}readString(){const t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=U&&S?S.decode(this.buf.subarray(e,t)):Q(this.buf,e,t)}readBytes(){const t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e}readPackedVarint(t=[],e){const s=this.readPackedEnd();for(;this.pos<s;)t.push(this.readVarint(e));return t}readPackedSVarint(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSVarint());return t}readPackedBoolean(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readBoolean());return t}readPackedFloat(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFloat());return t}readPackedDouble(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readDouble());return t}readPackedFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed32());return t}readPackedSFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed32());return t}readPackedFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed64());return t}readPackedSFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed64());return t}readPackedEnd(){return this.type===g?this.readVarint()+this.pos:this.pos+1}skip(t){const e=t&7;if(e===p)for(;this.buf[this.pos++]>127;);else if(e===g)this.pos=this.readVarint()+this.pos;else if(e===_)this.pos+=4;else if(e===F)this.pos+=8;else throw new Error(`Unimplemented type: ${e}`)}writeTag(t,e){this.writeVarint(t<<3|e)}realloc(t){let e=this.length||16;for(;e<this.pos+t;)e*=2;if(e!==this.length){const s=new Uint8Array(e);s.set(this.buf),this.buf=s,this.dataView=new DataView(s.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeSFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*m),!0),this.pos+=8}writeSFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*m),!0),this.pos+=8}writeVarint(t){if(t=+t||0,t>268435455||t<0){N(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))}writeSVarint(t){this.writeVarint(t<0?-t*2-1:t*2)}writeBoolean(t){this.writeVarint(+t)}writeString(t){t=String(t),this.realloc(t.length*4),this.pos++;const e=this.pos;this.pos=tt(this.buf,t,this.pos);const s=this.pos-e;s>=128&&k(e,s,this),this.pos=e-1,this.writeVarint(s),this.pos+=s}writeFloat(t){this.realloc(4),this.dataView.setFloat32(this.pos,t,!0),this.pos+=4}writeDouble(t){this.realloc(8),this.dataView.setFloat64(this.pos,t,!0),this.pos+=8}writeBytes(t){const e=t.length;this.writeVarint(e),this.realloc(e);for(let s=0;s<e;s++)this.buf[this.pos++]=t[s]}writeRawMessage(t,e){this.pos++;const s=this.pos;t(e,this);const n=this.pos-s;n>=128&&k(s,n,this),this.pos=s-1,this.writeVarint(n),this.pos+=n}writeMessage(t,e,s){this.writeTag(t,g),this.writeRawMessage(e,s)}writePackedVarint(t,e){e.length&&this.writeMessage(t,j,e)}writePackedSVarint(t,e){e.length&&this.writeMessage(t,Y,e)}writePackedBoolean(t,e){e.length&&this.writeMessage(t,$,e)}writePackedFloat(t,e){e.length&&this.writeMessage(t,Z,e)}writePackedDouble(t,e){e.length&&this.writeMessage(t,X,e)}writePackedFixed32(t,e){e.length&&this.writeMessage(t,W,e)}writePackedSFixed32(t,e){e.length&&this.writeMessage(t,z,e)}writePackedFixed64(t,e){e.length&&this.writeMessage(t,J,e)}writePackedSFixed64(t,e){e.length&&this.writeMessage(t,K,e)}writeBytesField(t,e){this.writeTag(t,g),this.writeBytes(e)}writeFixed32Field(t,e){this.writeTag(t,_),this.writeFixed32(e)}writeSFixed32Field(t,e){this.writeTag(t,_),this.writeSFixed32(e)}writeFixed64Field(t,e){this.writeTag(t,F),this.writeFixed64(e)}writeSFixed64Field(t,e){this.writeTag(t,F),this.writeSFixed64(e)}writeVarintField(t,e){this.writeTag(t,p),this.writeVarint(e)}writeSVarintField(t,e){this.writeTag(t,p),this.writeSVarint(e)}writeStringField(t,e){this.writeTag(t,g),this.writeString(e)}writeFloatField(t,e){this.writeTag(t,_),this.writeFloat(e)}writeDoubleField(t,e){this.writeTag(t,F),this.writeDouble(e)}writeBooleanField(t,e){this.writeVarintField(t,+e)}}function G(i,t,e){const s=e.buf;let n,r;if(r=s[e.pos++],n=(r&112)>>4,r<128||(r=s[e.pos++],n|=(r&127)<<3,r<128)||(r=s[e.pos++],n|=(r&127)<<10,r<128)||(r=s[e.pos++],n|=(r&127)<<17,r<128)||(r=s[e.pos++],n|=(r&127)<<24,r<128)||(r=s[e.pos++],n|=(r&1)<<31,r<128))return w(i,n,t);throw new Error("Expected varint not more than 10 bytes")}function w(i,t,e){return e?t*4294967296+(i>>>0):(t>>>0)*4294967296+(i>>>0)}function N(i,t){let e,s;if(i>=0?(e=i%4294967296|0,s=i/4294967296|0):(e=~(-i%4294967296),s=~(-i/4294967296),e^4294967295?e=e+1|0:(e=0,s=s+1|0)),i>=18446744073709552e3||i<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),H(e,s,t),O(s,t)}function H(i,t,e){e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos]=i&127}function O(i,t){const e=(i&7)<<4;t.buf[t.pos++]|=e|((i>>>=3)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127)))))}function k(i,t,e){const s=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(Math.LN2*7));e.realloc(s);for(let n=e.pos-1;n>=i;n--)e.buf[n+s]=e.buf[n]}function j(i,t){for(let e=0;e<i.length;e++)t.writeVarint(i[e])}function Y(i,t){for(let e=0;e<i.length;e++)t.writeSVarint(i[e])}function Z(i,t){for(let e=0;e<i.length;e++)t.writeFloat(i[e])}function X(i,t){for(let e=0;e<i.length;e++)t.writeDouble(i[e])}function $(i,t){for(let e=0;e<i.length;e++)t.writeBoolean(i[e])}function W(i,t){for(let e=0;e<i.length;e++)t.writeFixed32(i[e])}function z(i,t){for(let e=0;e<i.length;e++)t.writeSFixed32(i[e])}function J(i,t){for(let e=0;e<i.length;e++)t.writeFixed64(i[e])}function K(i,t){for(let e=0;e<i.length;e++)t.writeSFixed64(i[e])}function Q(i,t,e){let s="",n=t;for(;n<e;){const r=i[n];let o=null,d=r>239?4:r>223?3:r>191?2:1;if(n+d>e)break;let h,a,l;d===1?r<128&&(o=r):d===2?(h=i[n+1],(h&192)===128&&(o=(r&31)<<6|h&63,o<=127&&(o=null))):d===3?(h=i[n+1],a=i[n+2],(h&192)===128&&(a&192)===128&&(o=(r&15)<<12|(h&63)<<6|a&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):d===4&&(h=i[n+1],a=i[n+2],l=i[n+3],(h&192)===128&&(a&192)===128&&(l&192)===128&&(o=(r&15)<<18|(h&63)<<12|(a&63)<<6|l&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,d=1):o>65535&&(o-=65536,s+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),s+=String.fromCharCode(o),n+=d}return s}function tt(i,t,e){for(let s=0,n,r;s<t.length;s++){if(n=t.charCodeAt(s),n>55295&&n<57344)if(r)if(n<56320){i[e++]=239,i[e++]=191,i[e++]=189,r=n;continue}else n=r-55296<<10|n-56320|65536,r=null;else{n>56319||s+1===t.length?(i[e++]=239,i[e++]=191,i[e++]=189):r=n;continue}else r&&(i[e++]=239,i[e++]=191,i[e++]=189,r=null);n<128?i[e++]=n:(n<2048?i[e++]=n>>6|192:(n<65536?i[e++]=n>>12|224:(i[e++]=n>>18|240,i[e++]=n>>12&63|128),i[e++]=n>>6&63|128),i[e++]=n&63|128)}return e}const et={Point:0,MultiPoint:1,LineString:2,MultiLineString:3,Polygon:4,MultiPolygon:5};function it(i,t){const e=[],s=[],n=[];function r(h){s.push(e.length/2);for(const a of h)e.push(a[0],a[1])}function o(h){for(const a of h)r(a)}switch(i){case"Point":e.push(t[0],t[1]);break;case"MultiPoint":case"LineString":for(const h of t)e.push(h[0],h[1]);break;case"MultiLineString":for(const h of t){s.push(e.length/2);for(const a of h)e.push(a[0],a[1])}break;case"Polygon":o(t);break;case"MultiPolygon":for(const h of t)n.push(s.length),o(h);break}const d={coords:new Float64Array(e),ringIndices:new Uint32Array(s)};return i==="MultiPolygon"&&n.length>0&&(d.polygonIndices=new Uint32Array(n)),d}function st(i){const t={};if(i.subtype!==void 0&&(t.subtype=i.subtype),i.class!==void 0&&(t.class=i.class),i.surface!==void 0&&(t.surface=i.surface),i.road_flags!==void 0&&(t.road_flags=i.road_flags),i.level_rules!==void 0&&(t.level_rules=i.level_rules),i.level!==void 0&&(t.level=i.level),i._fromLowerZoom!==void 0&&(t._fromLowerZoom=i._fromLowerZoom),i._sourceZoom!==void 0&&(t._sourceZoom=i._sourceZoom),i.type!==void 0&&(t.type=i.type),i.category!==void 0&&(t.category=i.category),i.depth!==void 0&&(t.depth=i.depth),i.road_class!==void 0&&(t.road_class=i.road_class),i.highway!==void 0&&(t.highway=i.highway),i.is_tunnel!==void 0&&(t.is_tunnel=i.is_tunnel),i.is_underground!==void 0&&(t.is_underground=i.is_underground),i.id!==void 0&&(t.id=i.id),i.building_id!==void 0&&(t.building_id=i.building_id),i.height!==void 0&&(t.height=i.height),i.num_floors!==void 0&&(t.num_floors=i.num_floors),i.min_height!==void 0&&(t.min_height=i.min_height),i.num_floors_underground!==void 0&&(t.num_floors_underground=i.num_floors_underground),i.has_parts!==void 0&&(t.has_parts=i.has_parts),i.names&&typeof i.names=="object"){const e=i.names;e.primary&&(t.names={primary:e.primary})}return t}function nt(i,t,e,s,n){const r=new b(new q(i)),o=[],d={},h=Object.keys(r.layers),a=n&&r.layers[n]?[n]:h;for(const l of a){const f=r.layers[l];if(f){d[l]=f.length;for(let u=0;u<f.length;u++){const c=f.feature(u),y=c.toGeoJSON(t,e,s),M=y.geometry.type,{coords:ot,ringIndices:ht,polygonIndices:E}=it(M,y.geometry.coordinates),B={typeIndex:et[M]??-1,layer:l,coords:ot,ringIndices:ht,props:st(c.properties)};E&&(B.polygonIndices=E),o.push(B)}}}return{features:o,layerCounts:d}}function rt(i){var e;const t=[];for(const s of i.features)s.coords.buffer instanceof ArrayBuffer&&t.push(s.coords.buffer),s.ringIndices.buffer instanceof ArrayBuffer&&t.push(s.ringIndices.buffer),((e=s.polygonIndices)==null?void 0:e.buffer)instanceof ArrayBuffer&&t.push(s.polygonIndices.buffer);return t}self.onmessage=i=>{const t=i.data;try{switch(t.type){case"CAPABILITY_CHECK":{const e={type:"CAPABILITY_CHECK_RESULT",id:t.id,supported:!0};self.postMessage(e);break}case"PARSE_MVT":{const{data:e,tileX:s,tileY:n,zoom:r,layerName:o}=t.payload,d=nt(e,s,n,r,o),h=rt(d),a={type:"PARSE_MVT_RESULT",id:t.id,result:d};self.postMessage(a,{transfer:h});break}default:{const e={type:"ERROR",id:t.id||"unknown",error:`MVT worker received unsupported request type: ${t.type}`};self.postMessage(e)}}}catch(e){const s={type:"ERROR",id:t.id,error:e instanceof Error?e.message:"Unknown error in MVT worker"};self.postMessage(s)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=mvt-parse.worker-BEXT26SN.js.map
