(function(){"use strict";var P=Uint8Array,O=Uint16Array,ht=Int32Array,Ee=new P([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),be=new P([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ct=new P([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ce=function(r,e){for(var t=new O(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var n=new ht(t[30]),i=1;i<30;++i)for(var s=t[i];s<t[i+1];++s)n[s]=s-t[i]<<5|i;return{b:t,r:n}},Le=Ce(Ee,2),Ve=Le.b,ut=Le.r;Ve[28]=258,ut[258]=28;for(var ft=Ce(be,0),dt=ft.b,ce=new O(32768),x=0;x<32768;++x){var U=(x&43690)>>1|(x&21845)<<1;U=(U&52428)>>2|(U&13107)<<2,U=(U&61680)>>4|(U&3855)<<4,ce[x]=((U&65280)>>8|(U&255)<<8)>>1}for(var Z=(function(r,e,t){for(var i=r.length,n=0,s=new O(e);n<i;++n)r[n]&&++s[r[n]-1];var o=new O(e);for(n=1;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new O(1<<e);var c=15-e;for(n=0;n<i;++n)if(r[n])for(var h=n<<4|r[n],f=e-r[n],l=o[r[n]-1]++<<f,u=l|(1<<f)-1;l<=u;++l)a[ce[l]>>c]=h}else for(a=new O(i),n=0;n<i;++n)r[n]&&(a[n]=ce[o[r[n]-1]++]>>15-r[n]);return a}),K=new P(288),x=0;x<144;++x)K[x]=8;for(var x=144;x<256;++x)K[x]=9;for(var x=256;x<280;++x)K[x]=7;for(var x=280;x<288;++x)K[x]=8;for(var ke=new P(32),x=0;x<32;++x)ke[x]=5;var pt=Z(K,9,1),yt=Z(ke,5,1),ue=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},b=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},fe=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},gt=function(r){return(r+7)/8|0},wt=function(r,e,t){return(t==null||t>r.length)&&(t=r.length),new P(r.subarray(e,t))},xt=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(r,e,t){var i=new Error(e||xt[r]);if(i.code=r,Error.captureStackTrace&&Error.captureStackTrace(i,T),!t)throw i;return i},de=function(r,e,t,i){var n=r.length,s=0;if(!n||e.f&&!e.l)return t||new P(0);var o=!t,a=o||e.i!=2,c=e.i;o&&(t=new P(n*3));var h=function(ot){var at=t.length;if(ot>at){var lt=new P(Math.max(at*2,ot));lt.set(t),t=lt}},f=e.f||0,l=e.p||0,u=e.b||0,p=e.l,m=e.d,y=e.m,_=e.n,d=n*8;do{if(!p){f=b(r,l,1);var w=b(r,l+1,3);if(l+=3,w)if(w==1)p=pt,m=yt,y=9,_=5;else if(w==2){var V=b(r,l,31)+257,Q=b(r,l+10,15)+4,Xe=V+b(r,l+5,31)+1;l+=14;for(var X=new P(Xe),Pe=new P(19),E=0;E<Q;++E)Pe[ct[E]]=b(r,l+E*3,7);l+=Q*3;for(var et=ue(Pe),Sr=(1<<et)-1,_r=Z(Pe,et,1),E=0;E<Xe;){var tt=_r[b(r,l,Sr)];l+=tt&15;var F=tt>>4;if(F<16)X[E++]=F;else{var $=0,he=0;for(F==16?(he=3+b(r,l,3),l+=2,$=X[E-1]):F==17?(he=3+b(r,l,7),l+=3):F==18&&(he=11+b(r,l,127),l+=7);he--;)X[E++]=$}}var rt=X.subarray(0,V),R=X.subarray(V);y=ue(rt),_=ue(R),p=Z(rt,y,1),m=Z(R,_,1)}else T(1);else{var F=gt(l)+4,C=r[F-4]|r[F-3]<<8,A=F+C;if(A>n){c&&T(0);break}a&&h(u+C),t.set(r.subarray(F,A),u),e.b=u+=C,e.p=l=A*8,e.f=f;continue}if(l>d){c&&T(0);break}}a&&h(u+131072);for(var Er=(1<<y)-1,br=(1<<_)-1,Te=l;;Te=l){var $=p[fe(r,l)&Er],W=$>>4;if(l+=$&15,l>d){c&&T(0);break}if($||T(2),W<256)t[u++]=W;else if(W==256){Te=l,p=null;break}else{var it=W-254;if(W>264){var E=W-257,ee=Ee[E];it=b(r,l,(1<<ee)-1)+Ve[E],l+=ee}var Se=m[fe(r,l)&br],_e=Se>>4;Se||T(3),l+=Se&15;var R=dt[_e];if(_e>3){var ee=be[_e];R+=fe(r,l)&(1<<ee)-1,l+=ee}if(l>d){c&&T(0);break}a&&h(u+131072);var nt=u+it;if(u<R){var st=s-R,Cr=Math.min(R,nt);for(st+u<0&&T(3);u<Cr;++u)t[u]=i[st+u]}for(;u<nt;++u)t[u]=t[u-R]}}e.l=p,e.p=Te,e.b=u,e.f=f,p&&(f=1,e.m=y,e.d=m,e.n=_)}while(!f);return u!=t.length&&o?wt(t,0,u):t.subarray(0,u)},mt=new P(0),vt=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&T(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var i=(e>>3&1)+(e>>4&1);i>0;i-=!r[t++]);return t+(e&2)},Ft=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},Mt=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&T(6,"invalid zlib data"),(r[1]>>5&1)==1&&T(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function Pt(r,e){return de(r,{i:2},e,e)}function Tt(r,e){var t=vt(r);return t+8>r.length&&T(6,"invalid gzip data"),de(r.subarray(t,-8),{i:2},new P(Ft(r)),e)}function St(r,e){return de(r.subarray(Mt(r),-4),{i:2},e,e)}function _t(r,e){return r[0]==31&&r[1]==139&&r[2]==8?Tt(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?Pt(r,e):St(r,e)}var Et=typeof TextDecoder<"u"&&new TextDecoder,bt=0;try{Et.decode(mt,{stream:!0}),bt=1}catch{}var Ct=Object.defineProperty,Lt=Math.pow,g=(r,e)=>Ct(r,"name",{value:e,configurable:!0}),M=(r,e,t)=>new Promise((i,n)=>{var s=c=>{try{a(t.next(c))}catch(h){n(h)}},o=c=>{try{a(t.throw(c))}catch(h){n(h)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(r,e)).next())});g((r,e)=>{let t=!1,i="",n=L.GridLayer.extend({createTile:g((s,o)=>{let a=document.createElement("img"),c=new AbortController,h=c.signal;return a.cancel=()=>{c.abort()},t||(r.getHeader().then(f=>{f.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):f.tileType===2?i="image/png":f.tileType===3?i="image/jpeg":f.tileType===4?i="image/webp":f.tileType===5&&(i="image/avif")}),t=!0),r.getZxy(s.z,s.x,s.y,h).then(f=>{if(f){let l=new Blob([f.data],{type:i}),u=window.URL.createObjectURL(l);a.src=u}else a.style.display="none";a.cancel=void 0,o(void 0,a)}).catch(f=>{if(f.name!=="AbortError")throw f}),a},"createTile"),_removeTile:g(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new n(e)},"leafletRasterLayer");var Vt=g(r=>(e,t)=>{if(t instanceof AbortController)return r(e,t);let i=new AbortController;return r(e,i).then(n=>t(void 0,n.data,n.cacheControl||"",n.expires||""),n=>t(n)).catch(n=>t(n)),{cancel:g(()=>i.abort(),"cancel")}},"v3compat"),kt=class{constructor(e){this.tilev4=g((t,i)=>M(this,null,function*(){if(t.type==="json"){let p=t.url.substr(10),m=this.tiles.get(p);if(m||(m=new re(p),this.tiles.set(p,m)),this.metadata){let _=yield m.getTileJson(t.url);return i.signal.throwIfAborted(),{data:_}}let y=yield m.getHeader();return i.signal.throwIfAborted(),(y.minLon>=y.maxLon||y.minLat>=y.maxLat)&&console.error(`Bounds of PMTiles archive ${y.minLon},${y.minLat},${y.maxLon},${y.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:y.minZoom,maxzoom:y.maxZoom,bounds:[y.minLon,y.minLat,y.maxLon,y.maxLat]}}}let n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(n);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new re(o),this.tiles.set(o,a));let c=s[2],h=s[3],f=s[4],l=yield a.getHeader(),u=yield a==null?void 0:a.getZxy(+c,+h,+f,i.signal);if(i.signal.throwIfAborted(),u)return{data:new Uint8Array(u.data),cacheControl:u.cacheControl,expires:u.expires};if(l.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=Vt(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};g(kt,"Protocol");function De(r,e){return(e>>>0)*4294967296+(r>>>0)}g(De,"toNum");function Ue(r,e){let t=e.buf,i=t[e.pos++],n=(i&112)>>4;if(i<128||(i=t[e.pos++],n|=(i&127)<<3,i<128)||(i=t[e.pos++],n|=(i&127)<<10,i<128)||(i=t[e.pos++],n|=(i&127)<<17,i<128)||(i=t[e.pos++],n|=(i&127)<<24,i<128)||(i=t[e.pos++],n|=(i&1)<<31,i<128))return De(r,n);throw new Error("Expected varint not more than 10 bytes")}g(Ue,"readVarintRemainder");function z(r){let e=r.buf,t=e[r.pos++],i=t&127;return t<128||(t=e[r.pos++],i|=(t&127)<<7,t<128)||(t=e[r.pos++],i|=(t&127)<<14,t<128)||(t=e[r.pos++],i|=(t&127)<<21,t<128)?i:(t=e[r.pos],i|=(t&15)<<28,Ue(i,r))}g(z,"readVarint");function pe(r,e,t,i,n){return n===0?i!==0?[r-1-t,r-1-e]:[t,e]:[e,t]}g(pe,"rotate");function Be(r,e,t){if(r>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>=1<<r||t>=1<<r)throw new Error("tile x/y outside zoom level bounds");let i=((1<<r)*(1<<r)-1)/3,n=r-1,[s,o]=[e,t];for(let a=1<<n;a>0;a>>=1){let c=s&a,h=o&a;i+=(3*c^h)*(1<<n),[s,o]=pe(a,s,o,c,h),n--}return i}g(Be,"zxyToTileId");function Ie(r){let e=3*r+1;return e<4294967296?31-Math.clz32(e):63-Math.clz32(e/4294967296)}g(Ie,"tileIdToZ");function Dt(r){let e=Ie(r)>>1;if(e>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");let t=((1<<e)*(1<<e)-1)/3,i=r-t,n=0,s=0,o=1<<e;for(let a=1;a<o;a<<=1){let c=a&i/2,h=a&(i^c);[n,s]=pe(a,n,s,c,h),i=i/2,n+=c,s+=h}return[e,n,s]}g(Dt,"tileIdToZxy");var Ut=(r=>(r[r.Unknown=0]="Unknown",r[r.None=1]="None",r[r.Gzip=2]="Gzip",r[r.Brotli=3]="Brotli",r[r.Zstd=4]="Zstd",r))(Ut||{});function te(r,e){return M(this,null,function*(){if(e===1||e===0)return r;if(e===2){if(typeof globalThis.DecompressionStream>"u")return _t(new Uint8Array(r));let t=new Response(r).body;if(!t)throw new Error("Failed to read response stream");let i=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(i).arrayBuffer()}throw new Error("Compression method not supported")})}g(te,"defaultDecompress");var Bt=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(Bt||{});function Ae(r){return r===1?".mvt":r===2?".png":r===3?".jpg":r===4?".webp":r===5?".avif":""}g(Ae,"tileTypeExt");var It=127;function Re(r,e){let t=0,i=r.length-1;for(;t<=i;){let n=i+t>>1,s=e-r[n].tileId;if(s>0)t=n+1;else if(s<0)i=n-1;else return r[n]}return i>=0&&(r[i].runLength===0||e-r[i].tileId<r[i].runLength)?r[i]:null}g(Re,"findTile");var At=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return M(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};g(At,"FileSource");var Oe=class{constructor(e,t=new Headers){var i,n;this.url=e,this.customHeaders=t,this.mustReload=!1;let s="";"navigator"in globalThis&&(s=(n=(i=globalThis.navigator)==null?void 0:i.userAgent)!=null?n:"");let o=s.indexOf("Windows")>-1,a=/Chrome|Chromium|Edg|OPR|Brave/.test(s);this.chromeWindowsNoCache=!1,o&&a&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,i,n){return M(this,null,function*(){let s,o;i?o=i:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let c;this.mustReload?c="reload":this.chromeWindowsNoCache&&(c="no-store");let h=yield fetch(this.url,{signal:o,cache:c,headers:a});if(e===0&&h.status===416){let u=h.headers.get("Content-Range");if(!u||!u.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let p=+u.substr(8);h=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${p-1}`}})}let f=h.headers.get("Etag");if(f!=null&&f.startsWith("W/")&&(f=null),h.status===416||n&&f&&f!==n)throw this.mustReload=!0,new ge(`Server returned non-matching ETag ${n} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(h.status>=300)throw new Error(`Bad response code: ${h.status}`);let l=h.headers.get("Content-Length");if(h.status===200&&(!l||+l>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield h.arrayBuffer(),etag:f||void 0,cacheControl:h.headers.get("Cache-Control")||void 0,expires:h.headers.get("Expires")||void 0}})}};g(Oe,"FetchSource");var Rt=Oe;function S(r,e){let t=r.getUint32(e+4,!0),i=r.getUint32(e+0,!0);return t*Lt(2,32)+i}g(S,"getUint64");function ze(r,e){let t=new DataView(r),i=t.getUint8(7);if(i>3)throw new Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:S(t,8),rootDirectoryLength:S(t,16),jsonMetadataOffset:S(t,24),jsonMetadataLength:S(t,32),leafDirectoryOffset:S(t,40),leafDirectoryLength:S(t,48),tileDataOffset:S(t,56),tileDataLength:S(t,64),numAddressedTiles:S(t,72),numTileEntries:S(t,80),numTileContents:S(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}g(ze,"bytesToHeader");function ye(r){let e={buf:new Uint8Array(r),pos:0},t=z(e),i=[],n=0;for(let s=0;s<t;s++){let o=z(e);i.push({tileId:n+o,offset:0,length:0,runLength:1}),n+=o}for(let s=0;s<t;s++)i[s].runLength=z(e);for(let s=0;s<t;s++)i[s].length=z(e);for(let s=0;s<t;s++){let o=z(e);o===0&&s>0?i[s].offset=i[s-1].offset+i[s-1].length:i[s].offset=o-1}return i}g(ye,"deserializeIndex");var He=class extends Error{};g(He,"EtagMismatch");var ge=He;function we(r,e){return M(this,null,function*(){let t=yield r.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let i=t.data.slice(0,It),n=ze(i,t.etag),s=t.data.slice(n.rootDirectoryOffset,n.rootDirectoryOffset+n.rootDirectoryLength),o=`${r.getKey()}|${n.etag||""}|${n.rootDirectoryOffset}|${n.rootDirectoryLength}`,a=ye(yield e(s,n.internalCompression));return[n,[o,a.length,a]]})}g(we,"getHeaderAndRoot");function xe(r,e,t,i,n){return M(this,null,function*(){let s=yield r.getBytes(t,i,void 0,n.etag),o=yield e(s.data,n.internalCompression),a=ye(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}g(xe,"getDirectory");var Ot=class{constructor(e=100,t=!0,i=te){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=i}getHeader(e){return M(this,null,function*(){let t=e.getKey(),i=this.cache.get(t);if(i)return i.lastUsed=this.counter++,i.data;let n=yield we(e,this.decompress);return n[1]&&this.cache.set(n[1][0],{lastUsed:this.counter++,data:n[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:n[0]}),this.prune(),n[0]})}getDirectory(e,t,i,n){return M(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${i}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield xe(e,this.decompress,t,i,n);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((i,n)=>{i.lastUsed<e&&(e=i.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return M(this,null,function*(){this.cache.delete(e.getKey())})}};g(Ot,"ResolvedValueCache");var Ne=class{constructor(e=100,t=!0,i=te){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=i}getHeader(e){return M(this,null,function*(){let t=e.getKey(),i=this.cache.get(t);if(i)return i.lastUsed=this.counter++,yield i.data;let n=new Promise((s,o)=>{we(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:n}),n})}getDirectory(e,t,i,n){return M(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${i}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((c,h)=>{xe(e,this.decompress,t,i,n).then(f=>{c(f),this.prune()}).catch(f=>{h(f)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((i,n)=>{i.lastUsed<e&&(e=i.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return M(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let i=new Promise((n,s)=>{this.getHeader(e).then(o=>{n(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,i)})}};g(Ne,"SharedPromiseCache");var zt=Ne,$e=class{constructor(e,t,i){typeof e=="string"?this.source=new Rt(e):this.source=e,i?this.decompress=i:this.decompress=te,t?this.cache=t:this.cache=new zt}getHeader(){return M(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,i,n){return M(this,null,function*(){let s=Be(e,t,i),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,c=o.rootDirectoryLength;for(let h=0;h<=3;h++){let f=yield this.cache.getDirectory(this.source,a,c,o),l=Re(f,s);if(l){if(l.runLength>0){let u=yield this.source.getBytes(o.tileDataOffset+l.offset,l.length,n,o.etag);return{data:yield this.decompress(u.data,o.tileCompression),cacheControl:u.cacheControl,expires:u.expires}}a=o.leafDirectoryOffset+l.offset,c=l.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,i,n){return M(this,null,function*(){try{return yield this.getZxyAttempt(e,t,i,n)}catch(s){if(s instanceof ge)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,i,n);throw s}})}getMetadataAttempt(){return M(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),i=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(i))})}getMetadata(){return M(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof ge)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return M(this,null,function*(){let t=yield this.getHeader(),i=yield this.getMetadata(),n=Ae(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${n}`],vector_layers:i.vector_layers,attribution:i.attribution,description:i.description,name:i.name,version:i.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};g($e,"PMTiles");var re=$e;function B(r,e){this.x=r,this.y=e}B.prototype={clone(){return new B(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const e=r.x-this.x,t=r.y-this.y;return e*e+t*t},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){const e=r[0]*this.x+r[1]*this.y,t=r[2]*this.x+r[3]*this.y;return this.x=e,this.y=t,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const e=Math.cos(r),t=Math.sin(r),i=e*this.x-t*this.y,n=t*this.x+e*this.y;return this.x=i,this.y=n,this},_rotateAround(r,e){const t=Math.cos(r),i=Math.sin(r),n=e.x+t*(this.x-e.x)-i*(this.y-e.y),s=e.y+i*(this.x-e.x)+t*(this.y-e.y);return this.x=n,this.y=s,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:B},B.convert=function(r){if(r instanceof B)return r;if(Array.isArray(r))return new B(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new B(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};class We{constructor(e,t,i,n,s){this.properties={},this.extent=i,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=n,this._values=s,e.readFields(Ht,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,i=[];let n,s=1,o=0,a=0,c=0;for(;e.pos<t;){if(o<=0){const h=e.readVarint();s=h&7,o=h>>3}if(o--,s===1||s===2)a+=e.readSVarint(),c+=e.readSVarint(),s===1&&(n&&i.push(n),n=[]),n&&n.push(new B(a,c));else if(s===7)n&&n.push(n[0].clone());else throw new Error(`unknown command ${s}`)}return n&&i.push(n),i}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let i=1,n=0,s=0,o=0,a=1/0,c=-1/0,h=1/0,f=-1/0;for(;e.pos<t;){if(n<=0){const l=e.readVarint();i=l&7,n=l>>3}if(n--,i===1||i===2)s+=e.readSVarint(),o+=e.readSVarint(),s<a&&(a=s),s>c&&(c=s),o<h&&(h=o),o>f&&(f=o);else if(i!==7)throw new Error(`unknown command ${i}`)}return[a,h,c,f]}toGeoJSON(e,t,i){const n=this.extent*Math.pow(2,i),s=this.extent*e,o=this.extent*t,a=this.loadGeometry();function c(u){return[(u.x+s)*360/n-180,360/Math.PI*Math.atan(Math.exp((1-(u.y+o)*2/n)*Math.PI))-90]}function h(u){return u.map(c)}let f;if(this.type===1){const u=[];for(const m of a)u.push(m[0]);const p=h(u);f=u.length===1?{type:"Point",coordinates:p[0]}:{type:"MultiPoint",coordinates:p}}else if(this.type===2){const u=a.map(h);f=u.length===1?{type:"LineString",coordinates:u[0]}:{type:"MultiLineString",coordinates:u}}else if(this.type===3){const u=$t(a),p=[];for(const m of u)p.push(m.map(h));f=p.length===1?{type:"Polygon",coordinates:p[0]}:{type:"MultiPolygon",coordinates:p}}else throw new Error("unknown feature type");const l={type:"Feature",geometry:f,properties:this.properties};return this.id!=null&&(l.id=this.id),l}}We.types=["Unknown","Point","LineString","Polygon"];function Ht(r,e,t){r===1?e.id=t.readVarint():r===2?Nt(t,e):r===3?e.type=t.readVarint():r===4&&(e._geometry=t.pos)}function Nt(r,e){const t=r.readVarint()+r.pos;for(;r.pos<t;){const i=e._keys[r.readVarint()],n=e._values[r.readVarint()];e.properties[i]=n}}function $t(r){const e=r.length;if(e<=1)return[r];const t=[];let i,n;for(let s=0;s<e;s++){const o=Wt(r[s]);o!==0&&(n===void 0&&(n=o<0),n===o<0?(i&&t.push(i),i=[r[s]]):i&&i.push(r[s]))}return i&&t.push(i),t}function Wt(r){let e=0;for(let t=0,i=r.length,n=i-1,s,o;t<i;n=t++)s=r[t],o=r[n],e+=(o.x-s.x)*(s.y+o.y);return e}class Zt{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Kt,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new We(this._pbf,t,this.extent,this._keys,this._values)}}function Kt(r,e,t){r===15?e.version=t.readVarint():r===1?e.name=t.readString():r===5?e.extent=t.readVarint():r===2?e._features.push(t.pos):r===3?e._keys.push(t.readString()):r===4&&e._values.push(jt(t))}function jt(r){let e=null;const t=r.readVarint()+r.pos;for(;r.pos<t;){const i=r.readVarint()>>3;e=i===1?r.readString():i===2?r.readFloat():i===3?r.readDouble():i===4?r.readVarint64():i===5?r.readVarint():i===6?r.readSVarint():i===7?r.readBoolean():null}if(e==null)throw new Error("unknown feature value");return e}class qt{constructor(e,t){this.layers=e.readFields(Gt,{},t)}}function Gt(r,e,t){if(r===3){const i=new Zt(t,t.readVarint()+t.pos);i.length&&(e[i.name]=i)}}const me=65536*65536,Ze=1/me,Jt=12,Ke=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),ve=0,ie=1,j=2,ne=5;class Yt{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,i=this.length){for(;this.pos<i;){const n=this.readVarint(),s=n>>3,o=this.pos;this.type=n&7,e(s,t,this),this.pos===o&&this.skip(n)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*me;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*me;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let i,n;return n=t[this.pos++],i=n&127,n<128||(n=t[this.pos++],i|=(n&127)<<7,n<128)||(n=t[this.pos++],i|=(n&127)<<14,n<128)||(n=t[this.pos++],i|=(n&127)<<21,n<128)?i:(n=t[this.pos],i|=(n&15)<<28,Qt(i,e,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2===1?(e+1)/-2:e/2}readBoolean(){return!!this.readVarint()}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=Jt&&Ke?Ke.decode(this.buf.subarray(t,e)):ur(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const i=this.readPackedEnd();for(;this.pos<i;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return this.type===j?this.readVarint()+this.pos:this.pos+1}skip(e){const t=e&7;if(t===ve)for(;this.buf[this.pos++]>127;);else if(t===j)this.pos=this.readVarint()+this.pos;else if(t===ne)this.pos+=4;else if(t===ie)this.pos+=8;else throw new Error(`Unimplemented type: ${t}`)}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Ze),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Ze),!0),this.pos+=8}writeVarint(e){if(e=+e||0,e>268435455||e<0){Xt(e,this);return}this.realloc(4),this.buf[this.pos++]=e&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=e>>>7&127)))}writeSVarint(e){this.writeVarint(e<0?-e*2-1:e*2)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(e.length*4),this.pos++;const t=this.pos;this.pos=fr(this.buf,e,this.pos);const i=this.pos-t;i>=128&&je(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let i=0;i<t;i++)this.buf[this.pos++]=e[i]}writeRawMessage(e,t){this.pos++;const i=this.pos;e(t,this);const n=this.pos-i;n>=128&&je(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n}writeMessage(e,t,i){this.writeTag(e,j),this.writeRawMessage(t,i)}writePackedVarint(e,t){t.length&&this.writeMessage(e,rr,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,ir,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,or,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,nr,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,sr,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,ar,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,lr,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,hr,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,cr,t)}writeBytesField(e,t){this.writeTag(e,j),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,ne),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,ne),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,ie),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,ie),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,ve),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,ve),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,j),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,ne),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,ie),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function Qt(r,e,t){const i=t.buf;let n,s;if(s=i[t.pos++],n=(s&112)>>4,s<128||(s=i[t.pos++],n|=(s&127)<<3,s<128)||(s=i[t.pos++],n|=(s&127)<<10,s<128)||(s=i[t.pos++],n|=(s&127)<<17,s<128)||(s=i[t.pos++],n|=(s&127)<<24,s<128)||(s=i[t.pos++],n|=(s&1)<<31,s<128))return H(r,n,e);throw new Error("Expected varint not more than 10 bytes")}function H(r,e,t){return t?e*4294967296+(r>>>0):(e>>>0)*4294967296+(r>>>0)}function Xt(r,e){let t,i;if(r>=0?(t=r%4294967296|0,i=r/4294967296|0):(t=~(-r%4294967296),i=~(-r/4294967296),t^4294967295?t=t+1|0:(t=0,i=i+1|0)),r>=18446744073709552e3||r<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),er(t,i,e),tr(i,e)}function er(r,e,t){t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos++]=r&127|128,r>>>=7,t.buf[t.pos]=r&127}function tr(r,e){const t=(r&7)<<4;e.buf[e.pos++]|=t|((r>>>=3)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127|((r>>>=7)?128:0),r&&(e.buf[e.pos++]=r&127)))))}function je(r,e,t){const i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));t.realloc(i);for(let n=t.pos-1;n>=r;n--)t.buf[n+i]=t.buf[n]}function rr(r,e){for(let t=0;t<r.length;t++)e.writeVarint(r[t])}function ir(r,e){for(let t=0;t<r.length;t++)e.writeSVarint(r[t])}function nr(r,e){for(let t=0;t<r.length;t++)e.writeFloat(r[t])}function sr(r,e){for(let t=0;t<r.length;t++)e.writeDouble(r[t])}function or(r,e){for(let t=0;t<r.length;t++)e.writeBoolean(r[t])}function ar(r,e){for(let t=0;t<r.length;t++)e.writeFixed32(r[t])}function lr(r,e){for(let t=0;t<r.length;t++)e.writeSFixed32(r[t])}function hr(r,e){for(let t=0;t<r.length;t++)e.writeFixed64(r[t])}function cr(r,e){for(let t=0;t<r.length;t++)e.writeSFixed64(r[t])}function ur(r,e,t){let i="",n=e;for(;n<t;){const s=r[n];let o=null,a=s>239?4:s>223?3:s>191?2:1;if(n+a>t)break;let c,h,f;a===1?s<128&&(o=s):a===2?(c=r[n+1],(c&192)===128&&(o=(s&31)<<6|c&63,o<=127&&(o=null))):a===3?(c=r[n+1],h=r[n+2],(c&192)===128&&(h&192)===128&&(o=(s&15)<<12|(c&63)<<6|h&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):a===4&&(c=r[n+1],h=r[n+2],f=r[n+3],(c&192)===128&&(h&192)===128&&(f&192)===128&&(o=(s&15)<<18|(c&63)<<12|(h&63)<<6|f&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,a=1):o>65535&&(o-=65536,i+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),i+=String.fromCharCode(o),n+=a}return i}function fr(r,e,t){for(let i=0,n,s;i<e.length;i++){if(n=e.charCodeAt(i),n>55295&&n<57344)if(s)if(n<56320){r[t++]=239,r[t++]=191,r[t++]=189,s=n;continue}else n=s-55296<<10|n-56320|65536,s=null;else{n>56319||i+1===e.length?(r[t++]=239,r[t++]=191,r[t++]=189):s=n;continue}else s&&(r[t++]=239,r[t++]=191,r[t++]=189,s=null);n<128?r[t++]=n:(n<2048?r[t++]=n>>6|192:(n<65536?r[t++]=n>>12|224:(r[t++]=n>>18|240,r[t++]=n>>12&63|128),r[t++]=n>>6&63|128),r[t++]=n&63|128)}return t}const v={ocean:1990538,sea:1990538,lake:2783920,reservoir:2783920,pond:3377339,river:2783920,stream:3377339,canal:2783920,water:1990538,bathymetry:1990538,forest:1723694,wood:1987888,grass:5934922,shrub:3832376,crop:9414744,barren:10518624,wetland:3827784,swamp:3827784,mangrove:2773056,moss:6982224,snow:15266040,urban:6974058,park:4882512,meadow:5934922,farmland:9414744,residential:7368816,commercial:7895160,industrial:6316128,land:9414784,default:9414784},Fe={motorway:{color:11051152,width:3},trunk:{color:10130568,width:2.5},primary:{color:9209984,width:2},secondary:{color:8288884,width:1.5},tertiary:{color:7367784,width:1.2},residential:{color:6710886,width:.8},unclassified:{color:5592405,width:.6},service:{color:4473924,width:.4},living_street:{color:5592405,width:.6},pedestrian:{color:8947848,width:.5},footway:{color:7829367,width:.3},path:{color:6710886,width:.3},cycleway:{color:5933658,width:.4},rail:{color:3355443,width:1},subway:{color:3355443,width:.8},tram:{color:3355443,width:.6},default:{color:5592405,width:.5}},I=[{depth:0,color:{r:74,g:176,b:208}},{depth:200,color:{r:58,g:154,b:192}},{depth:1e3,color:{r:42,g:128,b:176}},{depth:2e3,color:{r:30,g:95,b:138}},{depth:4e3,color:{r:21,g:69,b:112}},{depth:6e3,color:{r:13,g:48,b:85}},{depth:1e4,color:{r:8,g:32,b:64}}],dr=["river","stream","canal","drain","ditch","waterway"],pr=["ocean","sea","bay","strait","gulf","sound","harbour","harbor"],qe={service:0,path:1,footway:2,cycleway:3,pedestrian:4,unclassified:5,living_street:6,residential:7,tertiary:8,secondary:9,primary:10,trunk:11,motorway:12};function k(r){return"#"+r.toString(16).padStart(6,"0")}function yr(r){const e=Math.max(0,Math.min(r,1e4));let t=I[0],i=I[I.length-1];for(let h=0;h<I.length-1;h++)if(e>=I[h].depth&&e<=I[h+1].depth){t=I[h],i=I[h+1];break}const n=i.depth-t.depth,s=n>0?(e-t.depth)/n:0,o=Math.round(t.color.r+s*(i.color.r-t.color.r)),a=Math.round(t.color.g+s*(i.color.g-t.color.g)),c=Math.round(t.color.b+s*(i.color.b-t.color.b));return o<<16|a<<8|c}function Me(r,e){const i=(e.subtype||e.class||e.type||e.category||"").toLowerCase();if(r==="bathymetry"){const n=typeof e.depth=="number"?e.depth:0;return yr(n)}return r==="land_cover"?v[i]??v.grass:v[i]?v[i]:r==="water"?v.water:r==="land"?v.land:r==="land_use"?i.includes("forest")||i.includes("wood")?v.forest:i.includes("park")||i.includes("recreation")?v.park:i.includes("grass")||i.includes("green")||i.includes("meadow")?v.grass:i.includes("farm")||i.includes("orchard")||i.includes("vineyard")?v.crop:i.includes("water")||i.includes("basin")?v.water:i.includes("residential")?v.residential:i.includes("commercial")||i.includes("retail")?v.commercial:i.includes("industrial")?v.industrial:i.includes("cemetery")||i.includes("grave")?v.grass:v.land:v.default}function gr(r){if(!r)return Fe.default;const t=(r.class||r.road_class||r.highway||"").toLowerCase();return Fe[t]??Fe.default}function wr(r,e){const t=r.east-r.west,i=r.north-r.south;return(n,s)=>({x:(n-r.west)/t*e,y:(r.north-s)/i*e})}function Ge(r,e,t){if(!e||e.length===0)return;r.beginPath();const i=e[0];if(!i||i.length===0)return;const n=t(i[0][0],i[0][1]);r.moveTo(n.x,n.y);for(let s=1;s<i.length;s++){const o=t(i[s][0],i[s][1]);r.lineTo(o.x,o.y)}r.closePath();for(let s=1;s<e.length;s++){const o=e[s];if(!o||o.length===0)continue;const a=t(o[0][0],o[0][1]);r.moveTo(a.x,a.y);for(let c=1;c<o.length;c++){const h=t(o[c][0],o[c][1]);r.lineTo(h.x,h.y)}r.closePath()}}function q(r,e,t,i){if(t==="Polygon")Ge(r,e,i);else if(t==="MultiPolygon")for(const n of e)Ge(r,n,i)}function Je(r,e,t){if(!e||e.length<2)return;r.beginPath();const i=t(e[0][0],e[0][1]);r.moveTo(i.x,i.y);for(let n=1;n<e.length;n++){const s=t(e[n][0],e[n][1]);r.lineTo(s.x,s.y)}r.stroke()}function Ye(r,e,t,i){if(t==="LineString")Je(r,e,i);else if(t==="MultiLineString")for(const n of e)Je(r,n,i)}function xr(r,e,t,i){const n=r.width,s=r.getContext("2d");if(!s)return;s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const o=wr(i,n),c=(i.east-i.west)*111320*Math.cos((i.north+i.south)/2*Math.PI/180)/n,h=[],f=[],l=[],u=[],p=[],m=[];for(const d of e){const w=d.layer,F=(d.properties.subtype||d.properties.class||"").toLowerCase();if(w==="land")(d.type==="Polygon"||d.type==="MultiPolygon")&&h.push(d);else if(w==="land_use")f.push(d);else if(w==="land_cover")l.push(d);else if(w==="water"){if(d.type==="LineString"||d.type==="MultiLineString")dr.includes(F)&&u.push(d);else if(d.type==="Polygon"||d.type==="MultiPolygon"){const C=d.properties._fromLowerZoom===!0;pr.includes(F)||C?m.push(d):p.push(d)}}}const y=m.length>0&&h.length<10;if(y?(s.fillStyle=k(v.water),s.fillRect(0,0,n,n)):(s.fillStyle=k(v.land),s.fillRect(0,0,n,n)),y&&h.length>0){s.save(),s.fillStyle=k(v.land);for(const d of h)q(s,d.coordinates,d.type,o),s.fill("evenodd");s.restore()}s.save();for(const d of f){if(d.type!=="Polygon"&&d.type!=="MultiPolygon")continue;const w=Me("land_use",d.properties);s.fillStyle=k(w),q(s,d.coordinates,d.type,o),s.fill("evenodd")}s.restore(),s.save();for(const d of l){if(d.type!=="Polygon"&&d.type!=="MultiPolygon")continue;const w=Me("land_cover",d.properties);s.fillStyle=k(w),q(s,d.coordinates,d.type,o),s.fill("evenodd")}s.restore(),s.save(),s.strokeStyle=k(v.river),s.lineWidth=Math.max(1,3/c),s.lineCap="round",s.lineJoin="round";for(const d of u)Ye(s,d.coordinates,d.type,o);s.restore(),s.save();for(const d of m)s.fillStyle=k(v.water),q(s,d.coordinates,d.type,o),s.fill("evenodd");for(const d of p){const w=Me("water",d.properties);s.fillStyle=k(w),q(s,d.coordinates,d.type,o),s.fill("evenodd")}s.restore();const _=t.filter(d=>{var F;if(d.layer==="connector"||d.layer!=="segment"||d.type!=="LineString"&&d.type!=="MultiLineString"||((F=d.properties)==null?void 0:F.subtype)!=="road")return!1;const w=d.properties;if(typeof w.road_flags=="string")try{if(JSON.parse(w.road_flags).some(V=>{var Q;return(Q=V.values)==null?void 0:Q.includes("is_tunnel")}))return!1}catch{}if(typeof w.level_rules=="string")try{const C=JSON.parse(w.level_rules);if(C.length>0&&C.every(V=>typeof V.value=="number"&&V.value<0))return!1}catch{}return!(w.is_tunnel===!0||w.is_underground===!0||typeof w.level=="number"&&w.level<0)}).sort((d,w)=>{var A,V;const F=(((A=d.properties)==null?void 0:A.class)||"default").toLowerCase(),C=(((V=w.properties)==null?void 0:V.class)||"default").toLowerCase();return(qe[F]??5)-(qe[C]??5)});s.save(),s.lineCap="round",s.lineJoin="round";for(const d of _){const w=gr(d.properties),F=Math.max(1,w.width*5/c);s.strokeStyle=k(w.color),s.lineWidth=F,Ye(s,d.coordinates,d.type,o)}s.restore()}let D=null,G=null,se=!1,N=null,oe=null,ae=null,le=!1;try{le=new OffscreenCanvas(1,1).getContext("2d")!==null}catch{le=!1}console.log("[FullPipelineWorker] Loaded v2 - using geoToCanvas fix from offscreen-renderer");async function Qe(r,e){if(!(se&&oe===r&&ae===e)){if(N)if(oe!==r||ae!==e)await N,se=!1;else{await N;return}N=(async()=>{try{oe=r,ae=e,D=new re(r),G=new re(e),await Promise.all([D.getHeader(),G.getHeader()]),se=!0}catch(t){throw console.error("[FullPipelineWorker] Failed to initialize PMTiles:",t),D=null,G=null,oe=null,ae=null,se=!1,t}})();try{await N}finally{N=null}}}function mr(r,e,t){const i=Math.PI-2*Math.PI*e/Math.pow(2,t),n=180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i))),s=Math.PI-2*Math.PI*(e+1)/Math.pow(2,t),o=180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s))),a=r/Math.pow(2,t)*360-180,c=(r+1)/Math.pow(2,t)*360-180;return{north:n,south:o,west:a,east:c}}function J(r,e,t,i,n=null){const s=new qt(new Yt(r)),o=[],a=Object.keys(s.layers),c=n&&s.layers[n]?[n]:a;for(const h of c){const f=s.layers[h];if(f)for(let l=0;l<f.length;l++){const u=f.feature(l),p=u.toGeoJSON(e,t,i);o.push({type:p.geometry.type,coordinates:p.geometry.coordinates,properties:u.properties,layer:h})}}return o}async function Y(r,e,t,i){try{const n=await r.getZxy(e,t,i);return(n==null?void 0:n.data)??null}catch(n){return console.warn(`[FullPipelineWorker] Failed to fetch tile ${e}/${t}/${i}:`,n),null}}const vr=[10,8,6];async function Fr(r,e,t){if(!D)return[];const i=[],n=new Set;for(const s of vr){if(s>=t)continue;const o=Math.pow(2,t-s),a=Math.floor(r/o),c=Math.floor(e/o),h=await Y(D,s,a,c);if(!h)continue;const l=J(h,a,c,s).filter(u=>u.layer==="water"&&(u.type==="Polygon"||u.type==="MultiPolygon"));for(const u of l){const p=u.coordinates,m=u.type==="Polygon"?p[0]:p[0][0];if(!m||m.length<3)continue;const y=m[0],_=`${y[0].toFixed(4)},${y[1].toFixed(4)}`;n.has(_)||(n.add(_),u.properties={...u.properties,_fromLowerZoom:!0,_sourceZoom:s},i.push(u))}}return i}async function Mr(r,e,t,i){if(!D)return[];const n=[];n.push(Fr(r,e,t));const s=Math.max(10,t-2),o=Math.pow(2,t-s),a=Math.floor(r/o),c=Math.floor(e/o);if(n.push(Y(D,s,a,c).then(l=>l?J(l,a,c,s):[])),n.push(Y(D,t,r,e).then(l=>l?J(l,r,e,t):[])),i)for(let l=-1;l<=1;l++)for(let u=-1;u<=1;u++){if(l===0&&u===0)continue;const p=r+l,m=e+u;n.push(Y(D,t,p,m).then(y=>y?J(y,p,m,t):[]))}const h=await Promise.all(n),f=[];for(const l of h)f.push(...l);return f}async function Pr(r,e,t){if(!G)return[];const i=await Y(G,t,r,e);return i?J(i,r,e,t):[]}async function Tr(r,e,t,i,n,s,o,a){await Qe(n,s);const c=mr(r,e,t),[h,f]=await Promise.all([Mr(r,e,t,o),a?Pr(r,e,t):Promise.resolve([])]),l=new OffscreenCanvas(i,i);return xr(l,h,f,c),l.transferToImageBitmap()}self.onmessage=async r=>{const e=r.data;try{switch(e.type){case"CAPABILITY_CHECK":{const t={type:"CAPABILITY_CHECK_RESULT",id:e.id,supported:le};self.postMessage(t);break}case"INIT_PMTILES":{const{basePMTilesUrl:t,transportationPMTilesUrl:i}=e.payload;await Qe(t,i);const n={type:"CAPABILITY_CHECK_RESULT",id:e.id,supported:!0};self.postMessage(n);break}case"RENDER_FULL_PIPELINE":{if(!le){const u={type:"ERROR",id:e.id,error:"OffscreenCanvas not supported"};self.postMessage(u);return}const{tileX:t,tileY:i,tileZ:n,textureSize:s,basePMTilesUrl:o,transportationPMTilesUrl:a,includeNeighbors:c,includeTransportation:h}=e.payload,f=await Tr(t,i,n,s,o,a,c,h),l={type:"RENDER_TILE_TEXTURE_RESULT",id:e.id,result:f};self.postMessage(l,{transfer:[f]});break}default:{const t=e,i=typeof t.id=="string"?t.id:"unknown",n=typeof t.type=="string"?t.type:"undefined",s={type:"ERROR",id:i,error:`Unknown request type: ${n}`};self.postMessage(s)}}}catch(t){const i={type:"ERROR",id:e.id,error:t instanceof Error?t.message:"Unknown error in full-pipeline worker"};self.postMessage(i)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=full-pipeline.worker-Dyb_LLLQ.js.map
