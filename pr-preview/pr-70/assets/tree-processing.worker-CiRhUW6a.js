(function(){"use strict";var P=Uint8Array,R=Uint16Array,xe=Int32Array,Ct=new P([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),kt=new P([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ye=new P([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),_t=function(r,t){for(var e=new R(31),n=0;n<31;++n)e[n]=t+=1<<r[n-1];for(var i=new xe(e[30]),n=1;n<30;++n)for(var s=e[n];s<e[n+1];++s)i[s]=s-e[n]<<5|n;return{b:e,r:i}},Dt=_t(Ct,2),It=Dt.b,we=Dt.r;It[28]=258,we[258]=28;for(var pe=_t(kt,0),me=pe.b,ft=new R(32768),w=0;w<32768;++w){var C=(w&43690)>>1|(w&21845)<<1;C=(C&52428)>>2|(C&13107)<<2,C=(C&61680)>>4|(C&3855)<<4,ft[w]=((C&65280)>>8|(C&255)<<8)>>1}for(var K=(function(r,t,e){for(var n=r.length,i=0,s=new R(t);i<n;++i)r[i]&&++s[r[i]-1];var o=new R(t);for(i=1;i<t;++i)o[i]=o[i-1]+s[i-1]<<1;var a;if(e){a=new R(1<<t);var l=15-t;for(i=0;i<n;++i)if(r[i])for(var c=i<<4|r[i],f=t-r[i],h=o[r[i]-1]++<<f,u=h|(1<<f)-1;h<=u;++h)a[ft[h]>>l]=c}else for(a=new R(n),i=0;i<n;++i)r[i]&&(a[i]=ft[o[r[i]-1]++]>>15-r[i]);return a}),q=new P(288),w=0;w<144;++w)q[w]=8;for(var w=144;w<256;++w)q[w]=9;for(var w=256;w<280;++w)q[w]=7;for(var w=280;w<288;++w)q[w]=8;for(var Ut=new P(32),w=0;w<32;++w)Ut[w]=5;var ve=K(q,9,1),Me=K(Ut,5,1),dt=function(r){for(var t=r[0],e=1;e<r.length;++e)r[e]>t&&(t=r[e]);return t},V=function(r,t,e){var n=t/8|0;return(r[n]|r[n+1]<<8)>>(t&7)&e},gt=function(r,t){var e=t/8|0;return(r[e]|r[e+1]<<8|r[e+2]<<16)>>(t&7)},Fe=function(r){return(r+7)/8|0},Te=function(r,t,e){return(e==null||e>r.length)&&(e=r.length),new P(r.subarray(t,e))},Pe=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],S=function(r,t,e){var n=new Error(t||Pe[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,S),!e)throw n;return n},xt=function(r,t,e,n){var i=r.length,s=0;if(!i||t.f&&!t.l)return e||new P(0);var o=!e,a=o||t.i!=2,l=t.i;o&&(e=new P(i*3));var c=function(fe){var de=e.length;if(fe>de){var ge=new P(Math.max(de*2,fe));ge.set(e),e=ge}},f=t.f||0,h=t.p||0,u=t.b||0,d=t.l,x=t.d,g=t.m,m=t.n,F=i*8;do{if(!d){f=V(r,h,1);var v=V(r,h+1,3);if(h+=3,v)if(v==1)d=ve,x=Me,g=9,m=5;else if(v==2){var B=V(r,h,31)+257,A=V(r,h+10,15)+4,H=B+V(r,h+5,31)+1;h+=14;for(var D=new P(H),Q=new P(19),M=0;M<A;++M)Q[ye[M]]=V(r,h+M*3,7);h+=A*3;for(var Z=dt(Q),Zr=(1<<Z)-1,Wr=K(Q,Z,1),M=0;M<H;){var ae=Wr[V(r,h,Zr)];h+=ae&15;var T=ae>>4;if(T<16)D[M++]=T;else{var W=0,ut=0;for(T==16?(ut=3+V(r,h,3),h+=2,W=D[M-1]):T==17?(ut=3+V(r,h,7),h+=3):T==18&&(ut=11+V(r,h,127),h+=7);ut--;)D[M++]=W}}var le=D.subarray(0,B),I=D.subarray(B);g=dt(le),m=dt(I),d=K(le,g,1),x=K(I,m,1)}else S(1);else{var T=Fe(h)+4,_=r[T-4]|r[T-3]<<8,b=T+_;if(b>i){l&&S(0);break}a&&c(u+_),e.set(r.subarray(T,b),u),t.b=u+=_,t.p=h=b*8,t.f=f;continue}if(h>F){l&&S(0);break}}a&&c(u+131072);for(var jr=(1<<g)-1,Kr=(1<<m)-1,bt=h;;bt=h){var W=d[gt(r,h)&jr],j=W>>4;if(h+=W&15,h>F){l&&S(0);break}if(W||S(2),j<256)e[u++]=j;else if(j==256){bt=h,d=null;break}else{var he=j-254;if(j>264){var M=j-257,tt=Ct[M];he=V(r,h,(1<<tt)-1)+It[M],h+=tt}var Et=x[gt(r,h)&Kr],Vt=Et>>4;Et||S(3),h+=Et&15;var I=me[Vt];if(Vt>3){var tt=kt[Vt];I+=gt(r,h)&(1<<tt)-1,h+=tt}if(h>F){l&&S(0);break}a&&c(u+131072);var ce=u+he;if(u<I){var ue=s-I,qr=Math.min(I,ce);for(ue+u<0&&S(3);u<qr;++u)e[u]=n[ue+u]}for(;u<ce;++u)e[u]=e[u-I]}}t.l=d,t.p=bt,t.b=u,t.f=f,d&&(f=1,t.m=g,t.d=x,t.n=m)}while(!f);return u!=e.length&&o?Te(e,0,u):e.subarray(0,u)},Le=new P(0),Se=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&S(6,"invalid gzip data");var t=r[3],e=10;t&4&&(e+=(r[10]|r[11]<<8)+2);for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!r[e++]);return e+(t&2)},be=function(r){var t=r.length;return(r[t-4]|r[t-3]<<8|r[t-2]<<16|r[t-1]<<24)>>>0},Ee=function(r,t){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&S(6,"invalid zlib data"),(r[1]>>5&1)==1&&S(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function Ve(r,t){return xt(r,{i:2},t,t)}function Ce(r,t){var e=Se(r);return e+8>r.length&&S(6,"invalid gzip data"),xt(r.subarray(e,-8),{i:2},new P(be(r)),t)}function ke(r,t){return xt(r.subarray(Ee(r),-4),{i:2},t,t)}function _e(r,t){return r[0]==31&&r[1]==139&&r[2]==8?Ce(r,t):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?Ve(r,t):ke(r,t)}var De=typeof TextDecoder<"u"&&new TextDecoder,Ie=0;try{De.decode(Le,{stream:!0}),Ie=1}catch{}var Ue=Object.defineProperty,Be=Math.pow,y=(r,t)=>Ue(r,"name",{value:t,configurable:!0}),p=(r,t,e)=>new Promise((n,i)=>{var s=l=>{try{a(e.next(l))}catch(c){i(c)}},o=l=>{try{a(e.throw(l))}catch(c){i(c)}},a=l=>l.done?n(l.value):Promise.resolve(l.value).then(s,o);a((e=e.apply(r,t)).next())});y((r,t)=>{let e=!1,n="",i=L.GridLayer.extend({createTile:y((s,o)=>{let a=document.createElement("img"),l=new AbortController,c=l.signal;return a.cancel=()=>{l.abort()},e||(r.getHeader().then(f=>{f.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):f.tileType===2?n="image/png":f.tileType===3?n="image/jpeg":f.tileType===4?n="image/webp":f.tileType===5&&(n="image/avif")}),e=!0),r.getZxy(s.z,s.x,s.y,c).then(f=>{if(f){let h=new Blob([f.data],{type:n}),u=window.URL.createObjectURL(h);a.src=u}else a.style.display="none";a.cancel=void 0,o(void 0,a)}).catch(f=>{if(f.name!=="AbortError")throw f}),a},"createTile"),_removeTile:y(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new i(t)},"leafletRasterLayer");var Ae=y(r=>(t,e)=>{if(e instanceof AbortController)return r(t,e);let n=new AbortController;return r(t,n).then(i=>e(void 0,i.data,i.cacheControl||"",i.expires||""),i=>e(i)).catch(i=>e(i)),{cancel:y(()=>n.abort(),"cancel")}},"v3compat"),He=class{constructor(t){this.tilev4=y((e,n)=>p(this,null,function*(){if(e.type==="json"){let d=e.url.substr(10),x=this.tiles.get(d);if(x||(x=new G(d),this.tiles.set(d,x)),this.metadata){let m=yield x.getTileJson(e.url);return n.signal.throwIfAborted(),{data:m}}let g=yield x.getHeader();return n.signal.throwIfAborted(),(g.minLon>=g.maxLon||g.minLat>=g.maxLat)&&console.error(`Bounds of PMTiles archive ${g.minLon},${g.minLat},${g.maxLon},${g.maxLat} are not valid.`),{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:g.minZoom,maxzoom:g.maxZoom,bounds:[g.minLon,g.minLat,g.maxLon,g.maxLat]}}}let i=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=e.url.match(i);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new G(o),this.tiles.set(o,a));let l=s[2],c=s[3],f=s[4],h=yield a.getHeader(),u=yield a==null?void 0:a.getZxy(+l,+c,+f,n.signal);if(n.signal.throwIfAborted(),u)return{data:new Uint8Array(u.data),cacheControl:u.cacheControl,expires:u.expires};if(h.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=Ae(this.tilev4),this.tiles=new Map,this.metadata=(t==null?void 0:t.metadata)||!1,this.errorOnMissingTile=(t==null?void 0:t.errorOnMissingTile)||!1}add(t){this.tiles.set(t.source.getKey(),t)}get(t){return this.tiles.get(t)}};y(He,"Protocol");function Bt(r,t){return(t>>>0)*4294967296+(r>>>0)}y(Bt,"toNum");function At(r,t){let e=t.buf,n=e[t.pos++],i=(n&112)>>4;if(n<128||(n=e[t.pos++],i|=(n&127)<<3,n<128)||(n=e[t.pos++],i|=(n&127)<<10,n<128)||(n=e[t.pos++],i|=(n&127)<<17,n<128)||(n=e[t.pos++],i|=(n&127)<<24,n<128)||(n=e[t.pos++],i|=(n&1)<<31,n<128))return Bt(r,i);throw new Error("Expected varint not more than 10 bytes")}y(At,"readVarintRemainder");function z(r){let t=r.buf,e=t[r.pos++],n=e&127;return e<128||(e=t[r.pos++],n|=(e&127)<<7,e<128)||(e=t[r.pos++],n|=(e&127)<<14,e<128)||(e=t[r.pos++],n|=(e&127)<<21,e<128)?n:(e=t[r.pos],n|=(e&15)<<28,At(n,r))}y(z,"readVarint");function yt(r,t,e,n,i){return i===0?n!==0?[r-1-e,r-1-t]:[e,t]:[t,e]}y(yt,"rotate");function Ht(r,t,e){if(r>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(t>=1<<r||e>=1<<r)throw new Error("tile x/y outside zoom level bounds");let n=((1<<r)*(1<<r)-1)/3,i=r-1,[s,o]=[t,e];for(let a=1<<i;a>0;a>>=1){let l=s&a,c=o&a;n+=(3*l^c)*(1<<i),[s,o]=yt(a,s,o,l,c),i--}return n}y(Ht,"zxyToTileId");function Rt(r){let t=3*r+1;return t<4294967296?31-Math.clz32(t):63-Math.clz32(t/4294967296)}y(Rt,"tileIdToZ");function Re(r){let t=Rt(r)>>1;if(t>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");let e=((1<<t)*(1<<t)-1)/3,n=r-e,i=0,s=0,o=1<<t;for(let a=1;a<o;a<<=1){let l=a&n/2,c=a&(n^l);[i,s]=yt(a,i,s,l,c),n=n/2,i+=l,s+=c}return[t,i,s]}y(Re,"tileIdToZxy");var ze=(r=>(r[r.Unknown=0]="Unknown",r[r.None=1]="None",r[r.Gzip=2]="Gzip",r[r.Brotli=3]="Brotli",r[r.Zstd=4]="Zstd",r))(ze||{});function et(r,t){return p(this,null,function*(){if(t===1||t===0)return r;if(t===2){if(typeof globalThis.DecompressionStream>"u")return _e(new Uint8Array(r));let e=new Response(r).body;if(!e)throw new Error("Failed to read response stream");let n=e.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw new Error("Compression method not supported")})}y(et,"defaultDecompress");var Oe=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(Oe||{});function zt(r){return r===1?".mvt":r===2?".png":r===3?".jpg":r===4?".webp":r===5?".avif":""}y(zt,"tileTypeExt");var Ne=127;function Ot(r,t){let e=0,n=r.length-1;for(;e<=n;){let i=n+e>>1,s=t-r[i].tileId;if(s>0)e=i+1;else if(s<0)n=i-1;else return r[i]}return n>=0&&(r[n].runLength===0||t-r[n].tileId<r[n].runLength)?r[n]:null}y(Ot,"findTile");var $e=class{constructor(t){this.file=t}getKey(){return this.file.name}getBytes(t,e){return p(this,null,function*(){return{data:yield this.file.slice(t,t+e).arrayBuffer()}})}};y($e,"FileSource");var Nt=class{constructor(t,e=new Headers){var n,i;this.url=t,this.customHeaders=e,this.mustReload=!1;let s="";"navigator"in globalThis&&(s=(i=(n=globalThis.navigator)==null?void 0:n.userAgent)!=null?i:"");let o=s.indexOf("Windows")>-1,a=/Chrome|Chromium|Edg|OPR|Brave/.test(s);this.chromeWindowsNoCache=!1,o&&a&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(t){this.customHeaders=t}getBytes(t,e,n,i){return p(this,null,function*(){let s,o;n?o=n:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${t}-${t+e-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let c=yield fetch(this.url,{signal:o,cache:l,headers:a});if(t===0&&c.status===416){let u=c.headers.get("Content-Range");if(!u||!u.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let d=+u.substr(8);c=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${d-1}`}})}let f=c.headers.get("Etag");if(f!=null&&f.startsWith("W/")&&(f=null),c.status===416||i&&f&&f!==i)throw this.mustReload=!0,new pt(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(c.status>=300)throw new Error(`Bad response code: ${c.status}`);let h=c.headers.get("Content-Length");if(c.status===200&&(!h||+h>e))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield c.arrayBuffer(),etag:f||void 0,cacheControl:c.headers.get("Cache-Control")||void 0,expires:c.headers.get("Expires")||void 0}})}};y(Nt,"FetchSource");var Ze=Nt;function E(r,t){let e=r.getUint32(t+4,!0),n=r.getUint32(t+0,!0);return e*Be(2,32)+n}y(E,"getUint64");function $t(r,t){let e=new DataView(r),n=e.getUint8(7);if(n>3)throw new Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:E(e,8),rootDirectoryLength:E(e,16),jsonMetadataOffset:E(e,24),jsonMetadataLength:E(e,32),leafDirectoryOffset:E(e,40),leafDirectoryLength:E(e,48),tileDataOffset:E(e,56),tileDataLength:E(e,64),numAddressedTiles:E(e,72),numTileEntries:E(e,80),numTileContents:E(e,88),clustered:e.getUint8(96)===1,internalCompression:e.getUint8(97),tileCompression:e.getUint8(98),tileType:e.getUint8(99),minZoom:e.getUint8(100),maxZoom:e.getUint8(101),minLon:e.getInt32(102,!0)/1e7,minLat:e.getInt32(106,!0)/1e7,maxLon:e.getInt32(110,!0)/1e7,maxLat:e.getInt32(114,!0)/1e7,centerZoom:e.getUint8(118),centerLon:e.getInt32(119,!0)/1e7,centerLat:e.getInt32(123,!0)/1e7,etag:t}}y($t,"bytesToHeader");function wt(r){let t={buf:new Uint8Array(r),pos:0},e=z(t),n=[],i=0;for(let s=0;s<e;s++){let o=z(t);n.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let s=0;s<e;s++)n[s].runLength=z(t);for(let s=0;s<e;s++)n[s].length=z(t);for(let s=0;s<e;s++){let o=z(t);o===0&&s>0?n[s].offset=n[s-1].offset+n[s-1].length:n[s].offset=o-1}return n}y(wt,"deserializeIndex");var Zt=class extends Error{};y(Zt,"EtagMismatch");var pt=Zt;function mt(r,t){return p(this,null,function*(){let e=yield r.getBytes(0,16384);if(new DataView(e.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let n=e.data.slice(0,Ne),i=$t(n,e.etag),s=e.data.slice(i.rootDirectoryOffset,i.rootDirectoryOffset+i.rootDirectoryLength),o=`${r.getKey()}|${i.etag||""}|${i.rootDirectoryOffset}|${i.rootDirectoryLength}`,a=wt(yield t(s,i.internalCompression));return[i,[o,a.length,a]]})}y(mt,"getHeaderAndRoot");function vt(r,t,e,n,i){return p(this,null,function*(){let s=yield r.getBytes(e,n,void 0,i.etag),o=yield t(s.data,i.internalCompression),a=wt(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}y(vt,"getDirectory");var We=class{constructor(t=100,e=!0,n=et){this.cache=new Map,this.maxCacheEntries=t,this.counter=1,this.decompress=n}getHeader(t){return p(this,null,function*(){let e=t.getKey(),n=this.cache.get(e);if(n)return n.lastUsed=this.counter++,n.data;let i=yield mt(t,this.decompress);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(e,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]})}getDirectory(t,e,n,i){return p(this,null,function*(){let s=`${t.getKey()}|${i.etag||""}|${e}|${n}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield vt(t,this.decompress,e,n,i);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let t=1/0,e;this.cache.forEach((n,i)=>{n.lastUsed<t&&(t=n.lastUsed,e=i)}),e&&this.cache.delete(e)}}invalidate(t){return p(this,null,function*(){this.cache.delete(t.getKey())})}};y(We,"ResolvedValueCache");var Wt=class{constructor(t=100,e=!0,n=et){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=t,this.counter=1,this.decompress=n}getHeader(t){return p(this,null,function*(){let e=t.getKey(),n=this.cache.get(e);if(n)return n.lastUsed=this.counter++,yield n.data;let i=new Promise((s,o)=>{mt(t,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(e,{lastUsed:this.counter++,data:i}),i})}getDirectory(t,e,n,i){return p(this,null,function*(){let s=`${t.getKey()}|${i.etag||""}|${e}|${n}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((l,c)=>{vt(t,this.decompress,e,n,i).then(f=>{l(f),this.prune()}).catch(f=>{c(f)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let t=1/0,e;this.cache.forEach((n,i)=>{n.lastUsed<t&&(t=n.lastUsed,e=i)}),e&&this.cache.delete(e)}}invalidate(t){return p(this,null,function*(){let e=t.getKey();if(this.invalidations.get(e))return yield this.invalidations.get(e);this.cache.delete(t.getKey());let n=new Promise((i,s)=>{this.getHeader(t).then(o=>{i(),this.invalidations.delete(e)}).catch(o=>{s(o)})});this.invalidations.set(e,n)})}};y(Wt,"SharedPromiseCache");var je=Wt,jt=class{constructor(t,e,n){typeof t=="string"?this.source=new Ze(t):this.source=t,n?this.decompress=n:this.decompress=et,e?this.cache=e:this.cache=new je}getHeader(){return p(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(t,e,n,i){return p(this,null,function*(){let s=Ht(t,e,n),o=yield this.cache.getHeader(this.source);if(t<o.minZoom||t>o.maxZoom)return;let a=o.rootDirectoryOffset,l=o.rootDirectoryLength;for(let c=0;c<=3;c++){let f=yield this.cache.getDirectory(this.source,a,l,o),h=Ot(f,s);if(h){if(h.runLength>0){let u=yield this.source.getBytes(o.tileDataOffset+h.offset,h.length,i,o.etag);return{data:yield this.decompress(u.data,o.tileCompression),cacheControl:u.cacheControl,expires:u.expires}}a=o.leafDirectoryOffset+h.offset,l=h.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(t,e,n,i){return p(this,null,function*(){try{return yield this.getZxyAttempt(t,e,n,i)}catch(s){if(s instanceof pt)return this.cache.invalidate(this.source),yield this.getZxyAttempt(t,e,n,i);throw s}})}getMetadataAttempt(){return p(this,null,function*(){let t=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(t.jsonMetadataOffset,t.jsonMetadataLength,void 0,t.etag),n=yield this.decompress(e.data,t.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(n))})}getMetadata(){return p(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(t){if(t instanceof pt)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw t}})}getTileJson(t){return p(this,null,function*(){let e=yield this.getHeader(),n=yield this.getMetadata(),i=zt(e.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${t}/{z}/{x}/{y}${i}`],vector_layers:n.vector_layers,attribution:n.attribution,description:n.description,name:n.name,version:n.version,bounds:[e.minLon,e.minLat,e.maxLon,e.maxLat],center:[e.centerLon,e.centerLat,e.centerZoom],minzoom:e.minZoom,maxzoom:e.maxZoom}})}};y(jt,"PMTiles");var G=jt;function k(r,t){this.x=r,this.y=t}k.prototype={clone(){return new k(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,t){return this.clone()._rotateAround(r,t)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const t=r.x-this.x,e=r.y-this.y;return t*t+e*e},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,t){return Math.atan2(this.x*t-this.y*r,this.x*r+this.y*t)},_matMult(r){const t=r[0]*this.x+r[1]*this.y,e=r[2]*this.x+r[3]*this.y;return this.x=t,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const t=Math.cos(r),e=Math.sin(r),n=t*this.x-e*this.y,i=e*this.x+t*this.y;return this.x=n,this.y=i,this},_rotateAround(r,t){const e=Math.cos(r),n=Math.sin(r),i=t.x+e*(this.x-t.x)-n*(this.y-t.y),s=t.y+n*(this.x-t.x)+e*(this.y-t.y);return this.x=i,this.y=s,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:k},k.convert=function(r){if(r instanceof k)return r;if(Array.isArray(r))return new k(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new k(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};class Kt{constructor(t,e,n,i,s){this.properties={},this.extent=n,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=i,this._values=s,t.readFields(Ke,this,e)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos,n=[];let i,s=1,o=0,a=0,l=0;for(;t.pos<e;){if(o<=0){const c=t.readVarint();s=c&7,o=c>>3}if(o--,s===1||s===2)a+=t.readSVarint(),l+=t.readSVarint(),s===1&&(i&&n.push(i),i=[]),i&&i.push(new k(a,l));else if(s===7)i&&i.push(i[0].clone());else throw new Error(`unknown command ${s}`)}return i&&n.push(i),n}bbox(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos;let n=1,i=0,s=0,o=0,a=1/0,l=-1/0,c=1/0,f=-1/0;for(;t.pos<e;){if(i<=0){const h=t.readVarint();n=h&7,i=h>>3}if(i--,n===1||n===2)s+=t.readSVarint(),o+=t.readSVarint(),s<a&&(a=s),s>l&&(l=s),o<c&&(c=o),o>f&&(f=o);else if(n!==7)throw new Error(`unknown command ${n}`)}return[a,c,l,f]}toGeoJSON(t,e,n){const i=this.extent*Math.pow(2,n),s=this.extent*t,o=this.extent*e,a=this.loadGeometry();function l(u){return[(u.x+s)*360/i-180,360/Math.PI*Math.atan(Math.exp((1-(u.y+o)*2/i)*Math.PI))-90]}function c(u){return u.map(l)}let f;if(this.type===1){const u=[];for(const x of a)u.push(x[0]);const d=c(u);f=u.length===1?{type:"Point",coordinates:d[0]}:{type:"MultiPoint",coordinates:d}}else if(this.type===2){const u=a.map(c);f=u.length===1?{type:"LineString",coordinates:u[0]}:{type:"MultiLineString",coordinates:u}}else if(this.type===3){const u=Ge(a),d=[];for(const x of u)d.push(x.map(c));f=d.length===1?{type:"Polygon",coordinates:d[0]}:{type:"MultiPolygon",coordinates:d}}else throw new Error("unknown feature type");const h={type:"Feature",geometry:f,properties:this.properties};return this.id!=null&&(h.id=this.id),h}}Kt.types=["Unknown","Point","LineString","Polygon"];function Ke(r,t,e){r===1?t.id=e.readVarint():r===2?qe(e,t):r===3?t.type=e.readVarint():r===4&&(t._geometry=e.pos)}function qe(r,t){const e=r.readVarint()+r.pos;for(;r.pos<e;){const n=t._keys[r.readVarint()],i=t._values[r.readVarint()];t.properties[n]=i}}function Ge(r){const t=r.length;if(t<=1)return[r];const e=[];let n,i;for(let s=0;s<t;s++){const o=Ye(r[s]);o!==0&&(i===void 0&&(i=o<0),i===o<0?(n&&e.push(n),n=[r[s]]):n&&n.push(r[s]))}return n&&e.push(n),e}function Ye(r){let t=0;for(let e=0,n=r.length,i=n-1,s,o;e<n;i=e++)s=r[e],o=r[i],t+=(o.x-s.x)*(s.y+o.y);return t}class Xe{constructor(t,e){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(Je,this,e),this.length=this._features.length}feature(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];const e=this._pbf.readVarint()+this._pbf.pos;return new Kt(this._pbf,e,this.extent,this._keys,this._values)}}function Je(r,t,e){r===15?t.version=e.readVarint():r===1?t.name=e.readString():r===5?t.extent=e.readVarint():r===2?t._features.push(e.pos):r===3?t._keys.push(e.readString()):r===4&&t._values.push(Qe(e))}function Qe(r){let t=null;const e=r.readVarint()+r.pos;for(;r.pos<e;){const n=r.readVarint()>>3;t=n===1?r.readString():n===2?r.readFloat():n===3?r.readDouble():n===4?r.readVarint64():n===5?r.readVarint():n===6?r.readSVarint():n===7?r.readBoolean():null}if(t==null)throw new Error("unknown feature value");return t}class tr{constructor(t,e){this.layers=t.readFields(er,{},e)}}function er(r,t,e){if(r===3){const n=new Xe(e,e.readVarint()+e.pos);n.length&&(t[n.name]=n)}}const Mt=65536*65536,qt=1/Mt,rr=12,Gt=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),Ft=0,rt=1,Y=2,nt=5;class nr{constructor(t=new Uint8Array(16)){this.buf=ArrayBuffer.isView(t)?t:new Uint8Array(t),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(t,e,n=this.length){for(;this.pos<n;){const i=this.readVarint(),s=i>>3,o=this.pos;this.type=i&7,t(s,e,this),this.pos===o&&this.skip(i)}return e}readMessage(t,e){return this.readFields(t,e,this.readVarint()+this.pos)}readFixed32(){const t=this.dataView.getUint32(this.pos,!0);return this.pos+=4,t}readSFixed32(){const t=this.dataView.getInt32(this.pos,!0);return this.pos+=4,t}readFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Mt;return this.pos+=8,t}readSFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Mt;return this.pos+=8,t}readFloat(){const t=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,t}readDouble(){const t=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,t}readVarint(t){const e=this.buf;let n,i;return i=e[this.pos++],n=i&127,i<128||(i=e[this.pos++],n|=(i&127)<<7,i<128)||(i=e[this.pos++],n|=(i&127)<<14,i<128)||(i=e[this.pos++],n|=(i&127)<<21,i<128)?n:(i=e[this.pos],n|=(i&15)<<28,ir(n,t,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const t=this.readVarint();return t%2===1?(t+1)/-2:t/2}readBoolean(){return!!this.readVarint()}readString(){const t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=rr&&Gt?Gt.decode(this.buf.subarray(e,t)):wr(this.buf,e,t)}readBytes(){const t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e}readPackedVarint(t=[],e){const n=this.readPackedEnd();for(;this.pos<n;)t.push(this.readVarint(e));return t}readPackedSVarint(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSVarint());return t}readPackedBoolean(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readBoolean());return t}readPackedFloat(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFloat());return t}readPackedDouble(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readDouble());return t}readPackedFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed32());return t}readPackedSFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed32());return t}readPackedFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed64());return t}readPackedSFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed64());return t}readPackedEnd(){return this.type===Y?this.readVarint()+this.pos:this.pos+1}skip(t){const e=t&7;if(e===Ft)for(;this.buf[this.pos++]>127;);else if(e===Y)this.pos=this.readVarint()+this.pos;else if(e===nt)this.pos+=4;else if(e===rt)this.pos+=8;else throw new Error(`Unimplemented type: ${e}`)}writeTag(t,e){this.writeVarint(t<<3|e)}realloc(t){let e=this.length||16;for(;e<this.pos+t;)e*=2;if(e!==this.length){const n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.dataView=new DataView(n.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeSFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*qt),!0),this.pos+=8}writeSFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*qt),!0),this.pos+=8}writeVarint(t){if(t=+t||0,t>268435455||t<0){sr(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))}writeSVarint(t){this.writeVarint(t<0?-t*2-1:t*2)}writeBoolean(t){this.writeVarint(+t)}writeString(t){t=String(t),this.realloc(t.length*4),this.pos++;const e=this.pos;this.pos=pr(this.buf,t,this.pos);const n=this.pos-e;n>=128&&Yt(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n}writeFloat(t){this.realloc(4),this.dataView.setFloat32(this.pos,t,!0),this.pos+=4}writeDouble(t){this.realloc(8),this.dataView.setFloat64(this.pos,t,!0),this.pos+=8}writeBytes(t){const e=t.length;this.writeVarint(e),this.realloc(e);for(let n=0;n<e;n++)this.buf[this.pos++]=t[n]}writeRawMessage(t,e){this.pos++;const n=this.pos;t(e,this);const i=this.pos-n;i>=128&&Yt(n,i,this),this.pos=n-1,this.writeVarint(i),this.pos+=i}writeMessage(t,e,n){this.writeTag(t,Y),this.writeRawMessage(e,n)}writePackedVarint(t,e){e.length&&this.writeMessage(t,lr,e)}writePackedSVarint(t,e){e.length&&this.writeMessage(t,hr,e)}writePackedBoolean(t,e){e.length&&this.writeMessage(t,fr,e)}writePackedFloat(t,e){e.length&&this.writeMessage(t,cr,e)}writePackedDouble(t,e){e.length&&this.writeMessage(t,ur,e)}writePackedFixed32(t,e){e.length&&this.writeMessage(t,dr,e)}writePackedSFixed32(t,e){e.length&&this.writeMessage(t,gr,e)}writePackedFixed64(t,e){e.length&&this.writeMessage(t,xr,e)}writePackedSFixed64(t,e){e.length&&this.writeMessage(t,yr,e)}writeBytesField(t,e){this.writeTag(t,Y),this.writeBytes(e)}writeFixed32Field(t,e){this.writeTag(t,nt),this.writeFixed32(e)}writeSFixed32Field(t,e){this.writeTag(t,nt),this.writeSFixed32(e)}writeFixed64Field(t,e){this.writeTag(t,rt),this.writeFixed64(e)}writeSFixed64Field(t,e){this.writeTag(t,rt),this.writeSFixed64(e)}writeVarintField(t,e){this.writeTag(t,Ft),this.writeVarint(e)}writeSVarintField(t,e){this.writeTag(t,Ft),this.writeSVarint(e)}writeStringField(t,e){this.writeTag(t,Y),this.writeString(e)}writeFloatField(t,e){this.writeTag(t,nt),this.writeFloat(e)}writeDoubleField(t,e){this.writeTag(t,rt),this.writeDouble(e)}writeBooleanField(t,e){this.writeVarintField(t,+e)}}function ir(r,t,e){const n=e.buf;let i,s;if(s=n[e.pos++],i=(s&112)>>4,s<128||(s=n[e.pos++],i|=(s&127)<<3,s<128)||(s=n[e.pos++],i|=(s&127)<<10,s<128)||(s=n[e.pos++],i|=(s&127)<<17,s<128)||(s=n[e.pos++],i|=(s&127)<<24,s<128)||(s=n[e.pos++],i|=(s&1)<<31,s<128))return O(r,i,t);throw new Error("Expected varint not more than 10 bytes")}function O(r,t,e){return e?t*4294967296+(r>>>0):(t>>>0)*4294967296+(r>>>0)}function sr(r,t){let e,n;if(r>=0?(e=r%4294967296|0,n=r/4294967296|0):(e=~(-r%4294967296),n=~(-r/4294967296),e^4294967295?e=e+1|0:(e=0,n=n+1|0)),r>=18446744073709552e3||r<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),or(e,n,t),ar(n,t)}function or(r,t,e){e.buf[e.pos++]=r&127|128,r>>>=7,e.buf[e.pos++]=r&127|128,r>>>=7,e.buf[e.pos++]=r&127|128,r>>>=7,e.buf[e.pos++]=r&127|128,r>>>=7,e.buf[e.pos]=r&127}function ar(r,t){const e=(r&7)<<4;t.buf[t.pos++]|=e|((r>>>=3)?128:0),r&&(t.buf[t.pos++]=r&127|((r>>>=7)?128:0),r&&(t.buf[t.pos++]=r&127|((r>>>=7)?128:0),r&&(t.buf[t.pos++]=r&127|((r>>>=7)?128:0),r&&(t.buf[t.pos++]=r&127|((r>>>=7)?128:0),r&&(t.buf[t.pos++]=r&127)))))}function Yt(r,t,e){const n=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(Math.LN2*7));e.realloc(n);for(let i=e.pos-1;i>=r;i--)e.buf[i+n]=e.buf[i]}function lr(r,t){for(let e=0;e<r.length;e++)t.writeVarint(r[e])}function hr(r,t){for(let e=0;e<r.length;e++)t.writeSVarint(r[e])}function cr(r,t){for(let e=0;e<r.length;e++)t.writeFloat(r[e])}function ur(r,t){for(let e=0;e<r.length;e++)t.writeDouble(r[e])}function fr(r,t){for(let e=0;e<r.length;e++)t.writeBoolean(r[e])}function dr(r,t){for(let e=0;e<r.length;e++)t.writeFixed32(r[e])}function gr(r,t){for(let e=0;e<r.length;e++)t.writeSFixed32(r[e])}function xr(r,t){for(let e=0;e<r.length;e++)t.writeFixed64(r[e])}function yr(r,t){for(let e=0;e<r.length;e++)t.writeSFixed64(r[e])}function wr(r,t,e){let n="",i=t;for(;i<e;){const s=r[i];let o=null,a=s>239?4:s>223?3:s>191?2:1;if(i+a>e)break;let l,c,f;a===1?s<128&&(o=s):a===2?(l=r[i+1],(l&192)===128&&(o=(s&31)<<6|l&63,o<=127&&(o=null))):a===3?(l=r[i+1],c=r[i+2],(l&192)===128&&(c&192)===128&&(o=(s&15)<<12|(l&63)<<6|c&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):a===4&&(l=r[i+1],c=r[i+2],f=r[i+3],(l&192)===128&&(c&192)===128&&(f&192)===128&&(o=(s&15)<<18|(l&63)<<12|(c&63)<<6|f&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,a=1):o>65535&&(o-=65536,n+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),n+=String.fromCharCode(o),i+=a}return n}function pr(r,t,e){for(let n=0,i,s;n<t.length;n++){if(i=t.charCodeAt(n),i>55295&&i<57344)if(s)if(i<56320){r[e++]=239,r[e++]=191,r[e++]=189,s=i;continue}else i=s-55296<<10|i-56320|65536,s=null;else{i>56319||n+1===t.length?(r[e++]=239,r[e++]=191,r[e++]=189):s=i;continue}else s&&(r[e++]=239,r[e++]=191,r[e++]=189,s=null);i<128?r[e++]=i:(i<2048?r[e++]=i>>6|192:(i<65536?r[e++]=i>>12|224:(r[e++]=i>>18|240,r[e++]=i>>12&63|128),r[e++]=i>>6&63|128),r[e++]=i&63|128)}return e}let U=null,X=null,J=null,it=!1,N=null,st=null,ot=null,at=null,$=null,lt=null,Tt=null,Xt=10;function Jt(r,t){return r<<16|t}function mr(r,t){return r<<8|t}function vr(r){return{count:r>>>8,coniferRatio:(r&255)/255}}async function Mr(r){if(!($!==null&&Tt===r))return lt!==null&&Tt===r||(Tt=r,lt=(async()=>{try{const t=await fetch(r);if(!t.ok)throw new Error(`Failed to load tree-tiles.bin: HTTP ${t.status}`);const e=await t.arrayBuffer(),n=new DataView(e);if(String.fromCharCode(n.getUint8(0),n.getUint8(1),n.getUint8(2),n.getUint8(3))!=="TREE")throw new Error("Invalid tree-tiles.bin magic bytes");const s=n.getUint8(4);Xt=n.getUint8(5);let a,l;if(s===1)l=n.getUint16(6,!0),a=8;else if(s===2)l=n.getUint32(6,!0),a=10;else throw new Error(`Unsupported tree-tiles.bin version: ${s}`);$=new Map;for(let c=0;c<l;c++){const f=n.getUint16(a,!0);a+=2;const h=n.getUint16(a,!0);a+=2;const u=n.getUint16(a,!0);a+=2;const d=n.getUint8(a);a+=1,$.set(Jt(f,h),mr(u,d))}}catch(t){console.warn("[TreeWorker] Failed to load tree hints:",t.message),$=new Map}})()),lt}function Fr(r,t,e){if(!$)return null;const n=Xt;let i,s;if(e===n)i=r,s=t;else if(e>n){const a=Math.pow(2,e-n);i=Math.floor(r/a),s=Math.floor(t/a)}else{const a=Math.pow(2,n-e);i=r*a+Math.floor(a/2),s=t*a+Math.floor(a/2)}const o=$.get(Jt(i,s));return o!==void 0?vr(o):null}async function Tr(r,t,e){if(!(it&&st===r&&ot===t&&at===e)){if(N)if(st!==r||ot!==t||at!==e)await N,it=!1;else{await N;return}N=(async()=>{try{st=r,ot=t,at=e,U=new G(r),X=new G(t),J=new G(e),await Promise.all([U.getHeader(),X.getHeader(),J.getHeader()]),it=!0}catch(n){throw console.error("[TreeProcessingWorker] Failed to initialize PMTiles:",n),U=null,X=null,J=null,st=null,ot=null,at=null,it=!1,n}})();try{await N}finally{N=null}}}async function ht(r,t,e,n){try{const i=await r.getZxy(t,e,n);return(i==null?void 0:i.data)??null}catch{return null}}function ct(r,t,e,n,i=null){const s=new tr(new nr(r)),o=[],a=Object.keys(s.layers),l=i&&s.layers[i]?[i]:a;for(const c of l){const f=s.layers[c];if(f)for(let h=0;h<f.length;h++){const u=f.feature(h),d=u.toGeoJSON(t,e,n);o.push({type:d.geometry.type,coordinates:d.geometry.coordinates,properties:u.properties,layer:c})}}return o}function Pr(r,t,e){const n=Math.PI-2*Math.PI*t/Math.pow(2,e),i=180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n))),s=Math.PI-2*Math.PI*(t+1)/Math.pow(2,e),o=180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s))),a=r/Math.pow(2,e)*360-180,l=(r+1)/Math.pow(2,e)*360-180;return{north:i,south:o,west:a,east:l}}const Pt=new Map;function Qt(r,t,e){const n=Math.pow(2,e),i=Math.floor((r+180)/360*n),s=t*Math.PI/180,o=Math.floor((1-Math.log(Math.tan(s)+1/Math.cos(s))/Math.PI)/2*n);return[i,o]}function Lr(r,t,e){const n=Math.pow(2,e),i=r/n*360-180,s=(r+1)/n*360-180,o=Math.atan(Math.sinh(Math.PI*(1-2*t/n)))*(180/Math.PI),a=Math.atan(Math.sinh(Math.PI*(1-2*(t+1)/n)))*(180/Math.PI);return{west:i,east:s,north:o,south:a}}function Sr(r,t,e,n){return r*256+t+e/256-n}async function br(r,t,e){const n=`${e.zoom}/${r}/${t}`,i=Pt.get(n);if(i)return i;const s=e.urlTemplate.replace("{z}",e.zoom.toString()).replace("{x}",r.toString()).replace("{y}",t.toString());try{const o=await fetch(s);if(!o.ok)return null;const a=await o.blob(),l=await createImageBitmap(a),f=new OffscreenCanvas(e.tileSize,e.tileSize).getContext("2d");f.drawImage(l,0,0,e.tileSize,e.tileSize);const h=f.getImageData(0,0,e.tileSize,e.tileSize),u=new Float32Array(e.tileSize*e.tileSize);for(let g=0;g<e.tileSize*e.tileSize;g++){const m=h.data[g*4],F=h.data[g*4+1],v=h.data[g*4+2];u[g]=Sr(m,F,v,e.terrariumOffset)}const d=Lr(r,t,e.zoom),x={heights:u,bounds:d};return Pt.set(n,x),x}catch{return null}}function Er(r,t,e,n){const i=Math.max(0,Math.min(n-1,t)),s=Math.max(0,Math.min(n-1,e)),o=Math.floor(i),a=Math.floor(s),l=Math.min(o+1,n-1),c=Math.min(a+1,n-1),f=i-o,h=s-a,u=r[a*n+o],d=r[a*n+l],x=r[c*n+o],g=r[c*n+l],F=[u,d,x,g].filter(v=>!Number.isNaN(v));if(F.length===0)return 0;if(F.length<4){const v=F.reduce((A,H)=>A+H,0)/F.length,T=Number.isNaN(u)?v:u,_=Number.isNaN(d)?v:d,b=Number.isNaN(x)?v:x,B=Number.isNaN(g)?v:g;return T*(1-f)*(1-h)+_*f*(1-h)+b*(1-f)*h+B*f*h}return u*(1-f)*(1-h)+d*f*(1-h)+x*(1-f)*h+g*f*h}function Vr(r,t,e){const[n,i]=Qt(r,t,e.zoom),s=`${e.zoom}/${n}/${i}`,o=Pt.get(s);if(!o)return 0;const{heights:a,bounds:l}=o,c=(r-l.west)/(l.east-l.west),f=(l.north-t)/(l.north-l.south),h=c*(e.tileSize-1),u=f*(e.tileSize-1),d=Er(a,h,u,e.tileSize);return Number.isNaN(d)?0:d}async function Cr(r,t){const e=new Set;for(const i of r){const[s,o]=Qt(i.lng,i.lat,t.zoom);e.add(`${s}/${o}`)}const n=[];for(const i of e){const[s,o]=i.split("/").map(Number);n.push(br(s,o,t))}await Promise.all(n)}async function kr(r,t,e){await Cr(r,t);for(const n of r){const i=Vr(n.lng,n.lat,t);n.terrainHeight=i*e}}const _r=[12,11,10,9,8];async function Dr(r,t,e){if(!U)return[];const n=await ht(U,e,r,t);return n?ct(n,r,t,e):[]}async function Ir(r,t,e){if(!U)return[];const n=[],i=new Set;for(const s of _r){if(s>e)continue;const o=Math.pow(2,e-s),a=Math.floor(r/o),l=Math.floor(t/o),c=await ht(U,s,a,l);if(c){const f=ct(c,a,l,s,"water");for(const h of f)if(h.type==="Polygon"||h.type==="MultiPolygon"){const u=JSON.stringify(h.coordinates).slice(0,100);i.has(u)||(i.add(u),n.push(h))}}}return n}async function Ur(r,t,e){if(!X)return[];const n=await ht(X,e,r,t);return n?ct(n,r,t,e):[]}async function Br(r,t,e){if(!J)return[];const n=await ht(J,e,r,t);return n?ct(n,r,t,e):[]}function te(r){let t=r;return()=>(t=t*1103515245+12345&2147483647,t/2147483647)}function ee(r,t,e){return(r*73856093^t*19349663^e*83492791)&2147483647}function Lt(r,t,e){let n=!1;for(let i=0,s=e.length-1;i<e.length;s=i++){const o=e[i][0],a=e[i][1],l=e[s][0],c=e[s][1];a>t!=c>t&&r<(l-o)*(t-a)/(c-a)+o&&(n=!n)}return n}function Ar(r){if(r.length<3)return 0;let t=0;for(const[,s]of r)t+=s;t/=r.length;let e=0;for(let s=0,o=r.length-1;s<r.length;o=s++)e+=(r[o][0]+r[s][0])*(r[o][1]-r[s][1]);e=Math.abs(e/2);const n=111320,i=111320*Math.cos(t*Math.PI/180);return e*n*i}function St(r){let t=1/0,e=-1/0,n=1/0,i=-1/0;for(const[s,o]of r)s<t&&(t=s),s>e&&(e=s),o<n&&(n=o),o>i&&(i=o);return{minLng:t,maxLng:e,minLat:n,maxLat:i}}function re(r,t,e,n,i){const s=[],o=Ar(r),a=e.density,l=o/1e4;let c=Math.ceil(l*a);if(c=Math.min(c,i),c<=0)return s;const f=St(r);let h=0;const u=c*10;for(;s.length<c&&h<u;){h++;const d=f.minLng+n()*(f.maxLng-f.minLng),x=f.minLat+n()*(f.maxLat-f.minLat);if(!Lt(d,x,r))continue;const m=n()<e.coniferRatio?"needleleaved":"broadleaved",v=e.minHeight+n()*(e.maxHeight-e.minHeight)+(n()-.5)*2*e.heightVariation;s.push({lat:x,lng:d,height:Math.max(e.minHeight,Math.min(e.maxHeight,v)),leafType:m})}return s}function Hr(r,t,e,n,i,s){const o=ee(t,e,n),a=te(o),l=[];for(const c of r){if(c.layer!=="land_cover")continue;const f=c.properties.subtype||"",h=i[f];if(!h)continue;const u=s-l.length;if(u<=0)break;if(c.type==="Polygon"){const d=c.coordinates;if(d.length>0){const x=re(d[0],f,h,a,u);l.push(...x)}}else if(c.type==="MultiPolygon"){const d=c.coordinates;for(const x of d){const g=s-l.length;if(g<=0)break;if(x.length>0){const m=re(x[0],f,h,a,g);l.push(...m)}}}}return l}function Rr(r,t,e,n,i,s){if(!i||i.count<=0)return[];const o=ee(r,t,e)+99999,a=te(o),l=[],c=Math.min(i.count,s),f=i.coniferRatio;for(let h=0;h<c;h++){const u=n.west+a()*(n.east-n.west),d=n.south+a()*(n.north-n.south),x=a()<f,g=x?"needleleaved":"broadleaved",F=(x?12:10)+(a()-.5)*8;l.push({lat:d,lng:u,height:Math.max(4,Math.min(25,F)),leafType:g})}return l}const ne={motorway:25,trunk:20,primary:15,secondary:12,tertiary:10,residential:6,service:4,default:8};function ie(r){const t=[];for(const e of r)if(e.type==="Polygon"){const n=e.coordinates;if(n.length===0||n[0].length===0)continue;const i=St(n[0]);t.push({rings:n,minLng:i.minLng,maxLng:i.maxLng,minLat:i.minLat,maxLat:i.maxLat})}else if(e.type==="MultiPolygon"){const n=e.coordinates;for(const i of n){if(i.length===0||i[0].length===0)continue;const s=St(i[0]);t.push({rings:i,minLng:s.minLng,maxLng:s.maxLng,minLat:s.minLat,maxLat:s.maxLat})}}return t}function zr(r){const t=[],e=.0002245777937477542;for(const n of r){if(n.type!=="LineString"&&n.type!=="MultiLineString")continue;const i=n.properties.class||"default",s=ne[i]||ne.default;let o=1/0,a=-1/0,l=1/0,c=-1/0;if(n.type==="LineString"){const f=n.coordinates;for(const[h,u]of f)h<o&&(o=h),h>a&&(a=h),u<l&&(l=u),u>c&&(c=u)}else{const f=n.coordinates;for(const h of f)for(const[u,d]of h)u<o&&(o=u),u>a&&(a=u),d<l&&(l=d),d>c&&(c=d)}t.push({feature:n,bufferMeters:s,minLng:o-e,maxLng:a+e,minLat:l-e,maxLat:c+e})}return t}function Or(r,t,e){if(e.length===0||!Lt(r,t,e[0]))return!1;for(let n=1;n<e.length;n++)if(Lt(r,t,e[n]))return!1;return!0}function se(r,t,e){for(const n of e)if(!(r<n.minLng||r>n.maxLng||t<n.minLat||t>n.maxLat)&&Or(r,t,n.rings))return!0;return!1}function oe(r,t,e,n,i,s){const o=i-e,a=s-n,l=o*o+a*a;let c=0;l>0&&(c=Math.max(0,Math.min(1,((r-e)*o+(t-n)*a)/l)));const f=e+c*o,h=n+c*a,u=111320,d=111320*Math.cos(t*Math.PI/180),x=(r-f)*d,g=(t-h)*u;return Math.sqrt(x*x+g*g)}function Nr(r,t,e){for(const n of e){if(r<n.minLng||r>n.maxLng||t<n.minLat||t>n.maxLat)continue;const i=n.feature,s=n.bufferMeters;if(i.type==="LineString"){const o=i.coordinates;for(let a=0;a<o.length-1;a++)if(oe(r,t,o[a][0],o[a][1],o[a+1][0],o[a+1][1])<s)return!0}else if(i.type==="MultiLineString"){const o=i.coordinates;for(const a of o)for(let l=0;l<a.length-1;l++)if(oe(r,t,a[l][0],a[l][1],a[l+1][0],a[l+1][1])<s)return!0}}return!1}async function $r(r){const{tileX:t,tileY:e,tileZ:n,landcoverConfig:i,maxProceduralTrees:s,maxOSMDensityTrees:o,basePMTilesUrl:a,buildingsPMTilesUrl:l,transportationPMTilesUrl:c,treeTilesUrl:f,elevationConfig:h,verticalExaggeration:u=1}=r;await Promise.all([Tr(a,l,c),Mr(f)]);const d=Fr(t,e,n),x=Pr(t,e,n),[g,m,F,v]=await Promise.all([Dr(t,e,n),Ir(t,e,n),Ur(t,e,n),Br(t,e,n)]),T=Rr(t,e,n,x,d,o),_=Hr(g,t,e,n,i,s);let b=[...T,..._];const B=b.length,A=ie(m),H=ie(F),D=zr(v);return b=b.filter(Q=>{const{lng:M,lat:Z}=Q;return!(A.length>0&&se(M,Z,A)||H.length>0&&se(M,Z,H)||D.length>0&&Nr(M,Z,D))}),h&&b.length>0&&await kr(b,h,u),{trees:b,stats:{osmTrees:T.length,proceduralTrees:_.length,filteredOut:B-b.length}}}self.onmessage=async r=>{const t=r.data;if(t.type==="CAPABILITY_CHECK"){const e={type:"CAPABILITY_CHECK_RESULT",id:t.id,supported:!0};self.postMessage(e);return}if(t.type==="PROCESS_TREES"){try{const e=await $r(t.payload),n={type:"PROCESS_TREES_RESULT",id:t.id,result:e};self.postMessage(n)}catch(e){const n={type:"ERROR",id:t.id,error:e.message};self.postMessage(n)}return}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=tree-processing.worker-CiRhUW6a.js.map
