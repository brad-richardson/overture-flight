(function(){"use strict";function ge(e,n,t=2){const r=n&&n.length,i=r?n[0]*t:e.length;let s=re(e,0,i,t,!0);const o=[];if(!s||s.next===s.prev)return o;let l,c,u;if(r&&(s=ve(e,n,s,t)),e.length>80*t){l=e[0],c=e[1];let a=l,p=c;for(let M=t;M<i;M+=t){const v=e[M],g=e[M+1];v<l&&(l=v),g<c&&(c=g),v>a&&(a=v),g>p&&(p=g)}u=Math.max(a-l,p-c),u=u!==0?32767/u:0}return Y(s,o,t,l,c,u,0),o}function re(e,n,t,r,i){let s;if(i===Re(e,n,t,r)>0)for(let o=n;o<t;o+=r)s=le(o/r|0,e[o],e[o+1],s);else for(let o=t-r;o>=n;o-=r)s=le(o/r|0,e[o],e[o+1],s);return s&&O(s,s.next)&&(j(s),s=s.next),s}function L(e,n){if(!e)return e;n||(n=e);let t=e,r;do if(r=!1,!t.steiner&&(O(t,t.next)||m(t.prev,t,t.next)===0)){if(j(t),t=n=t.prev,t===t.next)break;r=!0}else t=t.next;while(r||t!==n);return n}function Y(e,n,t,r,i,s,o){if(!e)return;!o&&s&&be(e,r,i,s);let l=e;for(;e.prev!==e.next;){const c=e.prev,u=e.next;if(s?de(e,r,i,s):pe(e)){n.push(c.i,e.i,u.i),j(e),e=u.next,l=u.next;continue}if(e=u,e===l){o?o===1?(e=ye(L(e),n),Y(e,n,t,r,i,s,2)):o===2&&me(e,n,t,r,i,s):Y(L(e),n,t,r,i,s,1);break}}}function pe(e){const n=e.prev,t=e,r=e.next;if(m(n,t,r)>=0)return!1;const i=n.x,s=t.x,o=r.x,l=n.y,c=t.y,u=r.y,a=Math.min(i,s,o),p=Math.min(l,c,u),M=Math.max(i,s,o),v=Math.max(l,c,u);let g=r.next;for(;g!==n;){if(g.x>=a&&g.x<=M&&g.y>=p&&g.y<=v&&H(i,l,s,c,o,u,g.x,g.y)&&m(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function de(e,n,t,r){const i=e.prev,s=e,o=e.next;if(m(i,s,o)>=0)return!1;const l=i.x,c=s.x,u=o.x,a=i.y,p=s.y,M=o.y,v=Math.min(l,c,u),g=Math.min(a,p,M),b=Math.max(l,c,u),w=Math.max(a,p,M),S=X(v,g,n,t,r),A=X(b,w,n,t,r);let x=e.prevZ,f=e.nextZ;for(;x&&x.z>=S&&f&&f.z<=A;){if(x.x>=v&&x.x<=b&&x.y>=g&&x.y<=w&&x!==i&&x!==o&&H(l,a,c,p,u,M,x.x,x.y)&&m(x.prev,x,x.next)>=0||(x=x.prevZ,f.x>=v&&f.x<=b&&f.y>=g&&f.y<=w&&f!==i&&f!==o&&H(l,a,c,p,u,M,f.x,f.y)&&m(f.prev,f,f.next)>=0))return!1;f=f.nextZ}for(;x&&x.z>=S;){if(x.x>=v&&x.x<=b&&x.y>=g&&x.y<=w&&x!==i&&x!==o&&H(l,a,c,p,u,M,x.x,x.y)&&m(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;f&&f.z<=A;){if(f.x>=v&&f.x<=b&&f.y>=g&&f.y<=w&&f!==i&&f!==o&&H(l,a,c,p,u,M,f.x,f.y)&&m(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function ye(e,n){let t=e;do{const r=t.prev,i=t.next.next;!O(r,i)&&oe(r,t,t.next,i)&&V(r,i)&&V(i,r)&&(n.push(r.i,t.i,i.i),j(t),j(t.next),t=e=i),t=t.next}while(t!==e);return L(t)}function me(e,n,t,r,i,s){let o=e;do{let l=o.next.next;for(;l!==o.prev;){if(o.i!==l.i&&Ce(o,l)){let c=se(o,l);o=L(o,o.next),c=L(c,c.next),Y(o,n,t,r,i,s,0),Y(c,n,t,r,i,s,0);return}l=l.next}o=o.next}while(o!==e)}function ve(e,n,t,r){const i=[];for(let s=0,o=n.length;s<o;s++){const l=n[s]*r,c=s<o-1?n[s+1]*r:e.length,u=re(e,l,c,r,!1);u===u.next&&(u.steiner=!0),i.push(Ze(u))}i.sort(we);for(let s=0;s<i.length;s++)t=Me(i[s],t);return t}function we(e,n){let t=e.x-n.x;if(t===0&&(t=e.y-n.y,t===0)){const r=(e.next.y-e.y)/(e.next.x-e.x),i=(n.next.y-n.y)/(n.next.x-n.x);t=r-i}return t}function Me(e,n){const t=_e(e,n);if(!t)return n;const r=se(t,e);return L(r,r.next),L(t,t.next)}function _e(e,n){let t=n;const r=e.x,i=e.y;let s=-1/0,o;if(O(e,t))return t;do{if(O(e,t.next))return t.next;if(i<=t.y&&i>=t.next.y&&t.next.y!==t.y){const p=t.x+(i-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(p<=r&&p>s&&(s=p,o=t.x<t.next.x?t:t.next,p===r))return o}t=t.next}while(t!==n);if(!o)return null;const l=o,c=o.x,u=o.y;let a=1/0;t=o;do{if(r>=t.x&&t.x>=c&&r!==t.x&&ie(i<u?r:s,i,c,u,i<u?s:r,i,t.x,t.y)){const p=Math.abs(i-t.y)/(r-t.x);V(t,e)&&(p<a||p===a&&(t.x>o.x||t.x===o.x&&ze(o,t)))&&(o=t,a=p)}t=t.next}while(t!==l);return o}function ze(e,n){return m(e.prev,e,n.prev)<0&&m(n.next,e,e.next)<0}function be(e,n,t,r){let i=e;do i.z===0&&(i.z=X(i.x,i.y,n,t,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,Ee(i)}function Ee(e){let n,t=1;do{let r=e,i;e=null;let s=null;for(n=0;r;){n++;let o=r,l=0;for(let u=0;u<t&&(l++,o=o.nextZ,!!o);u++);let c=t;for(;l>0||c>0&&o;)l!==0&&(c===0||!o||r.z<=o.z)?(i=r,r=r.nextZ,l--):(i=o,o=o.nextZ,c--),s?s.nextZ=i:e=i,i.prevZ=s,s=i;r=o}s.nextZ=null,t*=2}while(n>1);return e}function X(e,n,t,r,i){return e=(e-t)*i|0,n=(n-r)*i|0,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e|n<<1}function Ze(e){let n=e,t=e;do(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next;while(n!==e);return t}function ie(e,n,t,r,i,s,o,l){return(i-o)*(n-l)>=(e-o)*(s-l)&&(e-o)*(r-l)>=(t-o)*(n-l)&&(t-o)*(s-l)>=(i-o)*(r-l)}function H(e,n,t,r,i,s,o,l){return!(e===o&&n===l)&&ie(e,n,t,r,i,s,o,l)}function Ce(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!Ie(e,n)&&(V(e,n)&&V(n,e)&&Ae(e,n)&&(m(e.prev,e,n.prev)||m(e,n.prev,n))||O(e,n)&&m(e.prev,e,e.next)>0&&m(n.prev,n,n.next)>0)}function m(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function O(e,n){return e.x===n.x&&e.y===n.y}function oe(e,n,t,r){const i=W(m(e,n,t)),s=W(m(e,n,r)),o=W(m(t,r,e)),l=W(m(t,r,n));return!!(i!==s&&o!==l||i===0&&K(e,t,n)||s===0&&K(e,r,n)||o===0&&K(t,e,r)||l===0&&K(t,n,r))}function K(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function W(e){return e>0?1:e<0?-1:0}function Ie(e,n){let t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&oe(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}function V(e,n){return m(e.prev,e,e.next)<0?m(e,n,e.next)>=0&&m(e,e.prev,n)>=0:m(e,n,e.prev)<0||m(e,e.next,n)<0}function Ae(e,n){let t=e,r=!1;const i=(e.x+n.x)/2,s=(e.y+n.y)/2;do t.y>s!=t.next.y>s&&t.next.y!==t.y&&i<(t.next.x-t.x)*(s-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next;while(t!==e);return r}function se(e,n){const t=q(e.i,e.x,e.y),r=q(n.i,n.x,n.y),i=e.next,s=n.prev;return e.next=n,n.prev=e,t.next=i,i.prev=t,r.next=t,t.prev=r,s.next=r,r.prev=s,r}function le(e,n,t,r){const i=q(e,n,t);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function j(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function q(e,n,t){return{i:e,x:n,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Re(e,n,t,r){let i=0;for(let s=n,o=t-r;s<t;s+=r)i+=(e[o]-e[s])*(e[s+1]+e[o+1]),o=s;return i}const ce={residential:{walls:[15260872,13943976,12099714,13219990,15062464,11047024,9139029,13468991,12357519,16113331]},commercial:{walls:[7372944,7833753,11119017,12632256,13882323,5929610,5930366,8034986,9084076,10531e3]},industrial:{walls:[6908265,8421504,11119017,7372944,4871528,6052956,7041664,10265519,12892568,13943976]},civic:{walls:[13882323,12632256,15261904,15064272,15262940,13684952,14737632,12433259,13808780,12357519]},religious:{walls:[15789024,15261909,13808780,14596231,12357519,15262936,14210252,13943976,9127187,13468991]},education:{walls:[13468991,10506797,13789470,9127187,13808780,14596231,12632256,11119017,12357519,16032864]},medical:{walls:[16316664,15790320,15263976,14737632,16119285,15527148,14213344,13160660,12109e3,10531e3]},agricultural:{walls:[9127187,10506797,13468991,13789470,8077056,9132587,14596231,13808780,7048739,8421376]},entertainment:{walls:[4868682,3100495,4013404,4868698,5921370,3947580,3096399,1842204,12632256,7372944]},military:{walls:[5597999,7048739,8421376,9145088,6908265,4871528,6250335,10506797,9139029,8421504]},outbuilding:{walls:[9127187,10506797,6908265,8421504,13808780,14596231,7048739,9083546,11053224,7372944]},service:{walls:[7372944,8421504,11119017,9083560,11579568,13158600,4871528,7041664,14211288,14737632]},transportation:{walls:[7372944,7833753,11579568,13158600,5929610,5930366,8034986,9084076,14211288,14735568]},default:{walls:[8421504,9474192,10526880,11579568,8947865,10000536,11053224,12632256,7833753,7372944]}},ue={house:"residential",residential:"residential",detached:"residential",semi:"residential",semidetached_house:"residential",terrace:"residential",apartments:"residential",bungalow:"residential",dwelling_house:"residential",stilt_house:"residential",trullo:"residential",cabin:"residential",houseboat:"residential",static_caravan:"residential",ger:"residential",hut:"residential",beach_hut:"residential",allotment_house:"residential",dormitory:"residential",garage:"residential",garages:"residential",carport:"residential",boathouse:"residential",commercial:"commercial",office:"commercial",retail:"commercial",supermarket:"commercial",hotel:"commercial",kiosk:"commercial",parking:"commercial",industrial:"industrial",warehouse:"industrial",factory:"industrial",manufacture:"industrial",hangar:"industrial",storage_tank:"industrial",silo:"industrial",slurry_tank:"industrial",digester:"industrial",transformer_tower:"industrial",roof:"industrial",bridge_structure:"industrial",civic:"civic",public:"civic",government:"civic",fire_station:"civic",post_office:"civic",library:"civic",toilets:"civic",guardhouse:"civic",stadium:"civic",sports_centre:"civic",sports_hall:"civic",grandstand:"civic",pavilion:"civic",religious:"religious",church:"religious",chapel:"religious",cathedral:"religious",mosque:"religious",temple:"religious",synagogue:"religious",shrine:"religious",wayside_shrine:"religious",monastery:"religious",presbytery:"religious",school:"education",university:"education",college:"education",kindergarten:"education",hospital:"medical",agricultural:"agricultural",farm:"agricultural",barn:"agricultural",farm_auxiliary:"agricultural",cowshed:"agricultural",stable:"agricultural",sty:"agricultural",greenhouse:"agricultural",glasshouse:"agricultural",military:"military",bunker:"military",outbuilding:"outbuilding",shed:"outbuilding",service:"service",transportation:"transportation",train_station:"transportation"},Fe=new Set(["agricultural","civic","commercial","education","entertainment","industrial","medical","military","outbuilding","religious","residential","service","transportation"]);function Te(e){return function(){let n=e+=1831565813;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}function ke(e){const n=e.properties;if((n==null?void 0:n.id)!==void 0){let t=0;const r=String(n.id);for(let i=0;i<r.length;i++)t=(t<<5)-t+r.charCodeAt(i),t=t&t;return Math.abs(t)}if(e.coordinates){const t=e.type==="MultiPolygon"?e.coordinates[0][0][0]:e.coordinates[0][0];if(t&&t.length>=2)return Math.abs(Math.floor(t[0]*1e6+t[1]*1e3))}return 42}function Le(e){const n=e.properties;if(!n)return"default";const t=n.subtype;if(t){const i=String(t).toLowerCase();if(Fe.has(i))return i}const r=n.class;if(r){const i=String(r).toLowerCase();if(ue[i])return ue[i]}return"default"}function Se(e){const n=Le(e),t=ce[n]||ce.default,r=ke(e),i=Te(r),s=Math.floor(i()*t.walls.length);return t.walls[s]}const ae=1,$=2,Pe=.5,Be=.3,Oe=50;function fe(e,n,t,r){const i=(e-r.lng)*r.metersPerDegLng,s=-(n-r.lat)*r.metersPerDegLat;return{x:i,y:t,z:s}}function ee(e){let n=0;for(let t=0,r=e.length-1;t<e.length;r=t++)n+=(e[r].x+e[t].x)*(e[r].z-e[t].z);return n/2}function te(e,n){if(e.length<=4)return e;const t=[e[0]];let r=e[0];for(let i=1;i<e.length-1;i++){const s=e[i],o=s.x-r.x,l=s.z-r.z;Math.sqrt(o*o+l*l)>=n&&(t.push(s),r=s)}return e.length>1&&t.push(e[e.length-1]),t.length<3?e.length>=3?e.slice(0,3):e.slice():t}function De(e,n){return typeof e.height=="number"&&e.height>0?e.height:typeof e.num_floors=="number"&&e.num_floors>0?e.num_floors*3:n}function Ue(e){return Se({type:e.type,coordinates:e.coordinates,properties:e.properties})}function Ge(e,n,t,r,i,s,o,l,c){if(!e||e.length===0)return null;const u=e[0];if(!u||u.length<3)return null;let a=[];for(const h of u){const d=fe(h[0],h[1],0,c);a.push({x:d.x,z:-d.z})}if(a.length>1){const h=a[0],d=a[a.length-1];Math.abs(h.x-d.x)<.01&&Math.abs(h.z-d.z)<.01&&a.pop()}if(a.length<3)return null;const p=ee(a);if(Math.abs(p)<1||i===$&&Math.abs(p)<Oe||(i===ae?a=te(a,2):i===$&&(a=te(a,5)),a.length<3))return null;const M=ee(a);if(Math.abs(M)<1)return null;M>0&&a.reverse();const v=s*l+Pe-o*Be,g=v+n,b=v+t,w=[];for(const h of a)w.push(h.x,h.z);const S=[],A=[];if(i!==$&&e.length>1)for(let h=1;h<e.length;h++){const d=e[h];if(!d||d.length<3)continue;S.push(w.length/2);let y=[];for(const z of d){const C=fe(z[0],z[1],0,c);y.push({x:C.x,z:-C.z})}if(y.length>1){const z=y[0],C=y[y.length-1];Math.abs(z.x-C.x)<.01&&Math.abs(z.z-C.z)<.01&&y.pop()}i===ae&&y.length>4&&(y=te(y,2)),ee(y)<0&&y.reverse(),A.push(y.length);for(const z of y)w.push(z.x,z.z)}const x=ge(w,S,2);if(x.length===0)return null;const f=w.length/2,R=[];for(let h=0;h<f;h++)R.push({x:w[h*2],z:w[h*2+1]});const _=[],P=[],B=[],E=[],Z=(r>>16&255)/255,J=(r>>8&255)/255,Q=(r&255)/255,He=_.length/3;for(const h of R)_.push(h.x,g,h.z),P.push(0,1,0),B.push(Z,J,Q);for(const h of x)E.push(He+h);if(t>0){const h=_.length/3;for(const d of R)_.push(d.x,b,d.z),P.push(0,-1,0),B.push(Z*.7,J*.7,Q*.7);for(let d=x.length-1;d>=0;d--)E.push(h+x[d])}const ne=a.length,D=.85;for(let h=0;h<ne;h++){const d=a[h],y=a[(h+1)%ne],F=y.x-d.x,z=y.z-d.z,C=Math.sqrt(F*F+z*z);if(C<.01)continue;const T=-z/C,k=F/C,I=_.length/3,U=t>0?b:v;_.push(d.x,U,d.z),_.push(y.x,U,y.z),_.push(y.x,g,y.z),_.push(d.x,g,d.z);for(let G=0;G<4;G++)P.push(T,0,k),B.push(Z*D,J*D,Q*D);E.push(I+0,I+3,I+2),E.push(I+0,I+2,I+1)}if(i!==$&&A.length>0){let h=ne;for(let d=0;d<A.length;d++){const y=A[d];for(let F=0;F<y;F++){const z=h+F,C=h+(F+1)%y;if(z>=R.length||C>=R.length)break;const T=R[z],k=R[C],I=k.x-T.x,U=k.z-T.z,G=Math.sqrt(I*I+U*U);if(G<.01)continue;const Ve=U/G,je=-I/G,N=_.length/3,xe=t>0?b:v;_.push(T.x,xe,T.z),_.push(k.x,xe,k.z),_.push(k.x,g,k.z),_.push(T.x,g,T.z);for(let he=0;he<4;he++)P.push(Ve,0,je),B.push(Z*D,J*D,Q*D);E.push(N+0,N+3,N+2),E.push(N+0,N+2,N+1)}h+=y}}return{positions:_,normals:P,colors:B,indices:E}}function Ne(e){const{features:n,origin:t,lodLevel:r,defaultHeight:i,terrainHeights:s,verticalExaggeration:o}=e,l=[],c=[],u=[],a=[];let p=0,M=0,v=0;for(let b=0;b<n.length;b++){const w=n[b];if(w.properties.is_underground){v++;continue}const S=De(w.properties,i),A=typeof w.properties.min_height=="number"?w.properties.min_height:0,x=Ue(w),f=s==null?void 0:s[b],R=f?f[0]:0,_=f?f[1]-f[0]:0,P=w.type==="Polygon"?[w.coordinates]:w.coordinates;for(const B of P)try{const E=Ge(B,S,A,x,r,R,_,o,t);if(E){for(const Z of E.positions)l.push(Z);for(const Z of E.normals)c.push(Z);for(const Z of E.colors)u.push(Z);for(const Z of E.indices)a.push(Z+p);p+=E.positions.length/3,M++}else v++}catch{v++}}return l.length===0?{geometry:null,stats:{buildingsProcessed:0,buildingsSkipped:v,totalVertices:0,totalTriangles:0}}:{geometry:{positions:new Float32Array(l),normals:new Float32Array(c),colors:new Float32Array(u),indices:new Uint32Array(a)},stats:{buildingsProcessed:M,buildingsSkipped:v,totalVertices:l.length/3,totalTriangles:a.length/3}}}function Ye(e){return e.geometry?[e.geometry.positions.buffer,e.geometry.normals.buffer,e.geometry.colors.buffer,e.geometry.indices.buffer]:[]}self.onmessage=e=>{const n=e.data;try{switch(n.type){case"CAPABILITY_CHECK":{const t={type:"CAPABILITY_CHECK_RESULT",id:n.id,supported:!0};self.postMessage(t);break}case"CREATE_BUILDING_GEOMETRY":{const t=n.payload,r=Ne(t),i=Ye(r),s={type:"CREATE_BUILDING_GEOMETRY_RESULT",id:n.id,result:r};self.postMessage(s,{transfer:i});break}default:{const t={type:"ERROR",id:n.id||"unknown",error:`Building geometry worker received unsupported request type: ${n.type}`};self.postMessage(t)}}}catch(t){const r={type:"ERROR",id:n.id,error:t instanceof Error?t.message:"Unknown error in building geometry worker"};self.postMessage(r)}},self.postMessage({type:"READY"})})();
//# sourceMappingURL=building-geometry.worker-CfR3fa4c.js.map
